<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç³»çµ±ç™»å…¥ - æ™ºæ…§æ ¡å‹™è¡Œæ”¿ç®¡ç†</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        /* è‡ªè¨‚å‹•ç•«è¨­å®š */
        .glass-card {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 via-blue-100 to-indigo-100 flex items-center justify-center min-h-screen font-sans p-4">
    
    <div class="glass-card p-8 md:p-10 rounded-3xl shadow-xl w-full max-w-md border border-white">
        
        <div class="text-center mb-8">
            <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-blue-100 text-blue-600 mb-4 shadow-inner">
                <i class="fas fa-graduation-cap text-3xl"></i>
            </div>
            <h1 class="text-3xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-blue-600 to-indigo-600 mb-2">
                æ ¡å‹™è¡Œæ”¿ç®¡ç†ç³»çµ±
            </h1>
            <p class="text-gray-500 font-medium">æ­¡è¿å›ä¾†ï¼Œè«‹é¸æ“‡èº«åˆ†ä¸¦ç™»å…¥</p>
        </div>

        <div class="flex mb-8 bg-gray-100 p-1.5 rounded-2xl shadow-inner relative">
            <button id="tab-teacher" onclick="setRole('teacher')" class="flex-1 py-2 text-center rounded-xl bg-white shadow text-blue-600 font-bold transition-all duration-200">è€å¸«</button>
            <button id="tab-cadre" onclick="setRole('cadre')" class="flex-1 py-2 text-center rounded-xl text-gray-500 hover:text-gray-800 font-semibold transition-all duration-200">å¹¹éƒ¨</button>
            <button id="tab-parent" onclick="setRole('parent')" class="flex-1 py-2 text-center rounded-xl text-gray-500 hover:text-gray-800 font-semibold transition-all duration-200">å®¶é•·</button>
            <button id="tab-student" onclick="setRole('student')" class="flex-1 py-2 text-center rounded-xl text-gray-500 hover:text-gray-800 font-semibold transition-all duration-200">å­¸ç”Ÿ</button>
        </div>

        <form id="loginForm" onsubmit="handleLogin(event)">
            <input type="hidden" id="role" value="teacher">
            
            <div class="mb-5">
                <label class="block text-gray-700 text-sm font-bold mb-2 ml-1">å¸³è™Ÿ</label>
                <div class="relative">
                    <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                        <i class="fas fa-user text-gray-400"></i>
                    </div>
                    <input type="text" id="username" class="w-full pl-11 pr-4 py-3 bg-gray-50 border border-gray-200 rounded-xl focus:bg-white focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all outline-none" placeholder="è«‹è¼¸å…¥å¸³è™Ÿ" required>
                </div>
            </div>
            
            <div class="mb-6">
                <label class="block text-gray-700 text-sm font-bold mb-2 ml-1">å¯†ç¢¼</label>
                <div class="relative">
                    <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                        <i class="fas fa-lock text-gray-400"></i>
                    </div>
                    <input type="password" id="password" class="w-full pl-11 pr-12 py-3 bg-gray-50 border border-gray-200 rounded-xl focus:bg-white focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all outline-none" placeholder="è«‹è¼¸å…¥å¯†ç¢¼" required>
                    <button type="button" onclick="togglePassword()" class="absolute inset-y-0 right-0 pr-4 flex items-center text-gray-400 hover:text-blue-500 transition-colors">
                        <i id="eye-icon" class="fas fa-eye"></i>
                    </button>
                </div>
            </div>

            <div id="error-message" class="hidden mb-6 p-3 bg-red-50 border-l-4 border-red-500 text-red-700 rounded-r-lg text-sm font-medium flex items-center">
                <i class="fas fa-exclamation-circle mr-2 text-lg"></i>
                <span id="error-text">éŒ¯èª¤è¨Šæ¯</span>
            </div>

            <button type="submit" id="submit-btn" class="w-full bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 text-white font-bold py-3.5 px-4 rounded-xl shadow-md hover:shadow-lg transform hover:-translate-y-0.5 transition-all duration-200 text-lg flex justify-center items-center">
                ç™»å…¥ç³»çµ± <i class="fas fa-arrow-right ml-2 opacity-80"></i>
            </button>
        </form>

        <div class="mt-8 text-center text-xs text-gray-400">
            <p>&copy; 2024 æ™ºæ…§æ ¡å‹™ç³»çµ±. All rights reserved.</p>
        </div>
    </div>

    <script>
        // ==========================================
        // ğŸš¨ é€™è£¡è«‹è²¼ä¸Šæ‚¨æœ€æ–°çš„ API ç¶²å€
        // ==========================================
        const API_URL = "https://script.google.com/macros/s/AKfycbwunBwJT2u3gpAcnibQW4RBOQhuzQXLtcirT4_6G6fG9FgwJjTAApax5fU0VZ1dNvdRog/exec";

        function setRole(role) {
            document.getElementById('role').value = role;
            const roles = ['teacher', 'cadre', 'parent', 'student'];
            
            roles.forEach(r => {
                let tab = document.getElementById('tab-' + r);
                if (r === role) {
                    tab.className = "flex-1 py-2 text-center rounded-xl bg-white shadow text-blue-600 font-bold transition-all duration-200 transform scale-105";
                } else {
                    tab.className = "flex-1 py-2 text-center rounded-xl text-gray-500 hover:text-gray-800 font-semibold transition-all duration-200 hover:bg-gray-200/50";
                }
            });
        }

        function togglePassword() {
            const pwdInput = document.getElementById('password'), eyeIcon = document.getElementById('eye-icon');
            pwdInput.type = pwdInput.type === 'password' ? 'text' : 'password';
            eyeIcon.className = pwdInput.type === 'password' ? 'fas fa-eye' : 'fas fa-eye-slash';
        }

        function showError(msg) {
            const errorContainer = document.getElementById('error-message');
            const errorText = document.getElementById('error-text');
            errorText.innerText = msg;
            errorContainer.classList.remove('hidden');
        }

        function hideError() {
            document.getElementById('error-message').classList.add('hidden');
        }

        async function handleLogin(event) {
            event.preventDefault();
            const role = document.getElementById('role').value;
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const submitBtn = document.getElementById('submit-btn');

            hideError(); 
            submitBtn.innerHTML = '<i class="fas fa-circle-notch fa-spin mr-2"></i> ç™»å…¥é©—è­‰ä¸­...'; 
            submitBtn.disabled = true;
            submitBtn.classList.add('opacity-80', 'cursor-not-allowed');

            try {
                const response = await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'login', username, password }) });
                const result = await response.json();
                
                if (result.success) {
                    if (result.role !== role) {
                        showError("ç™»å…¥å¤±æ•—ï¼šæ‚¨é¸æ“‡çš„èº«åˆ†èˆ‡ç³»çµ±ç´€éŒ„ä¸ç¬¦ã€‚");
                    } else {
                        // ç™»å…¥æˆåŠŸï¼Œå„²å­˜ Session
                        sessionStorage.setItem('isLoggedIn', 'true'); 
                        sessionStorage.setItem('userRole', result.role); 
                        sessionStorage.setItem('username', username);
                        
                        if ((result.role === 'parent' || result.role === 'student') && result.studentId) {
                            sessionStorage.setItem('studentId', result.studentId);
                            if(result.studentName) sessionStorage.setItem('studentName', result.studentName);
                            if(result.studentClass) sessionStorage.setItem('studentClass', result.studentClass);
                        }
                        
                        if (result.role === 'teacher' || result.role === 'cadre') {
                            sessionStorage.setItem('assignedClasses', JSON.stringify(result.classes || [])); 
                            sessionStorage.setItem('teacherClasses', JSON.stringify(result.classes || []));  
                            sessionStorage.setItem('teacherSubjects', JSON.stringify(result.subjects || []));
                        }

                        // ç™»å…¥æˆåŠŸå‹•ç•«
                        submitBtn.innerHTML = '<i class="fas fa-check-circle mr-2"></i> ç™»å…¥æˆåŠŸ';
                        submitBtn.classList.replace('from-blue-600', 'from-green-500');
                        submitBtn.classList.replace('to-indigo-600', 'to-green-600');

                        // å»¶é²è·³è½‰ä»¥é¡¯ç¤ºæˆåŠŸå‹•ç•«
                        setTimeout(() => {
                            if (role === 'teacher') window.location.href = 'teacher.html'; 
                            else if (role === 'cadre') window.location.href = 'cadre.html'; 
                            else if (role === 'student') window.location.href = 'student.html'; 
                            else window.location.href = 'parent.html';
                        }, 500);
                        return; // æå‰çµæŸé¿å… finally é‡ç½®æŒ‰éˆ•
                    }
                } else { 
                    showError(result.message || "å¸³è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤ã€‚"); 
                }
            } catch (error) { 
                showError("ç³»çµ±é€£ç·šç•°å¸¸ï¼Œè«‹æª¢æŸ¥ç¶²è·¯ç‹€æ…‹ã€‚"); 
            } finally { 
                submitBtn.innerHTML = 'ç™»å…¥ç³»çµ± <i class="fas fa-arrow-right ml-2 opacity-80"></i>'; 
                submitBtn.disabled = false; 
                submitBtn.classList.remove('opacity-80', 'cursor-not-allowed');
            }
        }
    </script>
</body>
</html>
