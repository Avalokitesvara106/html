// ==========================================
// ğŸš¨ è«‹å¡«å…¥æ‚¨æœ€æ–°çš„ Google è©¦ç®—è¡¨ ID
// ==========================================
const SHEET_ID = '1X0ni5pa7vixetF9tpCk_Fi2LCv5pKbmh16ZFi3ysS4s';

function getSafeDateString(val, tz) {
  if (!val) return "";
  if (val instanceof Date) { return Utilities.formatDate(val, tz, 'yyyy-MM-dd'); }
  return val.toString().trim().replace(/\//g, '-').substring(0, 10);
}

function doPost(e) {
  try {
    const params = JSON.parse(e.postData.contents);
    const action = params.action;
    let result = {};

    if (action === 'login') {
      result = handleLogin(params.username, params.password);
    } else if (action === 'getDailyReport') {
      result = getDailyReport(params.studentId, params.date);
    } else if (action === 'getWeeklyReport') {  // ğŸŸ¢ æ–°å¢ï¼šç²å–ä¸€é€±çœŸå¯¦æˆç¸¾è¶¨å‹¢
      result = getWeeklyReport(params.studentId, params.date);
    } else if (action === 'loadAttendance') { 
      result = loadAttendance(params.date, params.className, params.subject);
    } else if (action === 'loadScores') { 
      result = loadScores(params.date, params.className, params.subject, params.examName);
    } else if (action === 'loadSubmissions') { 
      result = loadSubmissions(params.date, params.className, params.itemName);
    } else if (action === 'batchSaveAttendance') {  
      result = batchSaveAttendance(params.records);
    } else if (action === 'batchSaveScores') {  
      result = batchSaveScores(params.records);
    } else if (action === 'batchSaveSubmissions') { 
      result = batchSaveSubmissions(params.records);
    } else if (action === 'getSubmissionItems') { 
      result = getSubmissionItems(params.date, params.className);
    } else if (action === 'getExamNames') { 
      result = getExamNames(params.date, params.className, params.subject);
    } else {
      result = { success: false, message: 'æœªçŸ¥çš„è«‹æ±‚å‹•ä½œ' };
    }

    return ContentService.createTextOutput(JSON.stringify(result)).setMimeType(ContentService.MimeType.JSON);
  } catch (error) {
    return ContentService.createTextOutput(JSON.stringify({ success: false, error: error.message })).setMimeType(ContentService.MimeType.JSON);
  }
}

// 1. ç™»å…¥é©—è­‰
function handleLogin(username, password) {
  const sheet = SpreadsheetApp.openById(SHEET_ID).getSheetByName('Users');
  if (!sheet) return { success: false, message: 'æ‰¾ä¸åˆ° Users å·¥ä½œè¡¨' };
  const data = sheet.getDataRange().getValues();
  for (let i = 1; i < data.length; i++) {
    if (data[i][0].toString().trim() === username.trim() && data[i][1].toString().trim() === password.trim()) {
      let rawRole = data[i][2].toString().trim().toLowerCase();
      let role = 'teacher'; 
      if (rawRole === 'parent' || rawRole === 'å®¶é•·') role = 'parent';
      else if (rawRole === 'cadre' || rawRole === 'å¹¹éƒ¨' || rawRole === 'ç­ç´šå¹¹éƒ¨') role = 'cadre';
      else if (rawRole === 'teacher' || rawRole === 'è€å¸«') role = 'teacher';

      let response = { success: true, role: role, studentId: data[i][3] };
      if (role === 'teacher' || role === 'cadre') {
        response.classes = data[i][4] ? data[i][4].toString().split(',').map(s => s.trim()) : [];
        response.subjects = data[i][5] ? data[i][5].toString().split(',').map(s => s.trim()) : [];
      }
      return response;
    }
  }
  return { success: false, message: 'å¸³è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤' };
}

// 2. å®¶é•·ï¼šç²å–æ¯æ—¥å ±è¡¨
function getDailyReport(studentId, targetDate) {
  const ss = SpreadsheetApp.openById(SHEET_ID);
  const attSheet = ss.getSheetByName('Attendance_Records');
  const scoreSheet = ss.getSheetByName('Score_Records');
  const subSheet = ss.getSheetByName('Submission_Records'); 
  const tz = ss.getSpreadsheetTimeZone(); 

  let attendanceRecords = [], scoreRecords = [], submissionRecords = [];

  if (attSheet) {
    const attData = attSheet.getDataRange().getValues();
    for (let i = 1; i < attData.length; i++) {
      if (attData[i][3].toString().trim() === studentId.toString().trim() && getSafeDateString(attData[i][0], tz) === targetDate.trim()) {
        attendanceRecords.push({ course: attData[i][2].toString().trim(), attendance: attData[i][5].toString().trim(), comment: attData[i][6].toString().trim() });
      }
    }
  }
  if (scoreSheet) {
    const scoreData = scoreSheet.getDataRange().getValues();
    for (let i = 1; i < scoreData.length; i++) {
      if (scoreData[i][4].toString().trim() === studentId.toString().trim() && getSafeDateString(scoreData[i][0], tz) === targetDate.trim()) {
        scoreRecords.push({ course: scoreData[i][2].toString().trim(), examName: scoreData[i][3].toString().trim(), score: scoreData[i][6] !== "" ? scoreData[i][6] : "--" });
      }
    }
  }
  if (subSheet) {
    const subData = subSheet.getDataRange().getValues();
    for (let i = 1; i < subData.length; i++) {
      let recDateStr = getSafeDateString(subData[i][0], tz);
      let recStuId = subData[i][3].toString().trim(); 
      if (recStuId === studentId.toString().trim() && recDateStr === targetDate.trim()) {
        submissionRecords.push({ itemName: subData[i][2].toString().trim(), status: subData[i][5].toString().trim() });
      }
    }
  }
  return { success: true, attendance: attendanceRecords, scores: scoreRecords, submissions: submissionRecords };
}

// ğŸŸ¢ 2.5 å®¶é•·ï¼šç²å–ä¸€é€±çœŸå¯¦æˆç¸¾åœ–è¡¨è³‡æ–™ (æ¨ç®—éå»5å¤©)
function getWeeklyReport(studentId, targetDateStr) {
  const ss = SpreadsheetApp.openById(SHEET_ID);
  const scoreSheet = ss.getSheetByName('Score_Records');
  const tz = ss.getSpreadsheetTimeZone();
  
  let targetDate = new Date(targetDateStr);
  let labels = [], chartData = [], dateStrs = [];
  
  // å»ºç«‹éå»5å¤©çš„æ—¥æœŸé™£åˆ—
  for (let i = 4; i >= 0; i--) {
    let d = new Date(targetDate.getTime());
    d.setDate(d.getDate() - i);
    dateStrs.push(Utilities.formatDate(d, tz, 'yyyy-MM-dd'));
    labels.push(Utilities.formatDate(d, tz, 'MM/dd'));
    chartData.push(null);
  }

  if (scoreSheet) {
    const data = scoreSheet.getDataRange().getValues();
    let dailySums = {0:0, 1:0, 2:0, 3:0, 4:0};
    let dailyCounts = {0:0, 1:0, 2:0, 3:0, 4:0};
    
    for (let r = 1; r < data.length; r++) {
      let recDateStr = getSafeDateString(data[r][0], tz);
      let recStuId = data[r][4].toString().trim();
      
      if (recStuId === studentId.toString().trim()) {
        let idx = dateStrs.indexOf(recDateStr);
        if (idx !== -1) {
          let score = parseFloat(data[r][6]);
          if (!isNaN(score)) {
            dailySums[idx] += score;
            dailyCounts[idx] += 1;
          }
        }
      }
    }
    // è¨ˆç®—æ¯æ—¥å¹³å‡åˆ†æ•¸
    for (let i = 0; i < 5; i++) {
      if (dailyCounts[i] > 0) chartData[i] = Math.round(dailySums[i] / dailyCounts[i]);
    }
  }
  return { success: true, labels: labels, data: chartData };
}

// ==========================================
// ğŸ“¥ è¼‰å…¥èˆ‡ ğŸ“¤ å„²å­˜ å‡½å¼ç¾¤
// ==========================================
function loadAttendance(tDate, tClass, tSubj) { return _loadData(tDate, tClass, tSubj, null, 'Attendance_Records'); }
function loadScores(tDate, tClass, tSubj, exam) { return _loadData(tDate, tClass, tSubj, exam, 'Score_Records'); }
function loadSubmissions(targetDate, targetClass, itemName) { return _loadData(targetDate, targetClass, null, itemName, 'Submission_Records'); }

function batchSaveAttendance(recs) { return _batchSave(recs, 'Attendance_Records'); }
function batchSaveScores(recs) { return _batchSave(recs, 'Score_Records'); }
function batchSaveSubmissions(records) { return _batchSave(records, 'Submission_Records'); }

function getSubmissionItems(targetDate, targetClass) {
  const ss = SpreadsheetApp.openById(SHEET_ID);
  const sheet = ss.getSheetByName('Submission_Records');
  if (!sheet) return { success: true, items: [] };
  const data = sheet.getDataRange().getValues(), tz = ss.getSpreadsheetTimeZone();
  let items = new Set();
  for (let i = 1; i < data.length; i++) {
    if (getSafeDateString(data[i][0], tz) === targetDate && data[i][1].toString().trim() === targetClass && data[i][2].toString().trim() !== "") {
      items.add(data[i][2].toString().trim());
    }
  }
  return { success: true, items: Array.from(items) };
}

function getExamNames(targetDate, targetClass, targetSubject) {
  const ss = SpreadsheetApp.openById(SHEET_ID);
  const sheet = ss.getSheetByName('Score_Records');
  if (!sheet) return { success: true, exams: [] };
  const data = sheet.getDataRange().getValues(), tz = ss.getSpreadsheetTimeZone();
  let exams = new Set();
  for (let i = 1; i < data.length; i++) {
    if (getSafeDateString(data[i][0], tz) === targetDate && data[i][1].toString().trim() === targetClass && data[i][2].toString().trim() === targetSubject && data[i][3].toString().trim() !== "") {
      exams.add(data[i][3].toString().trim());
    }
  }
  return { success: true, exams: Array.from(exams) };
}

function _loadData(targetDate, targetClass, targetSubject, extraParam, sheetName) {
  const ss = SpreadsheetApp.openById(SHEET_ID);
  const studentSheet = ss.getSheetByName('Students');
  const recordSheet = ss.getSheetByName(sheetName);
  if (!studentSheet || !recordSheet) return { success: false, message: 'æ‰¾ä¸åˆ°å·¥ä½œè¡¨: ' + sheetName };
  
  const studentsData = studentSheet.getDataRange().getValues();
  const recordsData = recordSheet.getDataRange().getValues();
  const tz = ss.getSpreadsheetTimeZone(); 
  let resultData = [];

  for (let i = 1; i < studentsData.length; i++) {
    if (!studentsData[i][0]) continue; 
    let stuId = studentsData[i][0].toString().trim();
    let stuName = studentsData[i][1].toString().trim();
    let stuClass = studentsData[i][2] ? studentsData[i][2].toString().trim() : "";
    if (stuClass !== targetClass.trim()) continue; 
    
    let existingRecord = null;
    for (let j = 1; j < recordsData.length; j++) {
      let recDateStr = getSafeDateString(recordsData[j][0], tz);
      let recClass = recordsData[j][1].toString().trim();
      let recStuId = recordsData[j][sheetName === 'Score_Records' ? 4 : 3].toString().trim();
      let isMatch = (recDateStr === targetDate.trim() && recClass === targetClass.trim() && recStuId === stuId);
      
      if (isMatch) {
          if (sheetName === 'Attendance_Records' && recordsData[j][2].toString().trim() === targetSubject.trim()) { existingRecord = { attendance: recordsData[j][5].toString().trim(), comment: recordsData[j][6].toString().trim() }; break; } 
          else if (sheetName === 'Score_Records' && recordsData[j][2].toString().trim() === targetSubject.trim() && recordsData[j][3].toString().trim() === extraParam.trim()) { existingRecord = { score: recordsData[j][6] !== "" ? recordsData[j][6] : "" }; break; } 
          else if (sheetName === 'Submission_Records' && recordsData[j][2].toString().trim() === extraParam.trim()) { existingRecord = { status: recordsData[j][5].toString().trim() }; break; }
      }
    }

    if (sheetName === 'Attendance_Records') resultData.push(existingRecord ? { studentId: stuId, name: stuName, attendance: existingRecord.attendance, comment: existingRecord.comment, isSaved: true } : { studentId: stuId, name: stuName, attendance: 'present', comment: '', isSaved: false });
    else if (sheetName === 'Score_Records') resultData.push(existingRecord ? { studentId: stuId, name: stuName, score: existingRecord.score, isSaved: true } : { studentId: stuId, name: stuName, score: '', isSaved: false });
    else if (sheetName === 'Submission_Records') resultData.push(existingRecord ? { studentId: stuId, name: stuName, status: existingRecord.status, isSaved: true } : { studentId: stuId, name: stuName, status: 'pending', isSaved: false });
  }
  return { success: true, data: resultData };
}

function _batchSave(records, sheetName) {
  const ss = SpreadsheetApp.openById(SHEET_ID);
  const sheet = ss.getSheetByName(sheetName);
  let data = sheet.getDataRange().getValues(); 
  const tz = ss.getSpreadsheetTimeZone();

  for (let r = 0; r < records.length; r++) {
    let rec = records[r];
    let rowIndex = -1;

    for (let i = 1; i < data.length; i++) {
      let recDateStr = getSafeDateString(data[i][0], tz);
      let recClass = data[i][1].toString().trim();
      let recStuId = data[i][sheetName === 'Score_Records' ? 4 : 3].toString().trim();
      let isMatch = (recDateStr === rec.date && recClass === rec.className && recStuId === rec.studentId.toString());
      
      if (isMatch) {
          if (sheetName === 'Attendance_Records' && data[i][2].toString().trim() === rec.subject) { rowIndex = i + 1; break; }
          else if (sheetName === 'Score_Records' && data[i][2].toString().trim() === rec.subject && data[i][3].toString().trim() === rec.examName) { rowIndex = i + 1; break; }
          else if (sheetName === 'Submission_Records' && data[i][2].toString().trim() === rec.itemName) { rowIndex = i + 1; break; }
      }
    }

    if (rowIndex > -1) {
        if (sheetName === 'Attendance_Records') { sheet.getRange(rowIndex, 6).setValue(rec.attendance); sheet.getRange(rowIndex, 7).setValue(rec.comment); data[rowIndex - 1][5] = rec.attendance; data[rowIndex - 1][6] = rec.comment; } 
        else if (sheetName === 'Score_Records') { sheet.getRange(rowIndex, 7).setValue(rec.score); data[rowIndex - 1][6] = rec.score; } 
        else if (sheetName === 'Submission_Records') { sheet.getRange(rowIndex, 6).setValue(rec.status); data[rowIndex - 1][5] = rec.status; }
    } else {
        let newRow, idStamp = new Date().getTime() + "-" + r;
        if (sheetName === 'Attendance_Records') newRow = [rec.date, rec.className, rec.subject, rec.studentId, rec.name, rec.attendance, rec.comment, "ATT-" + idStamp];
        else if (sheetName === 'Score_Records') newRow = [rec.date, rec.className, rec.subject, rec.examName, rec.studentId, rec.name, rec.score, "SCO-" + idStamp];
        else if (sheetName === 'Submission_Records') newRow = [rec.date, rec.className, rec.itemName, rec.studentId, rec.name, rec.status, "SUB-" + idStamp];
        
        sheet.appendRow(newRow); data.push(newRow);
    }
  }
  return { success: true, message: 'å„²å­˜æˆåŠŸ' };
}
