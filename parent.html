<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®¶é•·å ±è¡¨ä¸­å¿ƒ - å­¸ç¿’ç‹€æ³ç¸½è¦½</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gray-100 font-sans pb-10">

    <header class="bg-blue-600 text-white shadow-md rounded-b-3xl pb-6">
        <div class="p-4 flex justify-between items-center">
            <h1 class="text-lg font-bold">å®¶é•·å ±è¡¨ä¸­å¿ƒ</h1>
            <button onclick="logout()" class="text-blue-100 hover:text-white text-sm">
                <i class="fas fa-sign-out-alt"></i> ç™»å‡º
            </button>
        </div>
        <div class="px-6 flex items-center mt-2">
            <div class="w-16 h-16 bg-white rounded-full flex items-center justify-center text-blue-600 text-2xl font-bold border-4 border-blue-300 shadow-sm">
                <i class="fas fa-user-graduate"></i>
            </div>
            <div class="ml-4">
                <p class="text-blue-100 text-sm">å®¶é•·æ‚¨å¥½ï¼Œæ‚¨ç¶å®šçš„å­¸è™Ÿç‚º</p>
                <h2 class="text-2xl font-bold" id="display-student-id">è¼‰å…¥ä¸­...</h2>
            </div>
        </div>
    </header>

    <div class="max-w-md mx-auto px-4 mt-6">
        <div class="flex bg-gray-200 rounded-lg p-1">
            <button id="btn-daily" onclick="switchTab('daily')" class="flex-1 py-2 text-center rounded-md bg-white shadow text-blue-600 font-bold text-sm transition-all">
                æ¯æ—¥è¦–è§’
            </button>
            <button id="btn-weekly" onclick="switchTab('weekly')" class="flex-1 py-2 text-center rounded-md text-gray-500 hover:text-gray-700 font-bold text-sm transition-all">
                æ¯é€±ç¸½çµ
            </button>
        </div>
    </div>

    <main class="max-w-md mx-auto mt-4 px-4">
        
        <section id="view-daily" class="block">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-bold text-gray-700">é¸æ“‡æŸ¥è©¢æ—¥æœŸ</h3>
                <input type="date" id="daily-date" class="bg-white border border-gray-300 text-gray-700 text-sm rounded-lg p-2 focus:ring-2 focus:ring-blue-500">
            </div>

            <div id="daily-content-container">
                <div id="loading-msg" class="text-center text-blue-500 py-8 hidden">
                    <i class="fas fa-spinner fa-spin mr-2 text-2xl"></i><p class="mt-2">è³‡æ–™è¼‰å…¥ä¸­...</p>
                </div>
                
                <div id="submission-section" class="mb-6"></div>

                <div id="attendance-section" class="mb-6"></div>

                <div id="score-section" class="mb-6"></div>
                
                <div id="no-data-msg" class="hidden bg-gray-50 rounded-xl border border-gray-200 p-8 text-center text-gray-500 mt-4">
                    <i class="fas fa-box-open text-3xl mb-2 text-gray-300"></i>
                    <p>æœ¬æ—¥ç„¡å„é …ç´€éŒ„</p>
                </div>
            </div>
        </section>

        <section id="view-weekly" class="hidden">
            <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-4 mb-4 mt-2">
                <p class="text-sm font-bold text-gray-700 mb-4"><i class="fas fa-chart-line text-blue-500 mr-2"></i>è¿‘æœŸå­¸ç¿’è¡¨ç¾</p>
                <canvas id="gradeChart" width="400" height="250"></canvas>
            </div>
            <div class="bg-blue-50 rounded-xl border border-blue-100 p-4 text-sm text-blue-800">
                <p><i class="fas fa-info-circle mr-2"></i> ä¸Šåœ–ç‚ºå­¸ç”Ÿè¿‘æœŸç¶œåˆè¡¨ç¾è¶¨å‹¢åœ–ï¼Œä¾›å®¶é•·åƒè€ƒå­¸ç¿’æ³¢å‹•ã€‚</p>
            </div>
        </section>

    </main>

    <script>
        // ğŸš¨ é€™è£¡å·²ç¶“ç‚ºæ‚¨å¡«å…¥æ­£ç¢ºçš„ API ç¶²å€
        const API_URL = "https://script.google.com/macros/s/AKfycbwunBwJT2u3gpAcnibQW4RBOQhuzQXLtcirT4_6G6fG9FgwJjTAApax5fU0VZ1dNvdRog/exec";

        // å®‰å…¨æª¢æŸ¥
        const studentId = sessionStorage.getItem('studentId');
        if (!sessionStorage.getItem('isLoggedIn') || sessionStorage.getItem('userRole') !== 'parent' || !studentId) {
            alert('è«‹å…ˆä»¥å®¶é•·èº«åˆ†ç™»å…¥ï¼');
            window.location.href = 'login.html';
        }

        document.getElementById('display-student-id').innerText = studentId;

        // åˆå§‹åŒ–é é¢
        document.addEventListener('DOMContentLoaded', () => {
            const dateInput = document.getElementById('daily-date');
            dateInput.valueAsDate = new Date();
            
            dateInput.addEventListener('change', (e) => { fetchDailyData(e.target.value); });
            fetchDailyData(dateInput.value); // ç¬¬ä¸€æ¬¡è¼‰å…¥
        });

        // ğŸŸ¢ æ¨™ç±¤åˆ‡æ›é‚è¼¯ (å·²ä¿®å¾©åŠ å›)
        function switchTab(tab) {
            document.getElementById('view-daily').classList.toggle('hidden', tab !== 'daily');
            document.getElementById('view-weekly').classList.toggle('hidden', tab !== 'weekly');
            
            document.getElementById('btn-daily').className = tab === 'daily' 
                ? "flex-1 py-2 text-center rounded-md bg-white shadow text-blue-600 font-bold text-sm transition-all" 
                : "flex-1 py-2 text-center rounded-md text-gray-500 hover:text-gray-700 font-bold text-sm transition-all";
            
            document.getElementById('btn-weekly').className = tab === 'weekly' 
                ? "flex-1 py-2 text-center rounded-md bg-white shadow text-blue-600 font-bold text-sm transition-all" 
                : "flex-1 py-2 text-center rounded-md text-gray-500 hover:text-gray-700 font-bold text-sm transition-all";
            
            // å¦‚æœåˆ‡æ›åˆ°ä¸€é€±è¦–è§’ï¼Œå‰‡è§¸ç™¼ç¹ªè£½åœ–è¡¨
            if (tab === 'weekly') renderChart();
        }

        // æ ¸å¿ƒåŠŸèƒ½ï¼šå‘ Google Sheets æŠ“å–å ±è¡¨
        async function fetchDailyData(targetDate) {
            document.getElementById('loading-msg').classList.remove('hidden');
            ['attendance-section', 'score-section', 'submission-section'].forEach(id => document.getElementById(id).innerHTML = '');
            document.getElementById('no-data-msg').classList.add('hidden');

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    body: JSON.stringify({ action: 'getDailyReport', studentId: studentId, date: targetDate })
                });

                const result = await response.json();
                document.getElementById('loading-msg').classList.add('hidden');

                if (result.success) {
                    const hasAtt = result.attendance && result.attendance.length > 0;
                    const hasSco = result.scores && result.scores.length > 0;
                    const hasSub = result.submissions && result.submissions.length > 0;

                    if (!hasAtt && !hasSco && !hasSub) {
                        document.getElementById('no-data-msg').classList.remove('hidden');
                        return;
                    }

                    // 1. æ¸²æŸ“ç¹³äº¤äº‹é …
                    if (hasSub) {
                        let html = `<h4 class="text-sm font-bold text-indigo-500 mb-2 border-b pb-1"><i class="fas fa-clipboard-list mr-2"></i>è¡Œæ”¿ / ç‰©å“ç¹³äº¤è¿½è¹¤</h4>`;
                        result.submissions.forEach(rec => {
                            let sColor, sIcon, sText;
                            if (rec.status === 'done') { sColor = 'bg-green-100 text-green-700'; sIcon = 'fa-check-circle'; sText = 'å·²å®Œæˆ'; } 
                            else if (rec.status === 'pending') { sColor = 'bg-yellow-100 text-yellow-700'; sIcon = 'fa-exclamation-triangle'; sText = 'æœªå®Œæˆ'; } 
                            else { sColor = 'bg-red-100 text-red-700'; sIcon = 'fa-times-circle'; sText = 'ç¼ºäº¤'; }

                            html += `
                            <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-4 mb-3 flex justify-between items-center border-l-4 border-indigo-400">
                                <h4 class="font-bold text-gray-800">${rec.itemName}</h4>
                                <span class="${sColor} text-xs font-bold px-2 py-1 rounded-full"><i class="fas ${sIcon} mr-1"></i>${sText}</span>
                            </div>`;
                        });
                        document.getElementById('submission-section').innerHTML = html;
                    }

                    // 2. æ¸²æŸ“å‡ºç¼ºå¸­èˆ‡è©•èª
                    if (hasAtt) {
                        let html = `<h4 class="text-sm font-bold text-gray-500 mb-2 border-b pb-1 mt-4"><i class="fas fa-user-check mr-2"></i>ä¸Šèª²ç‹€æ³èˆ‡è©•èª</h4>`;
                        result.attendance.forEach(rec => {
                            let sColor = rec.attendance === 'present' ? 'bg-green-100 text-green-700' : (rec.attendance === 'late' ? 'bg-yellow-100 text-yellow-700' : 'bg-red-100 text-red-700');
                            let sText = rec.attendance === 'present' ? 'æ­£å¸¸å‡ºå¸­' : (rec.attendance === 'late' ? 'é²åˆ°' : 'ç¼ºå¸­');
                            html += `
                            <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-4 mb-3">
                                <div class="flex justify-between items-center mb-2">
                                    <h4 class="font-bold text-gray-800 text-lg">${rec.course}</h4>
                                    <span class="${sColor} text-xs font-bold px-2 py-1 rounded-full">${sText}</span>
                                </div>
                                <div class="bg-gray-50 rounded p-3">
                                    <p class="text-sm text-gray-700">${rec.comment || 'ç„¡è©•èª'}</p>
                                </div>
                            </div>`;
                        });
                        document.getElementById('attendance-section').innerHTML = html;
                    }

                    // 3. æ¸²æŸ“è€ƒè©¦æˆç¸¾
                    if (hasSco) {
                        let html = `<h4 class="text-sm font-bold text-gray-500 mb-2 border-b pb-1 mt-4"><i class="fas fa-marker mr-2"></i>æ¸¬é©—æˆç¸¾</h4>`;
                        result.scores.forEach(rec => {
                            html += `
                            <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-4 mb-3 flex justify-between items-center">
                                <div>
                                    <span class="text-xs font-bold bg-blue-100 text-blue-700 px-2 py-1 rounded">${rec.course}</span>
                                    <h4 class="font-bold text-gray-800 mt-2">${rec.examName}</h4>
                                </div>
                                <div class="text-right">
                                    <p class="text-xs text-gray-500">å¾—åˆ†</p>
                                    <p class="text-3xl font-black text-blue-600">${rec.score}</p>
                                </div>
                            </div>`;
                        });
                        document.getElementById('score-section').innerHTML = html;
                    }
                } else {
                    alert('âŒ è³‡æ–™ç²å–å¤±æ•—ï¼š' + result.message);
                }
            } catch (error) {
                document.getElementById('loading-msg').classList.add('hidden');
                document.getElementById('attendance-section').innerHTML = '<span class="text-red-500">é€£ç·šç•°å¸¸ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚</span>';
            }
        }

        // ğŸŸ¢ å‡è³‡æ–™åœ–è¡¨ç¹ªè£½ (å·²ä¿®å¾©åŠ å›)
        let chartInstance = null;
        function renderChart() {
            if (chartInstance) return; 
            const ctx = document.getElementById('gradeChart').getContext('2d');
            chartInstance = new Chart(ctx, { 
                type: 'line', 
                data: {
                    labels: ['é€±ä¸€', 'é€±äºŒ', 'é€±ä¸‰', 'é€±å››', 'é€±äº”'], 
                    datasets: [{
                        label: 'ç¶œåˆè©•åˆ†è¶¨å‹¢',
                        data: [85, 90, 88, 92, 95],
                        borderColor: 'rgba(59, 130, 246, 1)', 
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        borderWidth: 2, tension: 0.3, fill: true
                    }]
                }
            });
        }

        function logout() {
            sessionStorage.clear();
            window.location.href = 'login.html';
        }
    </script>
</body>
</html>