<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è€å¸«æ§åˆ¶å° - ä¸Šèª²èˆ‡æˆç¸¾ç™»è¨˜</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        input:disabled, select:disabled { background-color: transparent; border-color: transparent; color: #374151; cursor: default; appearance: none; }
        input:disabled:focus, select:disabled:focus { outline: none; box-shadow: none; }
    </style>
</head>
<body class="bg-gray-100 flex h-screen overflow-hidden font-sans relative">

    <header class="md:hidden bg-gray-800 text-white p-4 flex justify-between items-center shadow-md w-full absolute top-0 z-40">
        <h1 class="text-lg font-bold text-blue-400">ç³»çµ±ç®¡ç† - è€å¸«ç«¯</h1>
        <button onclick="logout()" class="text-red-400 hover:text-white text-sm border border-red-400 px-3 py-1 rounded"><i class="fas fa-sign-out-alt"></i> ç™»å‡º</button>
    </header>

    <aside class="w-64 bg-gray-800 text-white flex flex-col hidden md:flex z-40">
        <div class="p-6 text-center border-b border-gray-700">
            <h2 class="text-2xl font-bold text-blue-400">ç³»çµ±ç®¡ç†</h2>
            <p id="teacher-name-display" class="text-sm text-gray-400 mt-2">è€å¸«æ§åˆ¶å°</p>
        </div>
        <nav class="flex-1 p-4 space-y-2">
            <a href="#" class="block px-4 py-2 bg-blue-600 rounded-lg text-white font-medium"><i class="fas fa-edit mr-2"></i> ç™»è¨˜ç‹€æ³èˆ‡æˆç¸¾</a>
        </nav>
        <div class="p-4 border-t border-gray-700">
            <button onclick="logout()" class="w-full py-2 text-sm text-red-400 border border-red-400 rounded hover:bg-red-400 hover:text-white transition"><i class="fas fa-sign-out-alt mr-1"></i>ç™»å‡º</button>
        </div>
    </aside>

    <main class="flex-1 flex flex-col h-screen overflow-hidden pt-16 md:pt-0">
        <div class="flex-1 overflow-y-auto p-4 md:p-8">
            
            <div class="flex flex-wrap gap-2 mb-6 bg-gray-200 rounded-lg p-1">
                <button id="tab-attendance" onclick="switchMode('attendance')" class="flex-1 min-w-[100px] py-2 text-center rounded-md bg-white shadow text-blue-600 font-bold transition-all"><i class="fas fa-user-check mr-1"></i> å‡ºç¼ºå¸­/è©•èª</button>
                <button id="tab-score" onclick="switchMode('score')" class="flex-1 min-w-[100px] py-2 text-center rounded-md text-gray-500 hover:text-gray-700 font-bold transition-all"><i class="fas fa-marker mr-1"></i> è€ƒè©¦æˆç¸¾</button>
                <button id="tab-submission" onclick="switchMode('submission')" class="flex-1 min-w-[100px] py-2 text-center rounded-md text-gray-500 hover:text-gray-700 font-bold transition-all"><i class="fas fa-clipboard-check mr-1"></i> ç‰©å“/ä½œæ¥­</button>
                <button id="tab-announcement" onclick="switchMode('announcement')" class="flex-1 min-w-[100px] py-2 text-center rounded-md text-gray-500 hover:text-gray-700 font-bold transition-all"><i class="fas fa-bullhorn mr-1"></i> è¯çµ¡ç°¿</button>
                <button id="tab-homeroom" onclick="switchMode('homeroom')" class="hidden flex-1 min-w-[100px] py-2 text-center rounded-md text-gray-500 hover:text-gray-700 font-bold transition-all"><i class="fas fa-chart-pie text-yellow-500 mr-1"></i> å°å¸«å„€è¡¨æ¿</button>
                <button id="tab-manage" onclick="switchMode('manage')" class="hidden flex-1 min-w-[100px] py-2 text-center rounded-md text-gray-500 hover:text-gray-700 font-bold transition-all"><i class="fas fa-cog text-purple-500 mr-1"></i> ç­ç´šè¨­å®š</button>
            </div>

            <div id="filter-container" class="bg-white p-6 rounded-xl shadow-sm border border-gray-200 mb-6">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                    <div><label class="block text-sm font-medium text-gray-700 mb-1">æ—¥æœŸ</label><input type="date" id="datePicker" class="w-full border-gray-300 border rounded-lg p-2 focus:ring-2 focus:ring-blue-500"></div>
                    <div id="classContainer"><label class="block text-sm font-medium text-gray-700 mb-1">ç­ç´š</label><select id="classSelect" class="w-full border-gray-300 border rounded-lg p-2 focus:ring-2 focus:ring-blue-500"></select></div>
                    <div id="subjectContainer"><label class="block text-sm font-medium text-gray-700 mb-1">ç¯€æ¬¡ / ç§‘ç›®</label><select id="subjectSelect" class="w-full border-gray-300 border rounded-lg p-2 focus:ring-2 focus:ring-blue-500"><option value="">è¼‰å…¥ä¸­...</option></select></div>
                    <div id="examNameContainer" class="hidden md:col-span-2">
                        <label id="examNameLabel" class="block text-sm font-bold text-blue-600 mb-1">åç¨± (å¯è¼¸å…¥æ–°åç¨±æˆ–é»æ“Šä¸‹æ–¹æ¨™ç±¤)</label>
                        <input type="text" id="examNameInput" placeholder="ä¾‹: ç¬¬ä¸€å–®å…ƒ" class="w-full border-blue-300 border-2 rounded-lg p-2 focus:ring-2 focus:ring-blue-500 mb-1">
                        <div id="existing-items-tags" class="flex flex-wrap gap-1.5 min-h-[24px] items-center"></div>
                    </div>
                    <div><button id="load-btn" onclick="executeLoad()" class="w-full bg-blue-600 text-white font-medium py-2 rounded-lg hover:bg-blue-700 transition shadow"><i class="fas fa-cloud-download-alt mr-1"></i> è¼‰å…¥è³‡æ–™</button></div>
                </div>
            </div>

            <div id="manage-container" class="hidden space-y-6">
                <div class="flex items-center justify-between border-b pb-2">
                    <h2 class="text-xl font-black text-gray-800"><i class="fas fa-users-cog mr-2"></i>æœ¬ç­å°ˆå±¬ç®¡ç†å¾Œå°</h2>
                    <span class="bg-purple-100 text-purple-800 text-xs font-bold px-3 py-1 rounded-full"><i class="fas fa-shield-alt mr-1"></i>å°å¸«æœ€é«˜æ¬Šé™</span>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                        <div class="bg-blue-50 p-4 border-b border-gray-200 flex justify-between items-center">
                            <h3 class="font-bold text-blue-800"><i class="fas fa-user-graduate mr-2"></i>å­¸ç”Ÿåå–®ç®¡ç†</h3>
                            <button onclick="openStudentModal('add')" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1.5 rounded text-sm font-bold shadow transition flex items-center"><i class="fas fa-plus mr-1"></i>æ–°å¢å­¸ç”Ÿ</button>
                        </div>
                        <div class="p-4 max-h-[60vh] overflow-y-auto"><ul id="manage-student-list" class="divide-y divide-gray-100"><li class="text-center py-4 text-gray-400">è¼‰å…¥ä¸­...</li></ul></div>
                    </div>
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                        <div class="bg-purple-50 p-4 border-b border-gray-200 flex justify-between items-center">
                            <h3 class="font-bold text-purple-800"><i class="fas fa-key mr-2"></i>å®¶é•·èˆ‡å¹¹éƒ¨å¸³è™Ÿç®¡ç†</h3>
                            <button onclick="loadManageData()" class="text-purple-600 hover:text-purple-800 text-sm font-bold"><i class="fas fa-sync-alt mr-1"></i>é‡æ–°æ•´ç†</button>
                        </div>
                        <div class="p-4 max-h-[60vh] overflow-y-auto"><ul id="manage-account-list" class="divide-y divide-gray-100"><li class="text-center py-4 text-gray-400">è¼‰å…¥ä¸­...</li></ul></div>
                    </div>
                </div>
            </div>

            <div id="homeroom-container" class="hidden space-y-6">
                <div class="flex items-center justify-between border-b pb-2"><h2 class="text-xl font-black text-gray-800" id="homeroom-title">ç­ç´šå°å¸«å„€è¡¨æ¿</h2><span class="bg-yellow-100 text-yellow-800 text-xs font-bold px-3 py-1 rounded-full"><i class="fas fa-star mr-1"></i>å°å¸«å°ˆå±¬</span></div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="bg-white rounded-xl shadow-sm border-t-4 border-red-500 p-5"><h3 class="font-bold text-red-600 mb-4 text-base border-b border-gray-100 pb-2"><i class="fas fa-exclamation-triangle mr-2"></i>ç•°å¸¸å‡ºç¼ºå¸­</h3><div id="hr-attendance-list" class="space-y-3 text-sm max-h-[40vh] overflow-y-auto">è¼‰å…¥ä¸­...</div></div>
                    <div class="bg-white rounded-xl shadow-sm border-t-4 border-yellow-500 p-5"><h3 class="font-bold text-yellow-600 mb-4 text-base border-b border-gray-100 pb-2"><i class="fas fa-clipboard-list mr-2"></i>æœªäº¤èˆ‡å¾…åŠ å¼·</h3><div id="hr-submission-list" class="space-y-3 text-sm max-h-[40vh] overflow-y-auto">è¼‰å…¥ä¸­...</div></div>
                    <div class="bg-white rounded-xl shadow-sm border-t-4 border-blue-500 p-5"><h3 class="font-bold text-blue-600 mb-4 text-base border-b border-gray-100 pb-2"><i class="fas fa-bed mr-2"></i>ä»Šæ—¥è«‹å‡å–®</h3><div id="hr-leave-list" class="space-y-3 text-sm max-h-[40vh] overflow-y-auto">è¼‰å…¥ä¸­...</div></div>
                </div>
            </div>

            <div id="bulletin-container" class="hidden bg-white p-6 rounded-xl shadow-sm border border-gray-200 mt-2">
                 <h3 class="text-lg font-bold text-gray-800 mb-4"><i class="fas fa-bullhorn text-blue-500 mr-2"></i>ç™¼å¸ƒç­ç´šè¯çµ¡ç°¿ / ä½ˆå‘Š</h3>
                 <textarea id="bulletin-content" rows="6" class="w-full border-gray-300 border rounded-lg p-3 focus:ring-2 focus:ring-blue-500" placeholder="è«‹è¼¸å…¥ä»Šæ—¥è¦æé†’å®¶é•·æˆ–å­¸ç”Ÿçš„äº‹é …..."></textarea>
                 <div class="mt-4 bg-gray-50 p-3 rounded-lg border border-gray-200">
                     <label class="block text-sm font-bold text-gray-700 mb-2"><i class="fas fa-paperclip mr-1"></i>é™„åŠ æª”æ¡ˆ (ç…§ç‰‡æˆ–è¬›ç¾©ï¼Œä¸Šé™ 5MB)</label>
                     <input type="file" id="bulletin-file" accept="image/*,.pdf" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-bold file:bg-blue-100 file:text-blue-700 hover:file:bg-blue-200 cursor-pointer">
                     <div id="bulletin-file-link" class="mt-2 text-sm"></div>
                 </div>
                 <div class="mt-4 flex justify-end"><button id="save-bulletin-btn" onclick="saveBulletin()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg shadow transition"><i class="fas fa-paper-plane mr-2"></i> ç™¼å¸ƒ / æ›´æ–°å…¬å‘Š</button></div>
            </div>

            <div id="table-container" class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                <div class="bg-blue-50 p-4 border-b border-gray-200 flex justify-between items-center">
                    <div id="stats-dashboard" class="text-blue-800 font-bold text-sm">è«‹å…ˆè¼‰å…¥åå–®</div>
                    <button onclick="exportCSV()" class="bg-white border border-blue-300 text-blue-600 hover:bg-blue-100 font-bold py-1 px-3 rounded shadow-sm text-sm transition"><i class="fas fa-file-csv mr-1"></i> åŒ¯å‡º CSV</button>
                </div>
                <div id="readonly-warning" class="hidden bg-red-50 text-red-600 p-3 text-sm font-bold border-b border-red-100 flex items-center justify-center">
                    <i class="fas fa-lock mr-2"></i> æ­¤ä»»å‹™ç”± <span id="task-creator-name" class="mx-1 underline"></span> å»ºç«‹ï¼Œæ‚¨åƒ…æœ‰æª¢è¦–æ¬Šé™ã€‚
                </div>
                <div id="batch-assign-container" class="hidden bg-indigo-50 p-4 border-b border-indigo-100 flex flex-col sm:flex-row items-center justify-between gap-4">
                    <div class="flex-1 w-full"><label class="block text-xs font-bold text-indigo-700 mb-1"><i class="fas fa-magic mr-1"></i> å¿«é€ŸæŒ‡æ´¾ç‰¹å®šå­¸ç”Ÿ (è¼¸å…¥åº§è™Ÿï¼Œä¾‹: 1,3,5 æˆ– 1-5)</label><input type="text" id="batch-assign-input" placeholder="ç•™ç©ºä»£è¡¨å…¨ç­çš†é ˆç¹³äº¤" class="w-full bg-white border border-indigo-200 rounded px-3 py-1.5 text-sm outline-none focus:ring-2 focus:ring-indigo-400"></div>
                    <button onclick="applyBatchAssign()" class="bg-indigo-600 text-white px-5 py-2 mt-4 sm:mt-0 rounded-lg shadow-sm text-sm font-bold hover:bg-indigo-700 transition">å¿«é€Ÿå¥—ç”¨</button>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-left border-collapse min-w-max"><thead class="bg-gray-50 border-b border-gray-200" id="tableHeader"></thead><tbody id="studentTableBody" class="divide-y divide-gray-100"><tr><td colspan="6" class="text-center py-8 text-gray-400">è«‹è¼‰å…¥è³‡æ–™</td></tr></tbody></table>
                </div>
                <div id="bottom-action-bar" class="bg-gray-50 p-4 border-t border-gray-200 flex flex-col sm:flex-row justify-between items-center gap-4 hidden">
                    <div class="flex gap-2 w-full sm:w-auto">
                        <button id="quick-fill-btn" onclick="quickFill()" class="bg-blue-100 text-blue-700 hover:bg-blue-200 font-bold py-2 px-4 rounded-lg shadow-sm transition hidden flex-1 sm:flex-none"><i class="fas fa-check-circle mr-1"></i> ä¸€éµå…¨ç­æ­£å¸¸</button>
                        <button id="quick-done-btn" onclick="quickDone()" class="bg-green-100 text-green-700 hover:bg-green-200 font-bold py-2 px-4 rounded-lg shadow-sm transition hidden flex-1 sm:flex-none"><i class="fas fa-check-double mr-1"></i> ä¸€éµå…¨ç­å·²äº¤</button>
                    </div>
                    <button id="batch-save-btn" onclick="batchSave()" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-lg shadow transition flex items-center hidden w-full sm:w-auto justify-center"><i class="fas fa-bolt mr-2"></i> æ¥µé€Ÿä¸€éµå„²å­˜</button>
                </div>
            </div>

        </div>
    </main>

    <div id="admin-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-xl w-full max-w-sm overflow-hidden transform transition-all"><div id="modal-header" class="bg-blue-600 p-4 text-white flex justify-between items-center"><h3 class="font-bold text-lg" id="modal-title">æ¨™é¡Œ</h3><button onclick="closeAdminModal()" class="text-white hover:text-gray-200 outline-none"><i class="fas fa-times text-xl"></i></button></div><div class="p-6" id="modal-body"></div></div>
    </div>

    <script>
        const API_URL = "https://script.google.com/macros/s/AKfycbwunBwJT2u3gpAcnibQW4RBOQhuzQXLtcirT4_6G6fG9FgwJjTAApax5fU0VZ1dNvdRog/exec";
        if (!sessionStorage.getItem('isLoggedIn') || sessionStorage.getItem('userRole') !== 'teacher') { alert('æ¬Šé™ä¸è¶³ï¼'); window.location.href = 'login.html'; }

        let currentMode = 'attendance', studentData = [];
        const datePicker = document.getElementById('datePicker'), classSelect = document.getElementById('classSelect'), subjectSelect = document.getElementById('subjectSelect'), examNameInput = document.getElementById('examNameInput');
        const homeroomClass = sessionStorage.getItem('homeroom') || '';
        const myCreatorName = sessionStorage.getItem('username') || '';

        document.addEventListener('DOMContentLoaded', () => {
            datePicker.valueAsDate = new Date();
            let titleText = myCreatorName + " è€å¸«";
            if (homeroomClass) titleText += ` (ğŸ‘‘ ${homeroomClass}ç­å°å¸«)`;
            document.getElementById('teacher-name-display').innerText = titleText;

            JSON.parse(sessionStorage.getItem('teacherClasses') || "[]").forEach(c => classSelect.add(new Option(c, c)));

            if (homeroomClass) {
                document.getElementById('tab-homeroom').classList.remove('hidden');
                document.getElementById('tab-manage').classList.remove('hidden');
                document.getElementById('homeroom-title').innerText = `${homeroomClass}ç­ å°å¸«å„€è¡¨æ¿`;
                switchMode('homeroom'); 
            } else {
                fetchSubjectSchedule();
            }
        });

        async function fetchSubjectSchedule() {
            if (currentMode === 'homeroom' || currentMode === 'submission' || currentMode === 'manage') return; 
            const date = datePicker.value, className = classSelect.value;
            if (!date || !className) return;
            subjectSelect.innerHTML = '<option value="">è¼‰å…¥èª²è¡¨ä¸­...</option>'; subjectSelect.disabled = true;
            try {
                const response = await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'getSchedule', date: date, className: className }) });
                const result = await response.json();
                subjectSelect.innerHTML = ''; 
                if (result.success && !result.isWeekend && result.schedule.length > 0) {
                    const optGroup1 = document.createElement('optgroup'); optGroup1.label = "ğŸ“‹ ç•¶æ—¥èª²è¡¨ (é€£å‹•é¢¨ç´€é»å)";
                    result.schedule.forEach(item => { 
                        // ğŸŸ¢ ä¿®æ­£é»ï¼šå¦‚æœæ²’æœ‰ç§‘ç›®ï¼Œåªé¡¯ç¤ºç¯€æ¬¡ï¼Œä¸å†åŠ ä¸Šé€£å­—è™Ÿ
                        let disp = item.subject ? `${item.period} - ${item.subject}` : item.period;
                        optGroup1.appendChild(new Option(disp, disp)); 
                    });
                    subjectSelect.appendChild(optGroup1);
                } else subjectSelect.add(new Option("ä»Šæ—¥ç„¡é è¨­èª²è¡¨", ""));

                const teacherSubjs = JSON.parse(sessionStorage.getItem('teacherSubjects') || "[]");
                if (teacherSubjs.length > 0) {
                    const optGroup2 = document.createElement('optgroup'); optGroup2.label = "ğŸ’¡ æˆ‘çš„ä»»æ•™ç§‘ç›® (ç„¡ç¯€æ¬¡)";
                    teacherSubjs.forEach(s => optGroup2.appendChild(new Option(s, s))); subjectSelect.appendChild(optGroup2);
                }
            } catch (e) { subjectSelect.innerHTML = '<option value="">èª²è¡¨è¼‰å…¥å¤±æ•—</option>'; } finally { subjectSelect.disabled = false; if (currentMode === 'score') fetchExistingItems(); }
        }

        [datePicker, classSelect].forEach(input => { input.addEventListener('change', () => { resetTableState(); if (currentMode === 'homeroom') loadHomeroomOverview(); else if (currentMode === 'manage') loadManageData(); else if (currentMode !== 'submission') fetchSubjectSchedule(); if (currentMode === 'announcement') loadBulletin(); if (currentMode === 'submission' || currentMode === 'score') fetchExistingItems(); }); });
        [subjectSelect].forEach(input => { input.addEventListener('change', () => { resetTableState(); if (input === subjectSelect && currentMode === 'score') fetchExistingItems(); }); });
        examNameInput.addEventListener('input', () => { resetTableState(); });

        function resetTableState() { studentData = []; document.getElementById('studentTableBody').innerHTML = '<tr><td colspan="6" class="text-center py-8 text-red-500 font-bold">âš ï¸ æŸ¥è©¢æ¢ä»¶å·²è®Šæ›´ï¼Œè«‹é‡æ–°é»æ“Šã€Œè¼‰å…¥è³‡æ–™ã€</td></tr>'; document.getElementById('bottom-action-bar').classList.add('hidden'); document.getElementById('readonly-warning').classList.add('hidden'); document.getElementById('stats-dashboard').innerText = "ç­‰å¾…è¼‰å…¥..."; document.getElementById('batch-assign-container').classList.add('hidden'); }
        window.addEventListener('beforeunload', function (e) { if (studentData.some(st => !st.isSaved)) { e.preventDefault(); e.returnValue = 'æœªå„²å­˜é›¢é–‹ï¼Ÿ'; } });

        async function fetchExistingItems() { if (!classSelect.value) return; const isSub = currentMode === 'submission'; if (!isSub && !subjectSelect.value) return; const tagsContainer = document.getElementById('existing-items-tags'); tagsContainer.innerHTML = '<span class="text-xs text-gray-400">æŸ¥è©¢å·²æœ‰é …ç›®ä¸­...</span>'; try { const response = await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: isSub ? 'getSubmissionItems' : 'getExamNames', date: datePicker.value, className: classSelect.value, subject: subjectSelect.value }) }); const result = await response.json(); if (result.success) { const list = isSub ? result.items.filter(item => item !== 'æ‰‹æ©Ÿç¹³äº¤' && !item.includes('æ‰“æƒ')) : result.exams; if (list.length === 0) { tagsContainer.innerHTML = '<span class="text-xs text-gray-400"><i class="fas fa-info-circle mr-1"></i>ä»Šæ—¥å°šç„¡å»ºç«‹é …ç›®ï¼Œè«‹ç›´æ¥è¼¸å…¥æ–°åç¨±</span>'; } else { let html = '<span class="text-xs text-gray-500 mr-1">ä»Šæ—¥å·²æœ‰é …ç›®ï¼š</span>'; list.forEach(item => { html += `<button onclick="selectExistingItem('${item}')" class="bg-blue-50 hover:bg-blue-100 text-blue-700 border border-blue-200 px-2 py-0.5 rounded text-xs font-bold transition shadow-sm">${item}</button>`; }); tagsContainer.innerHTML = html; } } } catch (e) { tagsContainer.innerHTML = '<span class="text-xs text-red-400">æŸ¥è©¢å¤±æ•—</span>'; } }
        function selectExistingItem(itemName) { document.getElementById('examNameInput').value = itemName; loadStudentList(); }

        function switchMode(mode) { currentMode = mode; resetTableState(); document.getElementById('studentTableBody').innerHTML = '<tr><td colspan="6" class="text-center py-8 text-gray-400">è«‹é‡æ–°è¼‰å…¥è³‡æ–™</td></tr>'; const tabs = ['attendance', 'score', 'submission', 'announcement', 'homeroom', 'manage']; const classContainer = document.getElementById('classContainer'), subjContainer = document.getElementById('subjectContainer'), examContainer = document.getElementById('examNameContainer'), filterContainer = document.getElementById('filter-container'); const tableContainer = document.getElementById('table-container'), bulletinContainer = document.getElementById('bulletin-container'), hrContainer = document.getElementById('homeroom-container'), manageContainer = document.getElementById('manage-container'); tabs.forEach(t => { let el = document.getElementById(`tab-${t}`); if(el) { if ((t === 'homeroom' || t === 'manage') && !homeroomClass) return; el.className = "flex-1 min-w-[100px] py-2 text-center rounded-md text-gray-500 hover:text-gray-700 font-bold transition-all"; } }); tableContainer.classList.add('hidden'); bulletinContainer.classList.add('hidden'); hrContainer.classList.add('hidden'); manageContainer.classList.add('hidden'); filterContainer.classList.remove('hidden'); let activeTab = document.getElementById(`tab-${mode}`); if(activeTab) activeTab.className = "flex-1 min-w-[100px] py-2 text-center rounded-md bg-white shadow text-blue-600 font-bold transition-all"; if (mode === 'homeroom') { classContainer.classList.add('hidden'); subjContainer.classList.add('hidden'); examContainer.classList.add('hidden'); hrContainer.classList.remove('hidden'); loadHomeroomOverview(); } else if (mode === 'manage') { filterContainer.classList.add('hidden'); manageContainer.classList.remove('hidden'); loadManageData(); } else if (mode === 'attendance') { classContainer.classList.remove('hidden'); subjContainer.classList.remove('hidden'); examContainer.classList.add('hidden'); tableContainer.classList.remove('hidden'); fetchSubjectSchedule(); } else if (mode === 'score') { classContainer.classList.remove('hidden'); subjContainer.classList.remove('hidden'); examContainer.classList.remove('hidden'); tableContainer.classList.remove('hidden'); document.getElementById('examNameLabel').innerText = 'è€ƒè©¦åç¨± (å¯è¼¸å…¥æ–°åç¨±æˆ–é»æ“Šä¸‹æ–¹æ¨™ç±¤)'; examNameInput.placeholder = 'ä¾‹: ç¬¬ä¸€å–®å…ƒ'; fetchSubjectSchedule(); } else if (mode === 'submission') { classContainer.classList.remove('hidden'); subjContainer.classList.add('hidden'); examContainer.classList.remove('hidden'); tableContainer.classList.remove('hidden'); document.getElementById('examNameLabel').innerText = 'ç‰©å“/ä½œæ¥­åç¨± (å¯è¼¸å…¥æ–°åç¨±æˆ–é»æ“Šä¸‹æ–¹æ¨™ç±¤)'; examNameInput.placeholder = 'ä¾‹: åœ‹æ–‡å­¸ç¿’å–®'; fetchExistingItems(); } else if (mode === 'announcement') { classContainer.classList.remove('hidden'); subjContainer.classList.add('hidden'); examContainer.classList.add('hidden'); bulletinContainer.classList.remove('hidden'); loadBulletin(); } renderTableHeader(); }
        function executeLoad() { if (currentMode === 'homeroom') loadHomeroomOverview(); else if (currentMode === 'announcement') loadBulletin(); else loadStudentList(); }

        async function loadHomeroomOverview() { const btn = document.getElementById('load-btn'); btn.innerHTML = `<i class="fas fa-spinner fa-spin mr-1"></i>è¼‰å…¥ä¸­...`; btn.disabled = true; const attList = document.getElementById('hr-attendance-list'); const subList = document.getElementById('hr-submission-list'); const leaveList = document.getElementById('hr-leave-list'); attList.innerHTML = '<div class="text-center py-6 text-blue-500"><i class="fas fa-circle-notch fa-spin text-2xl mb-2"></i><p class="text-sm font-bold">è³‡æ–™åˆ†æä¸­...</p></div>'; subList.innerHTML = '<div class="text-center py-6 text-yellow-500"><i class="fas fa-circle-notch fa-spin text-2xl mb-2"></i><p class="text-sm font-bold">è³‡æ–™åˆ†æä¸­...</p></div>'; leaveList.innerHTML = '<div class="text-center py-6 text-blue-500"><i class="fas fa-circle-notch fa-spin text-2xl mb-2"></i><p class="text-sm font-bold">è³‡æ–™åˆ†æä¸­...</p></div>'; try { const response = await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'getHomeroomOverview', date: datePicker.value, className: homeroomClass }) }); const result = await response.json(); if (result.success) { renderHomeroom(result.data); } else { alert('è¼‰å…¥å¤±æ•—ï¼š' + result.message); attList.innerHTML = '<p class="text-red-500 text-center font-bold">è¼‰å…¥å¤±æ•—</p>'; subList.innerHTML = '<p class="text-red-500 text-center font-bold">è¼‰å…¥å¤±æ•—</p>'; leaveList.innerHTML = '<p class="text-red-500 text-center font-bold">è¼‰å…¥å¤±æ•—</p>'; } } catch(e) { console.error("Homeroom Fetch Error:", e); alert('ç¶²è·¯é€£ç·šç•°å¸¸ï¼Œç„¡æ³•è¼‰å…¥å°å¸«å„€è¡¨æ¿ï¼'); attList.innerHTML = '<p class="text-red-500 text-center font-bold">ç¶²è·¯é€£ç·šç•°å¸¸</p>'; subList.innerHTML = '<p class="text-red-500 text-center font-bold">ç¶²è·¯é€£ç·šç•°å¸¸</p>'; leaveList.innerHTML = '<p class="text-red-500 text-center font-bold">ç¶²è·¯é€£ç·šç•°å¸¸</p>'; } finally { btn.innerHTML = `<i class="fas fa-cloud-download-alt mr-1"></i> è¼‰å…¥è³‡æ–™`; btn.disabled = false; } }
        function renderHomeroom(data) { const attList = document.getElementById('hr-attendance-list'); if (!data.abnormalAttendance || data.abnormalAttendance.length === 0) { attList.innerHTML = '<div class="bg-green-50 text-green-600 p-4 rounded-lg text-center font-bold border border-green-200"><i class="fas fa-check-circle text-2xl mb-1 block"></i>å…¨ç­çš†æ­£å¸¸å‡ºå¸­</div>'; } else { let html = ''; data.abnormalAttendance.forEach(a => { let badge = a.status === 'absent' ? '<span class="bg-red-100 text-red-700 px-2 py-1 rounded text-xs font-bold shadow-sm">ç¼ºå¸­</span>' : '<span class="bg-yellow-100 text-yellow-700 px-2 py-1 rounded text-xs font-bold shadow-sm">é²åˆ°</span>'; html += `<div class="flex justify-between items-center border-b border-gray-100 pb-3 mb-3 last:border-0 last:mb-0 last:pb-0"> <div class="font-bold text-gray-700"><span class="text-gray-400 mr-2 text-xs">${a.studentId}</span>${a.name} <span class="text-gray-400 text-xs ml-1 bg-gray-50 px-1 rounded">${a.subject}</span></div> ${badge} </div>`; }); attList.innerHTML = html; } const subList = document.getElementById('hr-submission-list'); if (!data.missingSubmissions || data.missingSubmissions.length === 0) { subList.innerHTML = '<div class="bg-green-50 text-green-600 p-4 rounded-lg text-center font-bold border border-green-200"><i class="fas fa-clipboard-check text-2xl mb-1 block"></i>å°šç„¡ä»»ä½•æœªäº¤é …ç›®</div>'; } else { let html = ''; data.missingSubmissions.forEach(s => { let badge = s.status === 'missing' ? '<span class="bg-red-100 text-red-700 px-2 py-1 rounded text-xs font-bold shadow-sm">ç¼ºäº¤/æœªæƒ</span>' : '<span class="bg-yellow-100 text-yellow-700 px-2 py-1 rounded text-xs font-bold shadow-sm">æœªäº¤/å¾…åŠ å¼·</span>'; let isOld = s.date !== datePicker.value ? `<span class="text-[10px] text-red-500 bg-red-50 px-1 rounded border border-red-100 ml-1">è‡ª ${s.date} æ¬ äº¤</span>` : ''; html += `<div class="flex justify-between items-center border-b border-gray-100 pb-3 mb-3 last:border-0 last:mb-0 last:pb-0"> <div> <div class="font-bold text-gray-800"><span class="text-gray-400 mr-2 text-xs">${s.studentId}</span>${s.name}</div> <div class="text-xs font-bold text-indigo-600 mt-1"><i class="fas fa-caret-right mr-1"></i>${s.itemName} ${isOld}</div> </div> ${badge} </div>`; }); subList.innerHTML = html; } const leaveList = document.getElementById('hr-leave-list'); if (!data.leaveRequests || data.leaveRequests.length === 0) { leaveList.innerHTML = '<div class="bg-gray-50 text-gray-500 p-4 rounded-lg text-center font-bold border border-gray-200"><i class="fas fa-bed text-2xl mb-1 block text-gray-300"></i>ä»Šæ—¥ç„¡è«‹å‡å–®</div>'; } else { let html = ''; data.leaveRequests.forEach(l => { html += `<div class="border-b border-gray-100 pb-3 mb-3 last:border-0 last:mb-0 last:pb-0"> <div class="flex justify-between items-center mb-2"> <div class="font-bold text-gray-800"><span class="text-gray-400 mr-2 text-xs">${l.studentId}</span>${l.name}</div> <span class="bg-blue-100 text-blue-700 px-2 py-1 rounded text-xs font-bold shadow-sm">${l.type}</span> </div> <div class="text-xs text-gray-600 bg-blue-50 p-2 rounded-lg border border-blue-100"><span class="font-bold">äº‹ç”±ï¼š</span>${l.reason}</div> </div>`; }); leaveList.innerHTML = html; } }
        function closeAdminModal() { document.getElementById('admin-modal').classList.add('hidden'); }
        async function loadManageData() { const listStu = document.getElementById('manage-student-list'); const listAcc = document.getElementById('manage-account-list'); listStu.innerHTML = '<li class="text-center py-4 text-blue-500"><i class="fas fa-spinner fa-spin mr-2"></i>è¼‰å…¥ä¸­...</li>'; listAcc.innerHTML = '<li class="text-center py-4 text-purple-500"><i class="fas fa-spinner fa-spin mr-2"></i>è¼‰å…¥ä¸­...</li>'; try { const res = await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'getHomeroomUsers', className: homeroomClass }) }); const result = await res.json(); if (result.success) { if(result.students.length === 0) listStu.innerHTML = '<li class="text-center py-4 text-gray-400">ç›®å‰ç„¡å­¸ç”Ÿè³‡æ–™</li>'; else { let sHtml = ''; result.students.forEach(st => { sHtml += `<li class="flex justify-between items-center py-3"> <div><span class="text-gray-400 font-mono text-sm mr-2 w-8 inline-block">${st.studentId}</span><span class="font-bold text-gray-800">${st.name}</span></div> <button onclick="openStudentModal('edit', '${st.studentId}', '${st.name}')" class="text-blue-500 hover:text-blue-700 bg-blue-50 px-2 py-1 rounded text-xs font-bold border border-blue-100 transition shadow-sm"><i class="fas fa-pen mr-1"></i>ä¿®æ”¹</button> </li>`; }); listStu.innerHTML = sHtml; } if(result.accounts.length === 0) listAcc.innerHTML = '<li class="text-center py-4 text-gray-400">ç›®å‰ç„¡å¸³è™Ÿè³‡æ–™</li>'; else { let aHtml = ''; result.accounts.forEach(acc => { let isParent = acc.role === 'å®¶é•·'; let roleColor = isParent ? 'bg-indigo-100 text-indigo-700' : 'bg-green-100 text-green-700'; let icon = isParent ? 'fa-user' : 'fa-shield-alt'; aHtml += `<li class="flex justify-between items-center py-3"> <div> <div class="font-bold text-gray-800">${acc.username} <span class="ml-2 text-[10px] font-bold ${roleColor} px-1.5 py-0.5 rounded border border-white"><i class="fas ${icon} mr-1"></i>${acc.role}</span></div> <div class="text-xs text-gray-500 mt-1">${acc.relatedInfo}</div> </div> <button onclick="openPasswordModal('${acc.username}')" class="text-purple-600 hover:text-white hover:bg-purple-600 bg-purple-50 px-3 py-1.5 rounded-lg text-xs font-bold border border-purple-200 transition shadow-sm"><i class="fas fa-key mr-1"></i>é‡è¨­å¯†ç¢¼</button> </li>`; }); listAcc.innerHTML = aHtml; } } else { listStu.innerHTML = `<li class="text-red-500 text-center py-4">è®€å–å¤±æ•—</li>`; listAcc.innerHTML = `<li class="text-red-500 text-center py-4">è®€å–å¤±æ•—</li>`; } } catch(e) { listStu.innerHTML = `<li class="text-red-500 text-center py-4">é€£ç·šç•°å¸¸</li>`; listAcc.innerHTML = `<li class="text-red-500 text-center py-4">é€£ç·šç•°å¸¸</li>`; } }
        function openStudentModal(mode, oldId = '', oldName = '') { const modal = document.getElementById('admin-modal'); document.getElementById('modal-header').className = 'bg-blue-600 p-4 text-white flex justify-between items-center'; document.getElementById('modal-title').innerHTML = mode === 'add' ? '<i class="fas fa-user-plus mr-2"></i>æ–°å¢å­¸ç”Ÿ' : '<i class="fas fa-user-edit mr-2"></i>ä¿®æ”¹å­¸ç”Ÿè³‡æ–™'; document.getElementById('modal-body').innerHTML = ` <div class="bg-blue-50 p-3 rounded mb-4 text-xs text-blue-800">ğŸ’¡ æç¤ºï¼šè«‹ç¢ºä¿å­¸è™Ÿæ­£ç¢ºï¼Œé€™æœƒå½±éŸ¿å®¶é•·ç™»å…¥èˆ‡æˆç¸¾é€£å‹•ã€‚</div> <div class="mb-4"> <label class="block text-sm font-bold text-gray-700 mb-1">å­¸è™Ÿ (ç™»å…¥ç”¨)</label> <input type="text" id="admin-stu-id" value="${oldId}" class="w-full border-gray-300 border rounded-lg p-2 focus:ring-2 focus:ring-blue-500 outline-none"> </div> <div class="mb-6"> <label class="block text-sm font-bold text-gray-700 mb-1">å­¸ç”Ÿå§“å</label> <input type="text" id="admin-stu-name" value="${oldName}" class="w-full border-gray-300 border rounded-lg p-2 focus:ring-2 focus:ring-blue-500 outline-none"> </div> <button id="admin-submit-btn" onclick="submitStudent('${mode}', '${oldId}')" class="w-full bg-blue-600 text-white font-bold py-3 rounded-lg shadow hover:bg-blue-700 transition">å„²å­˜è³‡æ–™</button> `; modal.classList.remove('hidden'); }
        async function submitStudent(mode, oldId) { const newId = document.getElementById('admin-stu-id').value.trim(); const newName = document.getElementById('admin-stu-name').value.trim(); if(!newId || !newName) return alert('å­¸è™Ÿèˆ‡å§“åä¸å¯ç©ºç™½ï¼'); const btn = document.getElementById('admin-submit-btn'); btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>è™•ç†ä¸­...'; btn.disabled = true; try { const res = await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'updateStudentData', className: homeroomClass, oldStudentId: oldId, newStudentId: newId, newName: newName, mode: mode }) }); const result = await res.json(); alert(result.message); if(result.success) { closeAdminModal(); loadManageData(); } } catch(e) { alert('é€£ç·šç•°å¸¸'); } finally { btn.innerHTML = 'å„²å­˜è³‡æ–™'; btn.disabled = false; } }
        function openPasswordModal(username) { const modal = document.getElementById('admin-modal'); document.getElementById('modal-header').className = 'bg-purple-600 p-4 text-white flex justify-between items-center'; document.getElementById('modal-title').innerHTML = '<i class="fas fa-unlock-alt mr-2"></i>é‡è¨­å¯†ç¢¼'; document.getElementById('modal-body').innerHTML = ` <div class="bg-purple-50 p-3 rounded mb-4 text-sm text-purple-800 border border-purple-100"> æ­£åœ¨ç‚ºå¸³è™Ÿ <span class="font-black text-purple-900 bg-white px-2 py-0.5 rounded shadow-sm mx-1">${username}</span> é‡è¨­å¯†ç¢¼ã€‚ </div> <div class="mb-6"> <label class="block text-sm font-bold text-gray-700 mb-1">è«‹è¼¸å…¥æ–°å¯†ç¢¼</label> <input type="text" id="admin-new-pwd" placeholder="å»ºè­°è¨­å®šç‚ºå®¶é•·æ‰‹æ©Ÿè™Ÿç¢¼" class="w-full border-gray-300 border rounded-lg p-3 focus:ring-2 focus:ring-purple-500 outline-none"> </div> <button id="admin-pwd-btn" onclick="submitPassword('${username}')" class="w-full bg-purple-600 text-white font-bold py-3 rounded-lg shadow hover:bg-purple-700 transition">ç¢ºèªé‡è¨­å¯†ç¢¼</button> `; modal.classList.remove('hidden'); }
        async function submitPassword(username) { const newPwd = document.getElementById('admin-new-pwd').value.trim(); if(!newPwd) return alert('æ–°å¯†ç¢¼ä¸å¯ç©ºç™½ï¼'); const btn = document.getElementById('admin-pwd-btn'); btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>é‡è¨­ä¸­...'; btn.disabled = true; try { const res = await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'resetUserPassword', className: homeroomClass, username: username, newPassword: newPwd }) }); const result = await res.json(); alert(result.message); if(result.success) closeAdminModal(); } catch(e) { alert('é€£ç·šç•°å¸¸'); } finally { btn.innerHTML = 'ç¢ºèªé‡è¨­å¯†ç¢¼'; btn.disabled = false; } }
        function renderTableHeader() { const tr = document.createElement('tr'); let html = `<th class="p-4 text-sm font-semibold text-gray-600 w-24">å­¸è™Ÿ</th><th class="p-4 text-sm font-semibold text-gray-600 w-24">å§“å</th>`; if (currentMode === 'attendance') html += `<th class="p-4 text-sm font-semibold text-gray-600 w-32">ç‹€æ…‹</th><th class="p-4 text-sm font-semibold text-gray-600">è©•èª</th>`; else if (currentMode === 'submission') html += `<th class="p-4 text-sm font-semibold text-gray-600 w-40">ç¹³äº¤ç‹€æ…‹</th>`; else html += `<th class="p-4 text-sm font-semibold text-gray-600">è€ƒè©¦æˆç¸¾</th>`; html += `<th class="p-4 text-sm font-semibold text-gray-600 text-center w-24">æ“ä½œ</th>`; tr.innerHTML = html; document.getElementById('tableHeader').innerHTML = ''; document.getElementById('tableHeader').appendChild(tr); }
        function renderTable(isReadOnly = false) { const tbody = document.getElementById('studentTableBody'); tbody.innerHTML = ''; let statsHTML = ""; if (currentMode === 'attendance') { let p=0, l=0, a=0, v=0; studentData.forEach(st => { if(st.attendance==='present') p++; else if(st.attendance==='late') l++; else if(st.attendance==='absent') a++; else if(st.attendance==='leave') v++; }); statsHTML = `âœ…æ­£å¸¸:${p} | âš ï¸é²åˆ°:${l} | âŒç¼ºå¸­:${a} | ğŸ›Œè«‹å‡:${v}`; } else if (currentMode === 'submission') { let d=0, p=0, e=0; studentData.forEach(st => { if(st.status==='done') d++; else if(st.status==='exempt') e++; else p++; }); statsHTML = `âœ…å·²äº¤:${d} | âš ï¸æœªäº¤:${p} | ğŸš«å…äº¤:${e}`; } else { let sum=0, count=0, max=-1, min=101; studentData.forEach(st => { let s = parseFloat(st.score); if(!isNaN(s)) { sum+=s; count++; if(s>max) max=s; if(s<min) min=s; } }); statsHTML = count>0 ? `ğŸ“Šå‡åˆ†:${(sum/count).toFixed(1)} | ğŸ“ˆæœ€é«˜:${max} | ğŸ“‰æœ€ä½:${min}` : "ç„¡æˆç¸¾æ•¸æ“š"; } document.getElementById('stats-dashboard').innerHTML = statsHTML; if(studentData.length === 0) return tbody.innerHTML = '<tr><td colspan="6" class="text-center py-8 text-gray-400">æ­¤ç­ç´šç„¡è³‡æ–™</td></tr>'; studentData.forEach((st, i) => { const disabled = (st.isSaved || isReadOnly) ? 'disabled' : ''; const rowClass = st.isSaved ? 'bg-gray-100' : 'bg-white'; let actionBtn = ''; if (isReadOnly) { actionBtn = `<i class="fas fa-lock text-gray-300"></i>`; } else { actionBtn = st.isSaved ? `<button onclick="toggleEdit(${i})" class="text-gray-500 hover:text-blue-600 px-3 py-1"><i class="fas fa-pencil-alt"></i></button>` : `<button class="text-blue-400 px-3 py-1 cursor-default"><i class="fas fa-pen"></i></button>`; } let tr = document.createElement('tr'); if (st.attendance === 'leave' && !st.isSaved) tr.className = `bg-blue-50 transition`; else if (currentMode === 'submission' && st.status === 'exempt') tr.className = `bg-gray-50 opacity-70 transition`; else tr.className = `hover:bg-blue-50 transition ${rowClass}`; let html = `<td class="p-4 text-sm font-mono">${st.studentId}</td><td class="p-4 text-sm font-bold min-w-[80px]">${st.name}</td>`; if (currentMode === 'attendance') { let sClass = st.attendance === 'leave' ? 'w-full border rounded p-1 text-sm font-bold text-blue-600' : 'w-full border rounded p-1 text-sm focus:border-blue-500'; html += `<td class="p-4"><select id="att-${i}" onchange="syncAndRender()" class="${sClass}" ${disabled}><option value="present" ${st.attendance === 'present' ? 'selected' : ''}>âœ… æ­£å¸¸</option><option value="late" ${st.attendance === 'late' ? 'selected' : ''}>âš ï¸ é²åˆ°</option><option value="absent" ${st.attendance === 'absent' ? 'selected' : ''}>âŒ ç¼ºå¸­</option><option value="leave" ${st.attendance === 'leave' ? 'selected' : ''}>ğŸ›Œ è«‹å‡</option></select></td><td class="p-4"><input type="text" id="com-${i}" onchange="syncData()" value="${st.comment}" placeholder="è©•èª" class="w-full border rounded p-1 text-sm min-w-[120px]" ${disabled}></td>`; } else if (currentMode === 'submission') { let sStatus = st.status || 'pending'; if (isReadOnly) { let badgeText = sStatus==='done'?'å·²äº¤':(sStatus==='pending'?'æœªäº¤':(sStatus==='exempt'?'å…äº¤':'ç¼ºäº¤')); let badgeColor = sStatus==='done'?'bg-green-100 text-green-700':(sStatus==='pending'?'bg-yellow-100 text-yellow-700':(sStatus==='exempt'?'bg-gray-100 text-gray-500':'bg-red-100 text-red-700')); html += `<td class="p-4"><span class="${badgeColor} px-2 py-1 text-xs font-bold rounded">${badgeText}</span></td>`; } else { let sClass = st.status === 'exempt' ? 'w-full border rounded p-1 text-sm text-gray-500' : 'w-full border rounded p-1 text-sm focus:border-blue-500'; html += `<td class="p-4"><select id="sub-${i}" onchange="syncAndRender()" class="${sClass}" ${disabled}><option value="done" ${sStatus === 'done' ? 'selected' : ''}>âœ… å·²äº¤</option><option value="pending" ${sStatus === 'pending' ? 'selected' : ''}>âš ï¸ æœªäº¤</option><option value="exempt" ${sStatus === 'exempt' ? 'selected' : ''}>ğŸš« å…äº¤</option></select></td>`; } } else { html += `<td class="p-4"><input type="number" id="sco-${i}" oninput="syncAndRender()" value="${st.score}" placeholder="åˆ†æ•¸" min="0" max="100" class="w-full border rounded p-1 text-sm" ${disabled}></td>`; } html += `<td class="p-4 text-center">${actionBtn}</td>`; tr.innerHTML = html; tbody.appendChild(tr); }); }
        function toggleEdit(index) { syncData(); studentData[index].isSaved = false; renderTable(); } function syncAndRender() { syncData(); renderTable(); } function syncData() { studentData.forEach((st, i) => { if (!st.isSaved) { if (currentMode === 'attendance') { let attEl = document.getElementById(`att-${i}`), comEl = document.getElementById(`com-${i}`); if(attEl) st.attendance = attEl.value; if(comEl) st.comment = comEl.value; } else if (currentMode === 'submission') { let subEl = document.getElementById(`sub-${i}`); if(subEl) st.status = subEl.value; } else { let scoEl = document.getElementById(`sco-${i}`); if(scoEl) st.score = scoEl.value; } } }); }
        function applyBatchAssign() { if (currentMode !== 'submission') return; const input = document.getElementById('batch-assign-input').value.trim(); if (!input) { studentData.forEach(st => { if (st.status === 'exempt') { st.status = 'pending'; st.isSaved = false; } }); renderTable(false); return alert('å·²é‡ç½®ç‚ºã€Œå…¨ç­çš†é ˆç¹³äº¤ã€ã€‚'); } let targetSeats = new Set(); input.split(',').forEach(p => { p = p.trim(); if (p.includes('-')) { let range = p.split('-'); let start = parseInt(range[0]), end = parseInt(range[1]); if (!isNaN(start) && !isNaN(end)) for(let i=start; i<=end; i++) targetSeats.add(i.toString()); } else { let seat = parseInt(p); if (!isNaN(seat)) targetSeats.add(seat.toString()); } }); let count = 0; studentData.forEach(st => { let seat1 = st.studentId.toString(); let seat2 = parseInt(seat1.slice(-2)).toString(); let seat3 = parseInt(seat1).toString(); if (targetSeats.has(seat1) || targetSeats.has(seat2) || targetSeats.has(seat3)) { if (st.status === 'exempt' || !st.status) st.status = 'pending'; count++; } else st.status = 'exempt'; st.isSaved = false; }); renderTable(false); alert(`âœ… æˆåŠŸæŒ‡æ´¾çµ¦ ${count} ä½å­¸ç”Ÿï¼Œå…¶é¤˜å·²è‡ªå‹•è¨­ç‚ºã€Œå…äº¤ã€ã€‚\nè«‹ç¢ºèªç„¡èª¤å¾Œé»æ“Šæœ€ä¸‹æ–¹ã€å„²å­˜ã€‘ï¼`); }
        async function loadStudentList() { const date = datePicker.value, className = classSelect.value, subject = subjectSelect.value, examName = examNameInput.value; if (currentMode === 'score' && (!subject || !examName.trim())) return alert("è«‹å¡«å¯«ç§‘ç›®èˆ‡è€ƒè©¦åç¨±ï¼"); if (currentMode === 'submission' && !examName.trim()) return alert("è«‹å¡«å¯«ç‰©å“/ä½œæ¥­åç¨±ï¼"); const loadBtn = document.getElementById('load-btn'); loadBtn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> è¼‰å…¥ä¸­`; loadBtn.disabled = true; document.getElementById('readonly-warning').classList.add('hidden'); try { let action = currentMode === 'attendance' ? 'loadAttendance' : (currentMode === 'score' ? 'loadScores' : 'loadSubmissions'); const response = await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: action, date, className, subject, examName, itemName: examName }) }); const result = await response.json(); if (result.success) { studentData = result.data; let isReadOnly = false; let isHomeroom = (homeroomClass === className); if (currentMode === 'submission' && result.creator && result.creator !== myCreatorName && !isHomeroom) { isReadOnly = true; document.getElementById('task-creator-name').innerText = result.creator; document.getElementById('readonly-warning').classList.remove('hidden'); } renderTable(isReadOnly); document.getElementById('bottom-action-bar').classList.remove('hidden'); if (isReadOnly) { document.getElementById('batch-assign-container').classList.add('hidden'); document.getElementById('quick-done-btn').classList.add('hidden'); document.getElementById('quick-fill-btn').classList.add('hidden'); document.getElementById('batch-save-btn').classList.add('hidden'); } else { document.getElementById('batch-save-btn').classList.remove('hidden'); if(currentMode === 'attendance') { document.getElementById('quick-fill-btn').classList.remove('hidden'); document.getElementById('quick-done-btn').classList.add('hidden'); } if(currentMode === 'submission') { document.getElementById('batch-assign-container').classList.remove('hidden'); document.getElementById('quick-done-btn').classList.remove('hidden'); document.getElementById('quick-fill-btn').classList.add('hidden'); } } } else alert('âŒ å¤±æ•—ï¼š' + result.message); } catch (error) { alert('é€£ç·šç•°å¸¸ã€‚'); } finally { loadBtn.innerHTML = `<i class="fas fa-cloud-download-alt mr-1"></i> è¼‰å…¥è³‡æ–™`; loadBtn.disabled = false; } }
        function quickFill() { if (currentMode !== 'attendance') return; studentData.forEach(st => { if (!st.isSaved && st.attendance !== 'leave') { st.attendance = 'present'; } }); renderTable(false); }
        function quickDone() { if (currentMode !== 'submission') return; studentData.forEach(st => { if (!st.isSaved && st.status !== 'exempt') { st.status = 'done'; } }); renderTable(false); }
        async function batchSave() { syncData(); const records = []; const date = datePicker.value, className = classSelect.value, subject = subjectSelect.value, examName = examNameInput.value; for(let st of studentData) { if (!st.isSaved) { if (currentMode === 'score' && st.score !== "") { let s = parseFloat(st.score); if (isNaN(s) || s < 0 || s > 100) return alert(`âš ï¸ å­¸è™Ÿ ${st.studentId} çš„åˆ†æ•¸æ ¼å¼éŒ¯èª¤`); } let rec = { date, className, studentId: st.studentId, name: st.name }; if (currentMode === 'attendance') { rec.subject = subject; rec.attendance = st.attendance; rec.comment = st.comment; } else if (currentMode === 'submission') { rec.itemName = examName; rec.status = st.status; rec.creatorName = myCreatorName; } else { rec.subject = subject; rec.examName = examName; rec.score = st.score; } records.push(rec); } } if (records.length === 0) return alert('æ²’æœ‰è®Šæ›´ï¼'); const btn = document.getElementById('batch-save-btn'); btn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> å„²å­˜ä¸­...`; btn.disabled = true; try { let action = currentMode === 'attendance' ? 'batchSaveAttendance' : (currentMode === 'score' ? 'batchSaveScores' : 'batchSaveSubmissions'); const response = await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action, records }) }); const result = await response.json(); if (result.success) { studentData.forEach(st => st.isSaved = true); if (currentMode === 'score' || currentMode === 'submission') fetchExistingItems(); renderTable(); alert('ğŸ‰ å„²å­˜æˆåŠŸï¼'); } else alert('âŒ å¤±æ•—ï¼š' + result.message); } catch (error) { alert('é€£ç·šç•°å¸¸ã€‚'); } btn.innerHTML = `<i class="fas fa-bolt mr-2"></i> æ¥µé€Ÿä¸€éµå„²å­˜`; btn.disabled = false; }
        async function loadBulletin() { const btn = document.getElementById('load-btn'); btn.innerHTML = `<i class="fas fa-spinner fa-spin"></i>`; btn.disabled = true; try { const response = await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'loadAnnouncement', date: datePicker.value, className: classSelect.value }) }); const result = await response.json(); if(result.success) { document.getElementById('bulletin-content').value = result.content || ""; const linkDiv = document.getElementById('bulletin-file-link'); if(result.fileUrl) { let fileIdMatch = result.fileUrl.match(/[-\w]{25,}/); let fileId = fileIdMatch ? fileIdMatch[0] : ''; let imgTag = fileId ? `<div class="mt-3"><img src="https://drive.google.com/thumbnail?id=${fileId}&sz=w800" class="max-h-60 rounded-lg shadow-sm border border-gray-200" onerror="this.style.display='none';"></div>` : ''; linkDiv.innerHTML = `âœ… ç›®å‰é™„ä»¶ï¼š<a href="${result.fileUrl}" target="_blank" class="text-blue-600 font-bold underline hover:text-blue-800">é»æ­¤é–‹å•“åŸå§‹æª”æ¡ˆ</a> <span class="text-xs text-gray-400 ml-2">(è‹¥é‡æ–°ä¸Šå‚³å°‡æœƒè¦†è“‹)</span>${imgTag}`; } else { linkDiv.innerHTML = `<span class="text-gray-400">ç›®å‰ç„¡é™„ä»¶</span>`; } } } catch(e) {} finally { btn.innerHTML = `<i class="fas fa-cloud-download-alt mr-1"></i> è¼‰å…¥è³‡æ–™`; btn.disabled = false; } }
        async function saveBulletin() { const content = document.getElementById('bulletin-content').value; const fileInput = document.getElementById('bulletin-file'); const file = fileInput.files[0]; if(!content.trim() && !file) return alert("è«‹è¼¸å…¥è¯çµ¡ç°¿å…§å®¹ï¼Œæˆ–æ˜¯é¸æ“‡ä¸Šå‚³æª”æ¡ˆï¼"); const btn = document.getElementById('save-bulletin-btn'); btn.innerHTML = `<i class="fas fa-spinner fa-spin mr-2"></i> ä¸Šå‚³èˆ‡ç™¼å¸ƒä¸­...`; btn.disabled = true; let payload = { action: 'saveAnnouncement', date: datePicker.value, className: classSelect.value, content: content, teacherName: sessionStorage.getItem('username') }; if (file) { if (file.size > 5 * 1024 * 1024) { alert("æª”æ¡ˆè«‹å‹¿è¶…é 5MBï¼"); btn.innerHTML = `<i class="fas fa-paper-plane mr-2"></i> ç™¼å¸ƒ / æ›´æ–°å…¬å‘Š`; btn.disabled = false; return; } const reader = new FileReader(); reader.onload = async function(e) { payload.fileData = e.target.result.split(',')[1]; payload.fileName = file.name; payload.mimeType = file.type; await sendBulletinRequest(payload, btn); }; reader.readAsDataURL(file); } else { await sendBulletinRequest(payload, btn); } }
        async function sendBulletinRequest(payload, btn) { try { const res = await fetch(API_URL, { method: 'POST', body: JSON.stringify(payload) }); const result = await res.json(); if(result.success) { alert('ğŸ‰ ç™¼å¸ƒæˆåŠŸï¼'); document.getElementById('bulletin-file').value = ''; loadBulletin(); } else alert('å¤±æ•—ï¼š'+result.message); } catch(e){ alert("é€£ç·šç•°å¸¸"); } finally { btn.innerHTML = `<i class="fas fa-paper-plane mr-2"></i> ç™¼å¸ƒ / æ›´æ–°å…¬å‘Š`; btn.disabled = false; } }
        function logout() { sessionStorage.clear(); window.location.href = 'login.html'; }
    </script>
</body>
</html>
