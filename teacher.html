<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è€å¸«æ§åˆ¶å° - ä¸Šèª²èˆ‡æˆç¸¾ç™»è¨˜</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        input:disabled, select:disabled {
            background-color: transparent; border-color: transparent;
            color: #374151; cursor: default; appearance: none;
        }
        input:disabled:focus, select:disabled:focus { outline: none; box-shadow: none; }
    </style>
</head>
<body class="bg-gray-100 flex h-screen overflow-hidden font-sans">

    <aside class="w-64 bg-gray-800 text-white flex flex-col hidden md:flex">
        <div class="p-6 text-center border-b border-gray-700">
            <h2 class="text-2xl font-bold text-blue-400">ç³»çµ±ç®¡ç†</h2>
            <p id="teacher-name-display" class="text-sm text-gray-400 mt-2">è€å¸«æ§åˆ¶å°</p>
        </div>
        <nav class="flex-1 p-4 space-y-2">
            <a href="#" class="block px-4 py-2 bg-blue-600 rounded-lg text-white font-medium">
                <i class="fas fa-edit mr-2"></i> ç™»è¨˜ç‹€æ³èˆ‡æˆç¸¾
            </a>
        </nav>
        <div class="p-4 border-t border-gray-700">
            <button onclick="logout()" class="w-full py-2 text-sm text-red-400 border border-red-400 rounded hover:bg-red-400 hover:text-white transition">
                <i class="fas fa-sign-out-alt mr-1"></i>ç™»å‡ºç³»çµ±
            </button>
        </div>
    </aside>

    <main class="flex-1 flex flex-col h-screen overflow-hidden">
        <div class="flex-1 overflow-y-auto p-4 md:p-8">
            
            <div class="flex mb-6 bg-gray-200 rounded-lg p-1 max-w-md">
                <button id="tab-attendance" onclick="switchMode('attendance')" class="flex-1 py-2 text-center rounded-md bg-white shadow text-blue-600 font-bold transition-all">
                    <i class="fas fa-user-check mr-1"></i> å‡ºç¼ºå¸­èˆ‡è©•èª
                </button>
                <button id="tab-score" onclick="switchMode('score')" class="flex-1 py-2 text-center rounded-md text-gray-500 hover:text-gray-700 font-bold transition-all">
                    <i class="fas fa-marker mr-1"></i> è€ƒè©¦æˆç¸¾ç™»è¨˜
                </button>
            </div>

            <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200 mb-6">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">æ—¥æœŸ</label>
                        <input type="date" id="datePicker" class="w-full border-gray-300 border rounded-lg p-2 focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">ç­ç´š</label>
                        <select id="classSelect" class="w-full border-gray-300 border rounded-lg p-2 focus:ring-2 focus:ring-blue-500"></select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">ç§‘ç›®</label>
                        <select id="subjectSelect" class="w-full border-gray-300 border rounded-lg p-2 focus:ring-2 focus:ring-blue-500"></select>
                    </div>
                    <div id="examNameContainer" class="hidden">
                        <label class="block text-sm font-bold text-blue-600 mb-1">è€ƒè©¦åç¨± (å¿…å¡«)</label>
                        <input type="text" id="examNameInput" placeholder="ä¾‹: ç¬¬ä¸€å–®å…ƒå°è€ƒ" class="w-full border-blue-300 border-2 rounded-lg p-2 focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <button id="load-students-btn" onclick="loadStudentList()" class="w-full bg-blue-600 text-white font-medium py-2 rounded-lg hover:bg-blue-700 transition shadow">
                            <i class="fas fa-cloud-download-alt mr-1"></i> è¼‰å…¥åå–®
                        </button>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full text-left border-collapse">
                        <thead class="bg-gray-50 border-b border-gray-200" id="tableHeader">
                            </thead>
                        <tbody id="studentTableBody" class="divide-y divide-gray-100">
                            <tr><td colspan="6" class="text-center py-8 text-gray-400">è«‹å…ˆé¸æ“‡æ¢ä»¶ä¸¦è¼‰å…¥è³‡æ–™</td></tr>
                        </tbody>
                    </table>
                </div>
                <div class="bg-gray-50 p-4 border-t border-gray-200 flex justify-end">
                    <button id="batch-save-btn" onclick="batchSave()" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-lg shadow transition flex items-center hidden">
                        <i class="fas fa-bolt mr-2"></i> æ¥µé€Ÿä¸€éµå„²å­˜
                    </button>
                </div>
            </div>
        </div>
    </main>

    <script>
        const API_URL = "https://script.google.com/macros/s/AKfycbwunBwJT2u3gpAcnibQW4RBOQhuzQXLtcirT4_6G6fG9FgwJjTAApax5fU0VZ1dNvdRog/exec";

        if (!sessionStorage.getItem('isLoggedIn') || sessionStorage.getItem('userRole') !== 'teacher') {
            alert('æ¬Šé™ä¸è¶³ï¼Œè«‹å…ˆä»¥è€å¸«èº«åˆ†ç™»å…¥ï¼');
            window.location.href = 'login.html';
        }

        // åˆå§‹åŒ–
        let currentMode = 'attendance'; // 'attendance' æˆ– 'score'
        let studentData = [];
        document.getElementById('datePicker').valueAsDate = new Date();
        document.getElementById('teacher-name-display').innerText = sessionStorage.getItem('username') + " è€å¸«";

        // å‹•æ…‹è¼‰å…¥è€å¸«çš„ç­ç´šèˆ‡ç§‘ç›®
        const classes = JSON.parse(sessionStorage.getItem('teacherClasses') || "[]");
        const subjects = JSON.parse(sessionStorage.getItem('teacherSubjects') || "[]");
        
        const classSelect = document.getElementById('classSelect');
        const subjectSelect = document.getElementById('subjectSelect');
        classes.forEach(c => classSelect.add(new Option(c, c)));
        subjects.forEach(s => subjectSelect.add(new Option(s, s)));

        // åˆ‡æ›æ¨¡å¼ (å‡ºç¼ºå¸­ vs æˆç¸¾)
        function switchMode(mode) {
            currentMode = mode;
            studentData = []; // æ¸…ç©ºè³‡æ–™
            document.getElementById('studentTableBody').innerHTML = '<tr><td colspan="6" class="text-center py-8 text-gray-400">è«‹é‡æ–°è¼‰å…¥åå–®</td></tr>';
            document.getElementById('batch-save-btn').classList.add('hidden');

            const tabAtt = document.getElementById('tab-attendance');
            const tabScore = document.getElementById('tab-score');
            const examContainer = document.getElementById('examNameContainer');

            if (mode === 'attendance') {
                tabAtt.className = "flex-1 py-2 text-center rounded-md bg-white shadow text-blue-600 font-bold transition-all";
                tabScore.className = "flex-1 py-2 text-center rounded-md text-gray-500 hover:text-gray-700 font-bold transition-all";
                examContainer.classList.add('hidden');
            } else {
                tabScore.className = "flex-1 py-2 text-center rounded-md bg-white shadow text-blue-600 font-bold transition-all";
                tabAtt.className = "flex-1 py-2 text-center rounded-md text-gray-500 hover:text-gray-700 font-bold transition-all";
                examContainer.classList.remove('hidden');
            }
            renderTableHeader();
        }

        function renderTableHeader() {
            const tr = document.createElement('tr');
            let html = `<th class="p-4 text-sm font-semibold text-gray-600 w-24">å­¸è™Ÿ</th>
                        <th class="p-4 text-sm font-semibold text-gray-600 w-32">å§“å</th>`;
            if (currentMode === 'attendance') {
                html += `<th class="p-4 text-sm font-semibold text-gray-600 w-32">å‡ºå¸­ç‹€æ…‹</th>
                         <th class="p-4 text-sm font-semibold text-gray-600">ä¸Šèª²ç‹€æ³è©•èª</th>`;
            } else {
                html += `<th class="p-4 text-sm font-semibold text-gray-600">è€ƒè©¦æˆç¸¾</th>`;
            }
            html += `<th class="p-4 text-sm font-semibold text-gray-600 text-center w-32">æ“ä½œ</th>`;
            tr.innerHTML = html;
            document.getElementById('tableHeader').innerHTML = '';
            document.getElementById('tableHeader').appendChild(tr);
        }
        renderTableHeader(); // åˆå§‹åŒ–è¡¨é ­

        // è¼‰å…¥åå–® API
        async function loadStudentList() {
            const date = document.getElementById('datePicker').value;
            const className = document.getElementById('classSelect').value;
            const subject = document.getElementById('subjectSelect').value;
            const examName = document.getElementById('examNameInput').value;

            if (currentMode === 'score' && !examName.trim()) {
                alert("è«‹å…ˆå¡«å¯«ã€Œè€ƒè©¦åç¨±ã€æ‰èƒ½è¼‰å…¥æˆç¸¾è¡¨å–”ï¼");
                return;
            }

            const loadBtn = document.getElementById('load-students-btn');
            const originalText = loadBtn.innerHTML;
            loadBtn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> è¼‰å…¥ä¸­`;
            loadBtn.disabled = true;

            const actionName = currentMode === 'attendance' ? 'loadAttendance' : 'loadScores';

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    body: JSON.stringify({ action: actionName, date, className, subject, examName })
                });
                const result = await response.json();

                if (result.success) {
                    studentData = result.data;
                    renderTable();
                    document.getElementById('batch-save-btn').classList.remove('hidden');
                } else {
                    alert('âŒ è¼‰å…¥å¤±æ•—ï¼š' + result.message);
                }
            } catch (error) {
                alert('é€£ç·šå¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯ç‹€æ…‹ã€‚');
            } finally {
                loadBtn.innerHTML = originalText;
                loadBtn.disabled = false;
            }
        }

        // æ¸²æŸ“è¡¨æ ¼å…§å®¹
        function renderTable() {
            const tbody = document.getElementById('studentTableBody');
            tbody.innerHTML = '';
            if(studentData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center py-8 text-gray-400">æ­¤ç­ç´šç„¡å­¸ç”Ÿè³‡æ–™</td></tr>';
                return;
            }

            studentData.forEach((student, index) => {
                const disabled = student.isSaved ? 'disabled' : '';
                const rowClass = student.isSaved ? 'bg-gray-100' : 'bg-white';
                const actionBtn = student.isSaved 
                    ? `<button onclick="toggleEdit(${index})" class="text-gray-500 hover:text-blue-600 px-3 py-1 rounded"><i class="fas fa-pencil-alt"></i></button>`
                    : `<button onclick="toggleEdit(${index})" class="text-blue-400 px-3 py-1 cursor-default"><i class="fas fa-pen"></i></button>`;

                let tr = document.createElement('tr');
                tr.className = `hover:bg-blue-50 transition ${rowClass}`;
                let html = `<td class="p-4 text-sm font-mono">${student.studentId}</td>
                            <td class="p-4 text-sm font-bold">${student.name}</td>`;
                
                if (currentMode === 'attendance') {
                    html += `
                    <td class="p-4">
                        <select id="att-${index}" class="w-full border rounded p-1 text-sm focus:border-blue-500" ${disabled}>
                            <option value="present" ${student.attendance === 'present' ? 'selected' : ''}>âœ… æ­£å¸¸</option>
                            <option value="late" ${student.attendance === 'late' ? 'selected' : ''}>âš ï¸ é²åˆ°</option>
                            <option value="absent" ${student.attendance === 'absent' ? 'selected' : ''}>âŒ ç¼ºå¸­</option>
                        </select>
                    </td>
                    <td class="p-4"><input type="text" id="com-${index}" value="${student.comment}" placeholder="è©•èª" class="w-full border rounded p-1 text-sm focus:border-blue-500" ${disabled}></td>`;
                } else {
                    html += `<td class="p-4"><input type="number" id="sco-${index}" value="${student.score}" placeholder="åˆ†æ•¸" class="w-full border rounded p-1 text-sm focus:border-blue-500" ${disabled}></td>`;
                }
                
                html += `<td class="p-4 text-center">${actionBtn}</td>`;
                tr.innerHTML = html;
                tbody.appendChild(tr);
            });
        }

        function toggleEdit(index) {
            syncData(); studentData[index].isSaved = false; renderTable(); 
        }

        function syncData() {
            studentData.forEach((st, i) => {
                if (!st.isSaved) {
                    if (currentMode === 'attendance') {
                        let attEl = document.getElementById(`att-${i}`);
                        let comEl = document.getElementById(`com-${i}`);
                        if(attEl) st.attendance = attEl.value;
                        if(comEl) st.comment = comEl.value;
                    } else {
                        let scoEl = document.getElementById(`sco-${i}`);
                        if(scoEl) st.score = scoEl.value;
                    }
                }
            });
        }

        // æ‰¹æ¬¡å„²å­˜
        async function batchSave() {
            syncData();
            const records = [];
            const date = document.getElementById('datePicker').value;
            const className = document.getElementById('classSelect').value;
            const subject = document.getElementById('subjectSelect').value;
            const examName = document.getElementById('examNameInput').value;

            studentData.forEach((st, i) => { 
                if (!st.isSaved) {
                    if(currentMode === 'attendance') {
                        records.push({ date, className, subject, studentId: st.studentId, name: st.name, attendance: st.attendance, comment: st.comment });
                    } else {
                        records.push({ date, className, subject, examName, studentId: st.studentId, name: st.name, score: st.score });
                    }
                }
            });

            if (records.length === 0) { alert('æ²’æœ‰éœ€è¦å„²å­˜çš„è®Šæ›´ï¼'); return; }

            const btn = document.getElementById('batch-save-btn');
            btn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> å„²å­˜ä¸­...`; btn.disabled = true;
            const actionName = currentMode === 'attendance' ? 'batchSaveAttendance' : 'batchSaveScores';

            try {
                const response = await fetch(API_URL, {
                    method: 'POST', headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    body: JSON.stringify({ action: actionName, records: records })
                });
                const result = await response.json();
                if (result.success) {
                    studentData.forEach(st => st.isSaved = true);
                    renderTable();
                    alert('ğŸ‰ å„²å­˜æˆåŠŸï¼');
                } else alert('âŒ å¤±æ•—ï¼š' + result.message);
            } catch (error) { alert('é€£ç·šç•°å¸¸ã€‚'); }
            btn.innerHTML = `<i class="fas fa-bolt mr-2"></i> æ¥µé€Ÿä¸€éµå„²å­˜`; btn.disabled = false;
        }

        function logout() { sessionStorage.clear(); window.location.href = 'login.html'; }
    </script>
</body>
</html>