<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è€å¸«æ§åˆ¶å° - ä¸Šèª²ç‹€æ³èˆ‡æˆç¸¾ç®¡ç†</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        /* è‡ªè¨‚ï¼šç•¶è¼¸å…¥æ¡†è¢«ç¦ç”¨(é–å®š)æ™‚çš„æ¨£å¼ */
        input:disabled, select:disabled {
            background-color: transparent;
            border-color: transparent;
            color: #374151;
            cursor: default;
            appearance: none; /* éš±è—ä¸‹æ‹‰é¸å–®ç®­é ­ */
        }
        input:disabled:focus, select:disabled:focus {
            outline: none;
            box-shadow: none;
        }
    </style>
</head>
<body class="bg-gray-100 flex h-screen overflow-hidden font-sans">

    <aside class="w-64 bg-gray-800 text-white flex flex-col hidden md:flex">
        <div class="p-6 text-center border-b border-gray-700">
            <h2 class="text-2xl font-bold text-blue-400">ç³»çµ±ç®¡ç†</h2>
            <p class="text-sm text-gray-400 mt-2">è€å¸«æ§åˆ¶å°</p>
        </div>
        <nav class="flex-1 p-4 space-y-2">
            <a href="#" class="block px-4 py-2 bg-blue-600 rounded-lg text-white font-medium">
                <i class="fas fa-edit mr-2"></i> ç™»è¨˜ç‹€æ³èˆ‡æˆç¸¾
            </a>
            <a href="#" class="block px-4 py-2 text-gray-300 hover:bg-gray-700 rounded-lg transition">
                <i class="fas fa-users mr-2"></i> å­¸ç”Ÿåå–®ç®¡ç†
            </a>
            <a href="#" class="block px-4 py-2 text-gray-300 hover:bg-gray-700 rounded-lg transition">
                <i class="fas fa-history mr-2"></i> æ­·å²ç´€éŒ„æŸ¥è©¢
            </a>
        </nav>
        <div class="p-4 border-t border-gray-700">
            <div class="flex items-center mb-4">
                <div class="w-8 h-8 rounded-full bg-blue-500 flex items-center justify-center mr-3">
                    <i class="fas fa-chalkboard-teacher text-white"></i>
                </div>
                <div>
                    <p class="text-sm font-medium">ç‹å¤§æ˜ è€å¸«</p>
                </div>
            </div>
            <button onclick="logout()" class="w-full py-2 text-sm text-red-400 border border-red-400 rounded hover:bg-red-400 hover:text-white transition">
                ç™»å‡ºç³»çµ±
            </button>
        </div>
    </aside>

    <main class="flex-1 flex flex-col h-screen overflow-hidden">
        
        <header class="bg-white shadow-sm p-4 flex justify-between items-center md:hidden">
            <h1 class="text-xl font-bold text-gray-800">ç™»è¨˜ç‹€æ³èˆ‡æˆç¸¾</h1>
            <button class="text-gray-600 focus:outline-none"><i class="fas fa-bars text-xl"></i></button>
        </header>

        <div class="flex-1 overflow-y-auto p-4 md:p-8">
            <h1 class="text-2xl font-bold text-gray-800 hidden md:block mb-6">ğŸ“ ç™»è¨˜ä¸Šèª²ç‹€æ³èˆ‡æˆç¸¾</h1>

            <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200 mb-6">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">æ—¥æœŸ</label>
                        <input type="date" id="datePicker" class="w-full border-gray-300 border rounded-lg p-2 focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">ç­ç´š / èª²ç¨‹</label>
                            <select id="courseSelect" class="w-full border-gray-300 border rounded-lg p-2 focus:ring-2 focus:ring-blue-500">
                                <option value="æ•¸å­¸">ä¸‰å¹´äºŒç­ - æ•¸å­¸</option>
                                <option value="è‹±æ–‡">ä¸‰å¹´äºŒç­ - è‹±æ–‡</option>
                            </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">è€ƒè©¦åç¨± (é¸å¡«)</label>
                        <input type="text" placeholder="ä¾‹å¦‚ï¼šç¬¬ä¸€å–®å…ƒå°è€ƒ" class="w-full border-gray-300 border rounded-lg p-2 focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <button id="load-students-btn" onclick="loadStudentList()" class="w-full bg-blue-100 text-blue-700 font-medium py-2 rounded-lg hover:bg-blue-200 transition">
    														<i class="fas fa-download mr-1"></i> è¼‰å…¥å­¸ç”Ÿåå–®
												</button>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full text-left border-collapse">
                        <thead class="bg-gray-50 border-b border-gray-200">
                            <tr>
                                <th class="p-4 text-sm font-semibold text-gray-600">å­¸è™Ÿ</th>
                                <th class="p-4 text-sm font-semibold text-gray-600">å§“å</th>
                                <th class="p-4 text-sm font-semibold text-gray-600 w-32">å‡ºå¸­ç‹€æ…‹</th>
                                <th class="p-4 text-sm font-semibold text-gray-600 w-1/3">ä¸Šèª²ç‹€æ³è©•èª</th>
                                <th class="p-4 text-sm font-semibold text-gray-600 w-24">è€ƒè©¦æˆç¸¾</th>
                                <th class="p-4 text-sm font-semibold text-gray-600 text-center w-32">æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="studentTableBody" class="divide-y divide-gray-100">
                            </tbody>
                    </table>
                </div>
                
                <div class="bg-gray-50 p-4 border-t border-gray-200 flex justify-end">
                    <button onclick="batchSave()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg shadow transition flex items-center">
                        <i class="fas fa-save mr-2"></i> å…¨ç­ä¸€éµå„²å­˜
                    </button>
                </div>
            </div>
        </div>
    </main>

    <script>
        // 1. è«‹å¡«å…¥æ‚¨å‰›å‰›éƒ¨ç½²çš„ Google Apps Script API ç¶²å€
const API_URL = "https://script.google.com/macros/s/AKfycbwBG1mN0Ys5G8WDXPNOMLLO_MGeCLx9Cpap1jXXvEePZQN34cpzIj44T2n-nY3X0S9VPg/exec";

// ğŸ›¡ï¸ æ–°å¢ï¼šå®‰å…¨é˜²è­·æª¢æŸ¥ (ç¢ºä¿åªæœ‰è€å¸«å¯ä»¥é€²å…¥æ­¤é é¢)
if (!sessionStorage.getItem('isLoggedIn') || sessionStorage.getItem('userRole') !== 'teacher') {
    alert('æ¬Šé™ä¸è¶³ï¼Œè«‹å…ˆä»¥è€å¸«èº«åˆ†ç™»å…¥ï¼');
    window.location.href = 'login.html';
}

// è¨­å®šä»Šæ—¥æ—¥æœŸç‚ºé è¨­å€¼
document.getElementById('datePicker').valueAsDate = new Date();

// æ¨¡æ“¬å­¸ç”Ÿåå–® (å¯¦å‹™ä¸Šé€™è£¡ä¹Ÿæœƒå¯«ä¸€å€‹ API å»è·Ÿå¾Œç«¯è¦åå–®ï¼Œç›®å‰å…ˆç”¨é è¨­å€¼)
let studentData = [];

// ğŸ”¥ æ–°å¢ï¼šå‹•æ…‹è¼‰å…¥å­¸ç”Ÿåå–® API é‚è¼¯
async function loadStudentList() {
    const loadBtn = document.getElementById('load-students-btn');
    const originalText = loadBtn.innerHTML;
    
    // æ”¹è®ŠæŒ‰éˆ•ç‹€æ…‹ç‚ºè¼‰å…¥ä¸­
    loadBtn.innerHTML = `<i class="fas fa-spinner fa-spin mr-1"></i> è¼‰å…¥ä¸­...`;
    loadBtn.disabled = true;

    try {
        const response = await fetch(API_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'text/plain;charset=utf-8' },
            body: JSON.stringify({ action: 'getStudents' })
        });

        const result = await response.json();

        if (result.success) {
            // å°‡å¾Œç«¯å‚³ä¾†çš„ç´”åå–®ï¼Œè½‰æ›ç‚ºè¡¨æ ¼éœ€è¦çš„è³‡æ–™çµæ§‹
            studentData = result.data.map((student, index) => ({
                id: index,
                studentId: student.studentId,
                name: student.name,
                attendance: 'present', // é è¨­å…¨éƒ¨æ­£å¸¸å‡ºå¸­
                comment: '',
                score: '',
                isSaved: false // é è¨­ç‚ºå°šæœªå„²å­˜
            }));
            
            renderTable(); // é‡æ–°ç•«å‡ºè¡¨æ ¼
            
        } else {
            alert('âŒ è¼‰å…¥å¤±æ•—ï¼š' + result.message);
        }
    } catch (error) {
        console.error('API é€£ç·šéŒ¯èª¤:', error);
        alert('ç³»çµ±é€£ç·šç•°å¸¸ï¼Œç„¡æ³•è¼‰å…¥åå–®ã€‚');
    } finally {
        // æ¢å¾©æŒ‰éˆ•ç‹€æ…‹
        loadBtn.innerHTML = originalText;
        loadBtn.disabled = false;
    }
}

// æ¸²æŸ“è¡¨æ ¼ (åŠ å…¥æŒ‰éˆ• ID ä»¥ä¾¿æ§åˆ¶è®€å–ç‹€æ…‹)
function renderTable() {
    const tbody = document.getElementById('studentTableBody');
    tbody.innerHTML = '';

    studentData.forEach((student, index) => {
        const disabledAttr = student.isSaved ? 'disabled' : '';
        const rowClass = student.isSaved ? 'bg-gray-50' : 'bg-white';
        
        const actionButton = student.isSaved 
            ? `<button onclick="toggleEdit(${index})" class="text-gray-500 hover:text-blue-600 px-3 py-1 border border-transparent hover:border-blue-200 rounded transition"><i class="fas fa-pencil-alt"></i> ä¿®æ”¹</button>`
            : `<button id="save-btn-${index}" onclick="saveRow(${index})" class="text-green-600 hover:text-green-700 px-3 py-1 bg-green-50 border border-green-200 rounded transition font-medium"><i class="fas fa-check"></i> å„²å­˜</button>`;

        const tr = document.createElement('tr');
        tr.className = `hover:bg-blue-50 transition ${rowClass}`;
        tr.innerHTML = `
            <td class="p-4 text-sm text-gray-700">${student.studentId}</td>
            <td class="p-4 text-sm font-medium text-gray-900">${student.name}</td>
            <td class="p-4">
                <select id="att-${index}" class="w-full border border-gray-300 rounded p-1 text-sm focus:border-blue-500" ${disabledAttr}>
                    <option value="present" ${student.attendance === 'present' ? 'selected' : ''}>âœ… æ­£å¸¸</option>
                    <option value="late" ${student.attendance === 'late' ? 'selected' : ''}>âš ï¸ é²åˆ°</option>
                    <option value="absent" ${student.attendance === 'absent' ? 'selected' : ''}>âŒ ç¼ºå¸­</option>
                </select>
            </td>
            <td class="p-4">
                <input type="text" id="com-${index}" value="${student.comment}" placeholder="è¼¸å…¥è©•èª..." class="w-full border border-gray-300 rounded p-1 text-sm focus:border-blue-500 focus:ring-1 focus:ring-blue-500" ${disabledAttr}>
            </td>
            <td class="p-4">
                <input type="number" id="sco-${index}" value="${student.score}" placeholder="åˆ†æ•¸" min="0" max="100" class="w-full border border-gray-300 rounded p-1 text-sm text-center focus:border-blue-500 focus:ring-1 focus:ring-blue-500" ${disabledAttr}>
            </td>
            <td class="p-4 text-center">
                ${actionButton}
            </td>
        `;
        tbody.appendChild(tr);
    });
}

function toggleEdit(index) {
    studentData[index].isSaved = false;
    renderTable(); 
}

// ğŸ”¥ çœŸæ­£çš„å„²å­˜é‚è¼¯ï¼šç™¼é€è³‡æ–™åˆ° Google Sheets
async function saveRow(index) {
    // 1. æŠ“å–ç•«é¢ä¸Šè¼¸å…¥çš„å€¼èˆ‡å¤–éƒ¨æ¢ä»¶ (æ—¥æœŸã€èª²ç¨‹)
    const attendance = document.getElementById(`att-${index}`).value;
    const comment = document.getElementById(`com-${index}`).value;
    const score = document.getElementById(`sco-${index}`).value;
    const date = document.getElementById('datePicker').value;
    const course = document.getElementById('courseSelect').value;
    const student = studentData[index];

    // 2. æ”¹è®ŠæŒ‰éˆ•ç‹€æ…‹ç‚ºã€Œå„²å­˜ä¸­ã€é˜²æ­¢é‡è¤‡é»æ“Š
    const saveBtn = document.getElementById(`save-btn-${index}`);
    const originalText = saveBtn.innerHTML;
    saveBtn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> å„²å­˜ä¸­`;
    saveBtn.disabled = true;

    // 3. çµ„åˆè¦ç™¼é€çµ¦ API çš„ JSON è³‡æ–™çµæ§‹
    const payload = {
        action: 'saveRecord',
        recordData: {
            date: date,
            course: course,
            studentId: student.studentId,
            name: student.name,
            attendance: attendance,
            comment: comment,
            score: score
        }
    };

    try {
        // 4. ç™¼é€è«‹æ±‚åˆ° Google Apps Script
        const response = await fetch(API_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'text/plain;charset=utf-8' },
            body: JSON.stringify(payload)
        });

        const result = await response.json();

        if (result.success) {
            // å¯«å…¥è©¦ç®—è¡¨æˆåŠŸï¼æ›´æ–°å‰ç«¯ç•«é¢ç‹€æ…‹ç‚ºé–å®š
            studentData[index].attendance = attendance;
            studentData[index].comment = comment;
            studentData[index].score = score;
            studentData[index].isSaved = true;

            renderTable(); // é‡æ–°æ¸²æŸ“æˆå”¯è®€ç°è‰²èƒŒæ™¯
            
            // é¡¯ç¤ºæˆåŠŸæç¤º
            alert(`âœ… ${student.name} çš„ç´€éŒ„å·²æˆåŠŸå¯«å…¥ Google è©¦ç®—è¡¨ï¼`);
        } else {
            alert('âŒ å„²å­˜å¤±æ•—ï¼š' + result.message);
            saveBtn.innerHTML = originalText;
            saveBtn.disabled = false;
        }
    } catch (error) {
        console.error('API é€£ç·šéŒ¯èª¤:', error);
        alert('é€£ç·šå¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯ç‹€æ…‹æˆ–ç¢ºèª API ç¶²å€æ˜¯å¦æ­£ç¢ºã€‚');
        saveBtn.innerHTML = originalText;
        saveBtn.disabled = false;
    }
}

// å…¨ç­ä¸€éµå„²å­˜åŠŸèƒ½ (æ‰¹æ¬¡å‘¼å«)
async function batchSave() {
    const unsavedIndexes = [];
    studentData.forEach((student, index) => {
        if (!student.isSaved) unsavedIndexes.push(index);
    });

    if (unsavedIndexes.length === 0) {
        alert('ç›®å‰æ²’æœ‰éœ€è¦å„²å­˜çš„è³‡æ–™ï¼');
        return;
    }

    // ä¾åºåŸ·è¡Œå„²å­˜å‹•ä½œ
    for (let index of unsavedIndexes) {
        await saveRow(index);
    }
    alert('ğŸ‰ å…¨ç­ç´€éŒ„å·²æˆåŠŸæ‰¹æ¬¡å¯«å…¥è©¦ç®—è¡¨ï¼');
}

function logout() {
    sessionStorage.clear(); // æ¸…é™¤ç™»å…¥ç‹€æ…‹
    alert("å·²ç™»å‡ºç³»çµ±ï¼");
    window.location.href = 'login.html'; // å°å›ç™»å…¥é 
}

    </script>
</body>
</html>