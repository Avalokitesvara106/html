<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¹¹éƒ¨å°ˆå€ - ç­ç´šç®¡ç†ç³»çµ±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body class="bg-gray-50 font-sans pb-12">

    <header class="bg-gradient-to-r from-blue-600 to-indigo-700 text-white shadow-md rounded-b-3xl pb-6">
        <div class="p-4 flex justify-between items-center">
            <h1 class="text-lg font-bold"><i class="fas fa-shield-alt mr-2"></i>å¹¹éƒ¨ç®¡ç†å°ˆå€</h1>
            <button onclick="logout()" class="text-blue-100 hover:text-white text-sm bg-white/20 px-3 py-1 rounded-full backdrop-blur-sm transition">
                <i class="fas fa-sign-out-alt"></i> ç™»å‡º
            </button>
        </div>
        <div class="px-6 flex items-center mt-2">
            <div class="w-16 h-16 bg-white rounded-full flex items-center justify-center text-indigo-600 text-3xl font-bold border-4 border-indigo-300 shadow-sm">
                <i class="fas fa-user-shield"></i>
            </div>
            <div class="ml-4 flex-1">
                <p class="text-blue-100 text-sm mb-1"><span id="display-class" class="font-bold"></span> ç­ç´šå¹¹éƒ¨</p>
                <div class="flex items-center">
                    <h2 class="text-2xl font-bold mr-2" id="display-name">è¼‰å…¥ä¸­...</h2>
                    <span id="display-title" class="bg-yellow-400 text-yellow-900 text-xs font-extrabold px-2 py-1 rounded-md shadow-sm">è·ç¨±</span>
                </div>
            </div>
        </div>
    </header>

    <main class="max-w-md mx-auto mt-6 px-4">
        
        <div class="bg-white rounded-xl shadow-sm p-4 mb-6 flex justify-between items-center border border-gray-100">
            <h3 class="font-bold text-gray-700"><i class="far fa-calendar-alt text-blue-500 mr-2"></i>ä½œæ¥­æ—¥æœŸ</h3>
            <input type="date" id="work-date" class="bg-gray-50 border border-gray-300 text-gray-800 text-sm rounded-lg p-2 focus:ring-2 focus:ring-blue-500 outline-none font-bold">
        </div>

        <div class="flex flex-wrap gap-2 mb-6" id="module-tabs">
            <button onclick="switchTab('common')" id="tab-common" class="flex-1 min-w-[45%] py-2.5 bg-blue-600 text-white rounded-xl shadow-md font-bold text-sm transition-all transform scale-105">
                <i class="fas fa-clipboard-check mr-1"></i> ç‰©å“ç¹³äº¤
            </button>
            <button onclick="switchTab('academic')" id="tab-academic" class="hidden flex-1 min-w-[45%] py-2.5 bg-white text-gray-500 hover:bg-gray-50 rounded-xl border border-gray-200 font-bold text-sm transition-all">
                <i class="fas fa-book-open mr-1"></i> è¯çµ¡ç°¿
            </button>
            <button onclick="switchTab('hygiene')" id="tab-hygiene" class="hidden flex-1 min-w-[45%] py-2.5 bg-white text-gray-500 hover:bg-gray-50 rounded-xl border border-gray-200 font-bold text-sm transition-all">
                <i class="fas fa-broom mr-1"></i> æ‰“æƒæ ¸å¯¦
            </button>
            <button onclick="switchTab('it')" id="tab-it" class="hidden flex-1 min-w-[45%] py-2.5 bg-white text-gray-500 hover:bg-gray-50 rounded-xl border border-gray-200 font-bold text-sm transition-all">
                <i class="fas fa-mobile-alt mr-1"></i> æ‰‹æ©Ÿç¹³äº¤
            </button>
            <button onclick="switchTab('discipline')" id="tab-discipline" class="hidden flex-1 min-w-[45%] py-2.5 bg-white text-gray-500 hover:bg-gray-50 rounded-xl border border-gray-200 font-bold text-sm transition-all">
                <i class="fas fa-user-check mr-1"></i> å‡ºå¸­ç‹€æ³
            </button>
        </div>

        <section id="section-common" class="block">
            <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-5">
                <h3 class="font-bold text-gray-800 mb-3 border-b border-gray-100 pb-2"><i class="fas fa-clipboard-check mr-2"></i>å„é …ç‰©å“/å›æ¢ç¹³äº¤</h3>
                <div class="flex gap-2 mb-4">
                    <input type="text" id="common-item-name" placeholder="è¼¸å…¥ç‰©å“åç¨± (å¦‚: æˆ¶å¤–æ•™å­¸å›æ¢)" class="flex-1 bg-gray-50 border border-gray-300 rounded-lg p-2 text-sm outline-none focus:ring-2 focus:ring-blue-400">
                    <button id="btn-common-load" onclick="loadSubData('common')" class="bg-blue-100 text-blue-700 font-bold px-3 py-2 rounded-lg hover:bg-blue-200 text-sm whitespace-nowrap">è¼‰å…¥</button>
                </div>
                <div id="common-list" class="mb-4 max-h-[50vh] overflow-y-auto"><p class="text-center text-gray-400 text-sm py-4">è«‹è¼¸å…¥åç¨±ä¸¦è¼‰å…¥åå–®</p></div>
                <button id="btn-common-save" onclick="saveSubData('common')" class="hidden w-full bg-blue-600 text-white font-bold py-3 rounded-lg shadow-sm hover:bg-blue-700 transition"><i class="fas fa-save mr-2"></i> å„²å­˜ç¹³äº¤é€²åº¦</button>
            </div>
        </section>

        <section id="section-academic" class="hidden">
            <div class="bg-white rounded-xl shadow-sm border border-orange-100 p-5">
                <h3 class="font-bold text-orange-600 mb-4 border-b border-orange-100 pb-2"><i class="fas fa-pen-nib mr-2"></i>ç™¼å¸ƒç­ç´šè¯çµ¡ç°¿</h3>
                <textarea id="academic-content" rows="6" class="w-full bg-gray-50 border border-gray-200 rounded-lg p-3 text-sm focus:ring-2 focus:ring-orange-400 outline-none mb-4" placeholder="è«‹è¼¸å…¥ä»Šæ—¥ä½œæ¥­ã€æ˜æ—¥è€ƒè©¦èˆ‡æ”œå¸¶ç‰©å“..."></textarea>
                <button id="btn-academic-submit" onclick="submitAcademic()" class="w-full bg-orange-500 text-white font-bold py-3 rounded-lg shadow-sm hover:bg-orange-600 transition"><i class="fas fa-paper-plane mr-2"></i> ç™¼å¸ƒè‡³ç­ç´šçœ‹æ¿</button>
            </div>
        </section>

        <section id="section-hygiene" class="hidden">
            <div class="bg-white rounded-xl shadow-sm border border-teal-100 p-5">
                <div class="flex justify-between items-center mb-4 border-b border-teal-100 pb-2">
                    <h3 class="font-bold text-teal-600"><i class="fas fa-broom mr-2"></i>æ‰“æƒå·¥ä½œæ ¸å¯¦</h3>
                    <button id="btn-hygiene-load" onclick="loadSubData('hygiene')" class="bg-teal-50 text-teal-600 font-bold py-1.5 px-3 rounded-lg border border-teal-200 hover:bg-teal-100 text-sm">è¼‰å…¥åå–®</button>
                </div>
                <div id="hygiene-list" class="mb-4 max-h-[50vh] overflow-y-auto"><p class="text-center text-gray-400 text-sm py-4">è«‹è¼‰å…¥ç­ç´šåå–®</p></div>
                <button id="btn-hygiene-save" onclick="saveSubData('hygiene')" class="hidden w-full bg-teal-600 text-white font-bold py-3 rounded-lg shadow-sm hover:bg-teal-700 transition"><i class="fas fa-save mr-2"></i> å„²å­˜æ‰“æƒç´€éŒ„</button>
            </div>
        </section>

        <section id="section-it" class="hidden">
            <div class="bg-white rounded-xl shadow-sm border border-purple-100 p-5">
                <div class="flex justify-between items-center mb-4 border-b border-purple-100 pb-2">
                    <h3 class="font-bold text-purple-600"><i class="fas fa-mobile-alt mr-2"></i>æ‰‹æ©Ÿç¹³äº¤ç‹€æ³</h3>
                    <button id="btn-it-load" onclick="loadSubData('it')" class="bg-purple-50 text-purple-600 font-bold py-1.5 px-3 rounded-lg border border-purple-200 hover:bg-purple-100 text-sm">è¼‰å…¥åå–®</button>
                </div>
                <div id="it-list" class="mb-4 max-h-[50vh] overflow-y-auto"><p class="text-center text-gray-400 text-sm py-4">è«‹è¼‰å…¥ç­ç´šåå–®</p></div>
                <button id="btn-it-save" onclick="saveSubData('it')" class="hidden w-full bg-purple-600 text-white font-bold py-3 rounded-lg shadow-sm hover:bg-purple-700 transition"><i class="fas fa-save mr-2"></i> å„²å­˜æ‰‹æ©Ÿç¹³äº¤</button>
            </div>
        </section>

        <section id="section-discipline" class="hidden">
            <div class="bg-white rounded-xl shadow-sm border border-red-100 p-5">
                
                <div id="discipline-schedule-area">
                    <div class="flex justify-between items-center mb-3 border-b border-red-100 pb-2">
                        <h3 class="font-bold text-red-600"><i class="fas fa-list-alt mr-2"></i>é¸æ“‡é»åç¯€æ¬¡</h3>
                        <button onclick="fetchSchedule()" class="text-red-500 text-sm hover:text-red-700 font-bold"><i class="fas fa-sync-alt"></i> é‡æ–°æ•´ç†</button>
                    </div>
                    
                    <div id="schedule-list" class="flex flex-col gap-2 mb-4">
                        <p class="text-center text-gray-400 text-sm py-4">è®€å–èª²è¡¨ä¸­...</p>
                    </div>
                    
                    <div class="mt-4 pt-3 border-t border-gray-100 flex gap-2">
                        <input type="text" id="manual-period" placeholder="è‡ªè¨‚(å¦‚:ç¬¬9ç¯€)" class="flex-1 bg-gray-50 border border-gray-300 rounded px-2 py-1.5 text-sm outline-none">
                        <input type="text" id="manual-subject" placeholder="ç§‘ç›®åç¨±" class="flex-1 bg-gray-50 border border-gray-300 rounded px-2 py-1.5 text-sm outline-none">
                        <button onclick="startManualAttendance()" class="bg-red-50 text-red-600 px-3 py-1.5 rounded-lg border border-red-200 shadow-sm text-sm font-bold hover:bg-red-100">å»ºç«‹</button>
                    </div>
                </div>

                <div id="discipline-attendance-area" class="hidden">
                    <div class="flex justify-between items-center mb-4 border-b border-red-100 pb-2">
                        <h3 class="font-bold text-red-600"><i class="fas fa-user-clock mr-2"></i><span id="current-attendance-title">å‡ºç¼ºå¸­é»å</span></h3>
                        <button onclick="closeAttendanceArea()" class="bg-gray-100 text-gray-600 font-bold py-1 px-3 rounded-lg border border-gray-200 hover:bg-gray-200 text-sm shadow-sm">
                            <i class="fas fa-arrow-left mr-1"></i> è¿”å›èª²è¡¨
                        </button>
                    </div>
                    <div id="discipline-list" class="mb-4 max-h-[60vh] overflow-y-auto"></div>
                    <button id="btn-discipline-save" onclick="saveDiscipline()" class="hidden w-full bg-red-600 text-white font-bold py-3 rounded-lg shadow-sm hover:bg-red-700 transition flex justify-center items-center">
                        <i class="fas fa-save mr-2"></i> å„²å­˜å‡ºç¼ºå¸­ç´€éŒ„
                    </button>
                </div>

            </div>
        </section>

    </main>

    <script>
        // ğŸš¨ æ›¿æ›ç‚ºæ‚¨çš„ GAS ç¶²å€
        const API_URL = "https://script.google.com/macros/s/AKfycbwunBwJT2u3gpAcnibQW4RBOQhuzQXLtcirT4_6G6fG9FgwJjTAApax5fU0VZ1dNvdRog/exec";
        
        const isLoggedIn = sessionStorage.getItem('isLoggedIn');
        const userRole = sessionStorage.getItem('userRole');
        const stuName = sessionStorage.getItem('studentName');
        const stuClass = sessionStorage.getItem('studentClass');
        const cadreTitle = sessionStorage.getItem('cadreTitle') || ''; 

        if (!isLoggedIn || userRole !== 'cadre') {
            alert('è«‹å…ˆä»¥å¹¹éƒ¨èº«åˆ†ç™»å…¥ï¼'); window.location.href = 'login.html';
        }

        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('display-name').innerText = stuName || 'å¹¹éƒ¨';
            document.getElementById('display-class').innerText = stuClass || '';
            document.getElementById('display-title').innerText = cadreTitle || 'ä¸€èˆ¬å¹¹éƒ¨';

            const dateInput = document.getElementById('work-date');
            const today = new Date();
            dateInput.value = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;

            let defaultTab = 'common';
            if (cadreTitle.includes('å­¸è—')) { document.getElementById('tab-academic').classList.remove('hidden'); defaultTab = 'academic'; }
            if (cadreTitle.includes('è¡›ç”Ÿ')) { document.getElementById('tab-hygiene').classList.remove('hidden'); defaultTab = 'hygiene'; }
            if (cadreTitle.includes('è³‡è¨Š')) { document.getElementById('tab-it').classList.remove('hidden'); defaultTab = 'it'; }
            if (cadreTitle.includes('é¢¨ç´€')) { 
                document.getElementById('tab-discipline').classList.remove('hidden'); 
                defaultTab = 'discipline'; 
                fetchSchedule(); // é¢¨ç´€è‚¡é•·ä¸€é€²ä¾†å°±è‡ªå‹•æŠ“èª²è¡¨
            }
            switchTab(defaultTab);

            // ç›£è½æ—¥æœŸæ”¹è®Šï¼šè‡ªå‹•æ›´æ–°èª²è¡¨èˆ‡æ¸…ç©ºèˆŠè³‡æ–™
            dateInput.addEventListener('change', () => {
                if (cadreTitle.includes('é¢¨ç´€')) {
                    closeAttendanceArea(); 
                    fetchSchedule();
                }
                ['common', 'hygiene', 'it'].forEach(mode => {
                    document.getElementById(`${mode}-list`).innerHTML = '<p class="text-center text-gray-400 text-sm py-4">è«‹è¼‰å…¥ç­ç´šåå–®</p>';
                    document.getElementById(`btn-${mode}-save`).classList.add('hidden');
                });
            });
        });

        function switchTab(target) {
            const sections = ['common', 'academic', 'hygiene', 'it', 'discipline'];
            sections.forEach(sec => {
                const sectionEl = document.getElementById(`section-${sec}`);
                const tabEl = document.getElementById(`tab-${sec}`);
                if (!tabEl || tabEl.classList.contains('hidden')) return;

                if (sec === target) {
                    sectionEl.classList.remove('hidden'); sectionEl.classList.add('block');
                    tabEl.className = `flex-1 min-w-[45%] py-2.5 bg-blue-600 text-white rounded-xl shadow-md font-bold text-sm transition-all transform scale-105`;
                } else {
                    sectionEl.classList.remove('block'); sectionEl.classList.add('hidden');
                    tabEl.className = `flex-1 min-w-[45%] py-2.5 bg-white text-gray-500 hover:bg-gray-50 rounded-xl border border-gray-200 font-bold text-sm transition-all`;
                }
            });
        }
        function logout() { sessionStorage.clear(); window.location.href = 'login.html'; }

        // ==========================================
        // ğŸŸ¢ æ¨¡çµ„ï¼šé¢¨ç´€è‚¡é•· (èª²è¡¨èˆ‡é»å)
        // ==========================================
        let attendanceData = [];
        let currentPeriod = '';
        let currentSubject = '';

        // 1. æŠ“å–ç•¶æ—¥èª²è¡¨
        async function fetchSchedule() {
            const date = document.getElementById('work-date').value;
            const container = document.getElementById('schedule-list');
            container.innerHTML = '<p class="text-sm text-gray-500 text-center"><i class="fas fa-spinner fa-spin mr-1"></i> è®€å–èª²è¡¨ä¸­...</p>';
            
            try {
                const res = await fetch(API_URL, {
                    method: 'POST', body: JSON.stringify({ action: 'getSchedule', date: date, className: stuClass })
                });
                const result = await res.json();
                
                if (result.success) {
                    if (result.isWeekend) {
                        container.innerHTML = '<p class="text-sm text-gray-500 text-center py-2">ä»Šå¤©æ˜¯å‡æ—¥ï¼Œç„¡é è¨­èª²è¡¨ã€‚<br>è‹¥é‡è¿”æ ¡æ‰“æƒæˆ–è¼”å°èª²ï¼Œè«‹ä½¿ç”¨ä¸‹æ–¹ã€Œè‡ªè¨‚ç¯€æ¬¡ã€ã€‚</p>';
                    } else if (result.schedule.length === 0) {
                        container.innerHTML = `<p class="text-sm text-red-500 text-center">æŸ¥ç„¡ ${stuClass} ç­ä»Šæ—¥èª²è¡¨ï¼Œè«‹ç¢ºèªè³‡æ–™åº« ClassSchedule è¨­å®šã€‚</p>`;
                    } else {
                        let html = '';
                        result.schedule.forEach((item, index) => {
                            html += `
                            <div class="flex items-center justify-between bg-red-50 p-2.5 rounded-lg border border-red-100 shadow-sm">
                                <div class="font-bold text-red-700 w-16 text-sm text-center">${item.period}</div>
                                <div class="flex-1 px-2">
                                    <input type="text" id="subj-${index}" value="${item.subject}" class="w-full px-2 py-1.5 text-sm border border-gray-200 rounded outline-none focus:ring-2 focus:ring-red-400" title="å¯ç›´æ¥ä¿®æ”¹ä»¥æ‡‰å°èª¿èª²">
                                </div>
                                <button onclick="startAttendance('${item.period}', '${index}')" class="bg-red-500 text-white px-4 py-1.5 rounded-lg shadow-sm text-sm font-bold hover:bg-red-600 transition">
                                    <i class="fas fa-check-square"></i> é»å
                                </button>
                            </div>`;
                        });
                        container.innerHTML = html;
                    }
                } else {
                    container.innerHTML = `<p class="text-sm text-red-500 text-center">è®€å–å¤±æ•—ï¼š${result.message}</p>`;
                }
            } catch (e) { container.innerHTML = '<p class="text-sm text-red-500 text-center">ç¶²è·¯é€£ç·šç•°å¸¸</p>'; }
        }

        // 2. å•Ÿå‹•ç‰¹å®šç¯€æ¬¡çš„é»å
        function startManualAttendance() {
            const period = document.getElementById('manual-period').value.trim();
            const subject = document.getElementById('manual-subject').value.trim();
            if(!period || !subject) return alert('è«‹è¼¸å…¥è‡ªè¨‚çš„ç¯€æ¬¡èˆ‡ç§‘ç›®ï¼');
            startAttendance(period, subject, true); 
        }

        async function startAttendance(period, subjectOrIndex, isManual = false) {
            let subjectInput = isManual ? subjectOrIndex : (document.getElementById(`subj-${subjectOrIndex}`).value.trim() || 'æœªå®šç§‘ç›®');
            
            currentPeriod = period;
            currentSubject = subjectInput;
            const fullSubjectName = `${period} - ${currentSubject}`; // å¯«å…¥è³‡æ–™åº«çš„æ ¼å¼

            // åˆ‡æ›ç•«é¢
            document.getElementById('current-attendance-title').innerText = fullSubjectName;
            document.getElementById('discipline-schedule-area').classList.add('hidden');
            document.getElementById('discipline-attendance-area').classList.remove('hidden');

            await loadDiscipline(fullSubjectName);
        }

        function closeAttendanceArea() {
            document.getElementById('discipline-attendance-area').classList.add('hidden');
            document.getElementById('discipline-schedule-area').classList.remove('hidden');
        }

        // 3. è¼‰å…¥åå–®
        async function loadDiscipline(fullSubjectName) {
            const date = document.getElementById('work-date').value;
            const listDiv = document.getElementById('discipline-list');
            listDiv.innerHTML = '<p class="text-center text-blue-500 py-4"><i class="fas fa-circle-notch fa-spin mr-2"></i>è¼‰å…¥ä¸­...</p>';
            document.getElementById('btn-discipline-save').classList.add('hidden');

            try {
                const response = await fetch(API_URL, { 
                    method: 'POST', 
                    body: JSON.stringify({ action: 'loadAttendance', date: date, className: stuClass, subject: fullSubjectName }) 
                });
                const result = await response.json();
                if (result.success) { 
                    attendanceData = result.data; 
                    renderDisciplineList(); 
                    document.getElementById('btn-discipline-save').classList.remove('hidden'); 
                } else { listDiv.innerHTML = `<p class="text-center text-red-500 font-bold py-4">è¼‰å…¥å¤±æ•—ï¼š${result.message}</p>`; }
            } catch (error) { listDiv.innerHTML = '<p class="text-center text-red-500 py-4">ç¶²è·¯é€£ç·šç•°å¸¸</p>'; }
        }

        function renderDisciplineList() {
            let html = '';
            attendanceData.forEach((st, idx) => {
                let s = st.attendance || 'present';
                let bg = s === 'present' ? 'bg-green-50' : (s === 'leave' ? 'bg-blue-50' : 'bg-red-50');
                html += `
                <div class="flex items-center justify-between p-3 mb-2 rounded-lg border border-gray-200 ${bg}">
                    <div class="font-bold text-gray-700">
                        <span class="text-gray-400 mr-2 text-sm">${st.studentId}</span>${st.name}
                        ${s === 'leave' ? '<span class="ml-2 text-xs bg-blue-100 text-blue-600 px-2 py-0.5 rounded">å®¶é•·å·²è«‹å‡</span>' : ''}
                    </div>
                    <div class="flex gap-1">
                        <button onclick="setAttendance(${idx}, 'present')" class="px-3 py-1 text-sm font-bold rounded ${s === 'present' ? 'bg-green-500 text-white shadow' : 'bg-white text-gray-500 border'}">å‡ºå¸­</button>
                        <button onclick="setAttendance(${idx}, 'late')" class="px-3 py-1 text-sm font-bold rounded ${s === 'late' ? 'bg-yellow-500 text-white shadow' : 'bg-white text-gray-500 border'}">é²åˆ°</button>
                        <button onclick="setAttendance(${idx}, 'absent')" class="px-3 py-1 text-sm font-bold rounded ${s === 'absent' ? 'bg-red-500 text-white shadow' : 'bg-white text-gray-500 border'}">ç¼ºå¸­</button>
                    </div>
                </div>`;
            });
            document.getElementById('discipline-list').innerHTML = html;
        }

        function setAttendance(idx, s) { 
            if (attendanceData[idx].attendance === 'leave' && !confirm('è©²ç”Ÿå®¶é•·å·²è«‹å‡ï¼Œç¢ºå®šè¦è¦†è“‹å—ï¼Ÿ')) return;
            attendanceData[idx].attendance = s; 
            renderDisciplineList(); 
        }

        // 4. å„²å­˜é»åç´€éŒ„
        async function saveDiscipline() {
            const date = document.getElementById('work-date').value;
            const fullSubjectName = `${currentPeriod} - ${currentSubject}`;
            const btn = document.getElementById('btn-discipline-save');
            
            btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> å„²å­˜ä¸­...'; btn.disabled = true;
            const recordsToSave = attendanceData.map(st => ({ 
                date: date, className: stuClass, subject: fullSubjectName, studentId: st.studentId, name: st.name, attendance: st.attendance, comment: '' 
            }));
            try {
                const response = await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'batchSaveAttendance', records: recordsToSave }) });
                const result = await response.json();
                if (result.success) {
                    alert(`${fullSubjectName} é»åç´€éŒ„å·²å„²å­˜ï¼`);
                    closeAttendanceArea(); // å­˜æª”å¾Œè‡ªå‹•é€€å›èª²è¡¨é 
                } else alert('å„²å­˜å¤±æ•—ï¼š' + result.message);
            } catch (error) { alert('é€£ç·šç•°å¸¸ã€‚'); } finally { btn.innerHTML = '<i class="fas fa-save mr-2"></i> å„²å­˜å‡ºç¼ºå¸­ç´€éŒ„'; btn.disabled = false; }
        }

        // ==========================================
        // å­¸è—ã€è¡›ç”Ÿã€è³‡è¨Šã€å…±åŒåŠŸèƒ½ (ç¶­æŒåŸæ¨£)
        // ==========================================
        async function submitAcademic() {
            const content = document.getElementById('academic-content').value.trim();
            if (!content) return alert('è«‹è¼¸å…¥è¯çµ¡ç°¿å…§å®¹ï¼');
            const date = document.getElementById('work-date').value, btn = document.getElementById('btn-academic-submit');
            btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> ç™¼å¸ƒä¸­...'; btn.disabled = true;
            try {
                const response = await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'saveAnnouncement', date: date, className: stuClass, content: content, teacherName: `${cadreTitle} ${stuName}` }) });
                const result = await response.json();
                if (result.success) { alert('è¯çµ¡ç°¿ç™¼å¸ƒæˆåŠŸï¼'); document.getElementById('academic-content').value = ''; } else alert('ç™¼å¸ƒå¤±æ•—ï¼š' + result.message);
            } catch (error) { alert('é€£ç·šç•°å¸¸ã€‚'); } finally { btn.innerHTML = '<i class="fas fa-paper-plane mr-2"></i> ç™¼å¸ƒè‡³ç­ç´šçœ‹æ¿'; btn.disabled = false; }
        }

        let subData = { common: { data: [], itemName: '' }, hygiene: { data: [], itemName: 'æ‰“æƒå·¥ä½œ' }, it: { data: [], itemName: 'æ‰‹æ©Ÿç¹³äº¤' } };
        async function loadSubData(mode) {
            let itemName = subData[mode].itemName;
            if (mode === 'common') {
                itemName = document.getElementById('common-item-name').value.trim();
                if (!itemName) return alert('è«‹è¼¸å…¥è¦ç™»è¨˜çš„ç‰©å“åç¨±ï¼');
                subData.common.itemName = itemName;
            }
            const date = document.getElementById('work-date').value, btn = document.getElementById(`btn-${mode}-load`), listDiv = document.getElementById(`${mode}-list`);
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>'; btn.disabled = true;
            listDiv.innerHTML = '<p class="text-center text-blue-500 py-4"><i class="fas fa-circle-notch fa-spin mr-2"></i>è¼‰å…¥ä¸­...</p>';
            try {
                const response = await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'loadSubmissions', date: date, className: stuClass, itemName: itemName }) });
                const result = await response.json();
                if (result.success) { subData[mode].data = result.data; renderSubList(mode); document.getElementById(`btn-${mode}-save`).classList.remove('hidden'); } 
                else listDiv.innerHTML = `<p class="text-center text-red-500 py-4">è¼‰å…¥å¤±æ•—ï¼š${result.message}</p>`;
            } catch (error) { listDiv.innerHTML = '<p class="text-center text-red-500 py-4">ç¶²è·¯é€£ç·šç•°å¸¸</p>'; } finally { btn.innerHTML = 'è¼‰å…¥åå–®'; btn.disabled = false; }
        }

        function renderSubList(mode) {
            let html = '';
            subData[mode].data.forEach((st, idx) => {
                let s = st.status || 'pending';
                let bg = 'bg-yellow-50';
                if (s === 'done') bg = 'bg-green-50'; else if (s === 'missing') bg = 'bg-red-50'; else if (s === 'none') bg = 'bg-gray-100';
                
                html += `<div class="flex items-center justify-between p-3 mb-2 rounded-lg border border-gray-200 ${bg}">
                            <div class="font-bold text-gray-700"><span class="text-gray-400 mr-2 text-sm">${st.studentId}</span>${st.name}</div>
                            <div class="flex gap-1">`;
                if (mode === 'hygiene') {
                    html += `<button onclick="setSubStatus('${mode}', ${idx}, 'done')" class="px-2 py-1 text-xs font-bold rounded ${s === 'done' ? 'bg-green-500 text-white shadow' : 'bg-white text-gray-500 border'}">ä¹¾æ·¨</button>
                             <button onclick="setSubStatus('${mode}', ${idx}, 'pending')" class="px-2 py-1 text-xs font-bold rounded ${s === 'pending' ? 'bg-yellow-500 text-white shadow' : 'bg-white text-gray-500 border'}">å¾…åŠ å¼·</button>
                             <button onclick="setSubStatus('${mode}', ${idx}, 'missing')" class="px-2 py-1 text-xs font-bold rounded ${s === 'missing' ? 'bg-red-500 text-white shadow' : 'bg-white text-gray-500 border'}">æœªæ‰“æƒ</button>`;
                } else if (mode === 'it') {
                    html += `<button onclick="setSubStatus('${mode}', ${idx}, 'done')" class="px-2 py-1 text-xs font-bold rounded ${s === 'done' ? 'bg-green-500 text-white shadow' : 'bg-white text-gray-500 border'}">å·²äº¤</button>
                             <button onclick="setSubStatus('${mode}', ${idx}, 'pending')" class="px-2 py-1 text-xs font-bold rounded ${s === 'pending' ? 'bg-yellow-500 text-white shadow' : 'bg-white text-gray-500 border'}">æœªäº¤</button>
                             <button onclick="setSubStatus('${mode}', ${idx}, 'none')" class="px-2 py-1 text-xs font-bold rounded ${s === 'none' ? 'bg-gray-500 text-white shadow' : 'bg-white text-gray-500 border'}">æœªæ”œå¸¶</button>`;
                } else {
                    html += `<button onclick="setSubStatus('${mode}', ${idx}, 'done')" class="px-2 py-1 text-xs font-bold rounded ${s === 'done' ? 'bg-green-500 text-white shadow' : 'bg-white text-gray-500 border'}">å·²äº¤</button>
                             <button onclick="setSubStatus('${mode}', ${idx}, 'pending')" class="px-2 py-1 text-xs font-bold rounded ${s === 'pending' ? 'bg-yellow-500 text-white shadow' : 'bg-white text-gray-500 border'}">æœªäº¤</button>`;
                }
                html += `</div></div>`;
            });
            document.getElementById(`${mode}-list`).innerHTML = html;
        }

        function setSubStatus(mode, idx, s) { subData[mode].data[idx].status = s; renderSubList(mode); }

        async function saveSubData(mode) {
            const date = document.getElementById('work-date').value, itemName = subData[mode].itemName, btn = document.getElementById(`btn-${mode}-save`);
            btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> å„²å­˜ä¸­...'; btn.disabled = true;
            const recordsToSave = subData[mode].data.map(st => ({ date: date, className: stuClass, itemName: itemName, studentId: st.studentId, name: st.name, status: st.status }));
            try {
                const response = await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'batchSaveSubmissions', records: recordsToSave }) });
                const result = await response.json();
                if (result.success) alert(`${itemName} ç´€éŒ„å·²æˆåŠŸå„²å­˜ï¼`); else alert('å„²å­˜å¤±æ•—ï¼š' + result.message);
            } catch (error) { alert('é€£ç·šç•°å¸¸ã€‚'); } finally { btn.innerHTML = '<i class="fas fa-save mr-2"></i> å„²å­˜ç´€éŒ„'; btn.disabled = false; }
        }
    </script>
</body>
</html>
