<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¹¹éƒ¨å°ˆå€ - ç­ç´šç®¡ç†ç³»çµ±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body class="bg-gray-50 font-sans pb-12">

    <header class="bg-gradient-to-r from-blue-600 to-indigo-700 text-white shadow-md rounded-b-3xl pb-6">
        <div class="p-4 flex justify-between items-center">
            <h1 class="text-lg font-bold"><i class="fas fa-shield-alt mr-2"></i>å¹¹éƒ¨ç®¡ç†å°ˆå€</h1>
            <button onclick="logout()" class="text-blue-100 hover:text-white text-sm bg-white/20 px-3 py-1 rounded-full backdrop-blur-sm transition">
                <i class="fas fa-sign-out-alt"></i> ç™»å‡º
            </button>
        </div>
        <div class="px-6 flex items-center mt-2">
            <div class="w-16 h-16 bg-white rounded-full flex items-center justify-center text-indigo-600 text-3xl font-bold border-4 border-indigo-300 shadow-sm">
                <i class="fas fa-user-shield"></i>
            </div>
            <div class="ml-4 flex-1">
                <p class="text-blue-100 text-sm mb-1"><span id="display-class" class="font-bold"></span> ç­ç´šå¹¹éƒ¨</p>
                <div class="flex items-center">
                    <h2 class="text-2xl font-bold mr-2" id="display-name">è¼‰å…¥ä¸­...</h2>
                    <span id="display-title" class="bg-yellow-400 text-yellow-900 text-xs font-extrabold px-2 py-1 rounded-md shadow-sm">è·ç¨±</span>
                </div>
            </div>
        </div>
    </header>

    <main class="max-w-md mx-auto mt-6 px-4">
        
        <div class="bg-white rounded-xl shadow-sm p-4 mb-6 flex justify-between items-center border border-gray-100">
            <h3 class="font-bold text-gray-700"><i class="far fa-calendar-alt text-blue-500 mr-2"></i>ä½œæ¥­æ—¥æœŸ</h3>
            <input type="date" id="work-date" class="bg-gray-50 border border-gray-300 text-gray-800 text-sm rounded-lg p-2 focus:ring-2 focus:ring-blue-500 outline-none font-bold">
        </div>

        <div class="flex flex-wrap gap-2 mb-6" id="module-tabs">
            <button onclick="switchTab('common')" id="tab-common" class="flex-1 min-w-[45%] py-2.5 bg-blue-600 text-white rounded-xl shadow-md font-bold text-sm transition-all transform scale-105"><i class="fas fa-clipboard-check mr-1"></i> ç‰©å“ç¹³äº¤</button>
            <button onclick="switchTab('academic')" id="tab-academic" class="hidden flex-1 min-w-[45%] py-2.5 bg-white text-gray-500 hover:bg-gray-50 rounded-xl border border-gray-200 font-bold text-sm transition-all"><i class="fas fa-book-open mr-1"></i> è¯çµ¡ç°¿</button>
            <button onclick="switchTab('hygiene')" id="tab-hygiene" class="hidden flex-1 min-w-[45%] py-2.5 bg-white text-gray-500 hover:bg-gray-50 rounded-xl border border-gray-200 font-bold text-sm transition-all"><i class="fas fa-broom mr-1"></i> æ‰“æƒæ ¸å¯¦</button>
            <button onclick="switchTab('it')" id="tab-it" class="hidden flex-1 min-w-[45%] py-2.5 bg-white text-gray-500 hover:bg-gray-50 rounded-xl border border-gray-200 font-bold text-sm transition-all"><i class="fas fa-mobile-alt mr-1"></i> æ‰‹æ©Ÿç¹³äº¤</button>
            <button onclick="switchTab('discipline')" id="tab-discipline" class="hidden flex-1 min-w-[45%] py-2.5 bg-white text-gray-500 hover:bg-gray-50 rounded-xl border border-gray-200 font-bold text-sm transition-all"><i class="fas fa-user-check mr-1"></i> å‡ºå¸­ç‹€æ³</button>
        </div>

        <section id="section-common" class="block">
            <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-5">
                <h3 class="font-bold text-gray-800 mb-3 border-b border-gray-100 pb-2"><i class="fas fa-clipboard-check mr-2"></i>å„é …ç‰©å“/å›æ¢ç¹³äº¤</h3>
                <div class="flex gap-2 mb-4">
                    <input type="text" id="common-item-name" placeholder="è¼¸å…¥ç‰©å“åç¨± (å¦‚: æˆ¶å¤–æ•™å­¸å›æ¢)" class="flex-1 bg-gray-50 border border-gray-300 rounded-lg p-2 text-sm outline-none focus:ring-2 focus:ring-blue-400">
                    <button id="btn-common-load" onclick="loadSubData('common')" class="bg-blue-100 text-blue-700 font-bold px-3 py-2 rounded-lg hover:bg-blue-200 text-sm whitespace-nowrap">è¼‰å…¥</button>
                </div>
                
                <div id="common-assign-area" class="hidden mb-4 bg-indigo-50 p-3 rounded-lg border border-indigo-100">
                    <label class="block text-xs font-bold text-indigo-700 mb-1"><i class="fas fa-magic mr-1"></i>å¿«é€ŸæŒ‡æ´¾ç‰¹å®šå­¸ç”Ÿ (è¼¸å…¥åº§è™Ÿï¼Œå¦‚: 1,3,5 æˆ– 1-5)</label>
                    <div class="flex gap-2">
                        <input type="text" id="common-assign-input" placeholder="ç•™ç©ºä»£è¡¨å…¨ç­çš†é ˆç¹³äº¤" class="flex-1 bg-white border border-indigo-200 rounded px-2 py-1.5 text-sm outline-none focus:ring-2 focus:ring-indigo-400">
                        <button onclick="applyBatchAssign('common')" class="bg-indigo-600 text-white px-3 py-1.5 rounded shadow-sm text-sm font-bold hover:bg-indigo-700 transition">å¥—ç”¨</button>
                    </div>
                </div>

                <div id="common-list" class="mb-4 max-h-[50vh] overflow-y-auto"><p class="text-center text-gray-400 text-sm py-4">è«‹è¼¸å…¥åç¨±ä¸¦è¼‰å…¥åå–®</p></div>
                <button id="btn-common-save" onclick="saveSubData('common')" class="hidden w-full bg-blue-600 text-white font-bold py-3 rounded-lg shadow-sm hover:bg-blue-700 transition"><i class="fas fa-save mr-2"></i> å„²å­˜ç¹³äº¤é€²åº¦</button>
            </div>
        </section>

        <section id="section-academic" class="hidden"><div class="bg-white rounded-xl shadow-sm border border-orange-100 p-5"><h3 class="font-bold text-orange-600 mb-4 border-b border-orange-100 pb-2"><i class="fas fa-pen-nib mr-2"></i>ç™¼å¸ƒç­ç´šè¯çµ¡ç°¿</h3><textarea id="academic-content" rows="6" class="w-full bg-gray-50 border border-gray-200 rounded-lg p-3 text-sm focus:ring-2 focus:ring-orange-400 outline-none mb-4" placeholder="è«‹è¼¸å…¥ä»Šæ—¥ä½œæ¥­ã€æ˜æ—¥è€ƒè©¦èˆ‡æ”œå¸¶ç‰©å“..."></textarea><button id="btn-academic-submit" onclick="submitAcademic()" class="w-full bg-orange-500 text-white font-bold py-3 rounded-lg shadow-sm hover:bg-orange-600 transition"><i class="fas fa-paper-plane mr-2"></i> ç™¼å¸ƒè‡³ç­ç´šçœ‹æ¿</button></div></section>
        <section id="section-hygiene" class="hidden"><div class="bg-white rounded-xl shadow-sm border border-teal-100 p-5"><div class="flex justify-between items-center mb-4 border-b border-teal-100 pb-2"><h3 class="font-bold text-teal-600"><i class="fas fa-broom mr-2"></i>æ‰“æƒå·¥ä½œæ ¸å¯¦</h3><button id="btn-hygiene-load" onclick="loadSubData('hygiene')" class="bg-teal-50 text-teal-600 font-bold py-1.5 px-3 rounded-lg border border-teal-200 hover:bg-teal-100 text-sm">è¼‰å…¥åå–®</button></div><div id="hygiene-list" class="mb-4 max-h-[50vh] overflow-y-auto"><p class="text-center text-gray-400 text-sm py-4">è«‹è¼‰å…¥ç­ç´šåå–®</p></div><button id="btn-hygiene-save" onclick="saveSubData('hygiene')" class="hidden w-full bg-teal-600 text-white font-bold py-3 rounded-lg shadow-sm hover:bg-teal-700 transition"><i class="fas fa-save mr-2"></i> å„²å­˜æ‰“æƒç´€éŒ„</button></div></section>
        <section id="section-it" class="hidden"><div class="bg-white rounded-xl shadow-sm border border-purple-100 p-5"><div class="flex justify-between items-center mb-4 border-b border-purple-100 pb-2"><h3 class="font-bold text-purple-600"><i class="fas fa-mobile-alt mr-2"></i>æ‰‹æ©Ÿç¹³äº¤ç‹€æ³</h3><button id="btn-it-load" onclick="loadSubData('it')" class="bg-purple-50 text-purple-600 font-bold py-1.5 px-3 rounded-lg border border-purple-200 hover:bg-purple-100 text-sm">è¼‰å…¥åå–®</button></div><div id="it-list" class="mb-4 max-h-[50vh] overflow-y-auto"><p class="text-center text-gray-400 text-sm py-4">è«‹è¼‰å…¥ç­ç´šåå–®</p></div><button id="btn-it-save" onclick="saveSubData('it')" class="hidden w-full bg-purple-600 text-white font-bold py-3 rounded-lg shadow-sm hover:bg-purple-700 transition"><i class="fas fa-save mr-2"></i> å„²å­˜æ‰‹æ©Ÿç¹³äº¤</button></div></section>
        <section id="section-discipline" class="hidden"><div class="bg-white rounded-xl shadow-sm border border-red-100 p-5"><div id="discipline-schedule-area"><div class="flex justify-between items-center mb-3 border-b border-red-100 pb-2"><h3 class="font-bold text-red-600"><i class="fas fa-list-alt mr-2"></i>é¸æ“‡é»åç¯€æ¬¡</h3><button onclick="fetchSchedule()" class="text-red-500 text-sm hover:text-red-700 font-bold"><i class="fas fa-sync-alt"></i> é‡æ–°æ•´ç†</button></div><div id="schedule-list" class="flex flex-col gap-2 mb-4"><p class="text-center text-gray-400 text-sm py-4">è®€å–èª²è¡¨ä¸­...</p></div><div class="mt-4 pt-3 border-t border-gray-100 flex gap-2"><input type="text" id="manual-period" placeholder="è‡ªè¨‚(å¦‚:ç¬¬9ç¯€)" class="flex-1 bg-gray-50 border border-gray-300 rounded px-2 py-1.5 text-sm outline-none"><input type="text" id="manual-subject" placeholder="ç§‘ç›®åç¨±" class="flex-1 bg-gray-50 border border-gray-300 rounded px-2 py-1.5 text-sm outline-none"><button onclick="startManualAttendance()" class="bg-red-50 text-red-600 px-3 py-1.5 rounded-lg border border-red-200 shadow-sm text-sm font-bold hover:bg-red-100">å»ºç«‹</button></div></div><div id="discipline-attendance-area" class="hidden"><div class="flex justify-between items-center mb-4 border-b border-red-100 pb-2"><h3 class="font-bold text-red-600"><i class="fas fa-user-clock mr-2"></i><span id="current-attendance-title">å‡ºç¼ºå¸­é»å</span></h3><button onclick="closeAttendanceArea()" class="bg-gray-100 text-gray-600 font-bold py-1 px-3 rounded-lg border border-gray-200 hover:bg-gray-200 text-sm shadow-sm"><i class="fas fa-arrow-left mr-1"></i> è¿”å›</button></div><div id="discipline-list" class="mb-4 max-h-[60vh] overflow-y-auto"></div><button id="btn-discipline-save" onclick="saveDiscipline()" class="hidden w-full bg-red-600 text-white font-bold py-3 rounded-lg shadow-sm hover:bg-red-700 transition flex justify-center items-center"><i class="fas fa-save mr-2"></i> å„²å­˜å‡ºç¼ºå¸­ç´€éŒ„</button></div></div></section>
    </main>

    <script>
        const API_URL = "https://script.google.com/macros/s/AKfycbwunBwJT2u3gpAcnibQW4RBOQhuzQXLtcirT4_6G6fG9FgwJjTAApax5fU0VZ1dNvdRog/exec";
        const isLoggedIn = sessionStorage.getItem('isLoggedIn'), userRole = sessionStorage.getItem('userRole'), stuName = sessionStorage.getItem('studentName'), stuClass = sessionStorage.getItem('studentClass'), cadreTitle = sessionStorage.getItem('cadreTitle') || ''; 
        if (!isLoggedIn || userRole !== 'cadre') { alert('è«‹å…ˆä»¥å¹¹éƒ¨èº«åˆ†ç™»å…¥ï¼'); window.location.href = 'login.html'; }

        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('display-name').innerText = stuName || 'å¹¹éƒ¨'; document.getElementById('display-class').innerText = stuClass || ''; document.getElementById('display-title').innerText = cadreTitle || 'ä¸€èˆ¬å¹¹éƒ¨';
            const dateInput = document.getElementById('work-date'), today = new Date(); dateInput.value = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
            let defaultTab = 'common';
            if (cadreTitle.includes('å­¸è—')) { document.getElementById('tab-academic').classList.remove('hidden'); defaultTab = 'academic'; }
            if (cadreTitle.includes('è¡›ç”Ÿ')) { document.getElementById('tab-hygiene').classList.remove('hidden'); defaultTab = 'hygiene'; }
            if (cadreTitle.includes('è³‡è¨Š')) { document.getElementById('tab-it').classList.remove('hidden'); defaultTab = 'it'; }
            if (cadreTitle.includes('é¢¨ç´€')) { document.getElementById('tab-discipline').classList.remove('hidden'); defaultTab = 'discipline'; fetchSchedule(); }
            switchTab(defaultTab);
            dateInput.addEventListener('change', () => {
                if (cadreTitle.includes('é¢¨ç´€')) { closeAttendanceArea(); fetchSchedule(); }
                ['common', 'hygiene', 'it'].forEach(mode => { document.getElementById(`${mode}-list`).innerHTML = '<p class="text-center text-gray-400 text-sm py-4">è«‹é‡æ–°è¼‰å…¥åå–®</p>'; document.getElementById(`btn-${mode}-save`).classList.add('hidden'); if(mode==='common') document.getElementById('common-assign-area').classList.add('hidden'); });
            });
        });

        function switchTab(target) {
            const sections = ['common', 'academic', 'hygiene', 'it', 'discipline'];
            sections.forEach(sec => {
                const sectionEl = document.getElementById(`section-${sec}`), tabEl = document.getElementById(`tab-${sec}`);
                if (!tabEl || tabEl.classList.contains('hidden')) return;
                if (sec === target) { sectionEl.classList.remove('hidden'); sectionEl.classList.add('block'); tabEl.className = `flex-1 min-w-[45%] py-2.5 bg-blue-600 text-white rounded-xl shadow-md font-bold text-sm transition-all transform scale-105`; } 
                else { sectionEl.classList.remove('block'); sectionEl.classList.add('hidden'); tabEl.className = `flex-1 min-w-[45%] py-2.5 bg-white text-gray-500 hover:bg-gray-50 rounded-xl border border-gray-200 font-bold text-sm transition-all`; }
            });
        }
        function logout() { sessionStorage.clear(); window.location.href = 'login.html'; }

        // ==========================================
        // æ¨¡çµ„ï¼šé¢¨ç´€ / å­¸è— (ç¶­æŒåŸæ¨£)
        // ==========================================
        let attendanceData = [], currentPeriod = '', currentSubject = '';
        async function fetchSchedule() { /* ç•¥ï¼ŒåŒå‰ç‰ˆ */ const date = document.getElementById('work-date').value, container = document.getElementById('schedule-list'); container.innerHTML = '<p class="text-sm text-gray-500 text-center">è®€å–ä¸­...</p>'; try { const res = await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'getSchedule', date: date, className: stuClass }) }); const result = await res.json(); if (result.success) { if (result.isWeekend) container.innerHTML = '<p class="text-sm text-gray-500 text-center py-2">å‡æ—¥ç„¡é è¨­èª²è¡¨ï¼Œè«‹ä½¿ç”¨è‡ªè¨‚ç¯€æ¬¡ã€‚</p>'; else if (result.schedule.length === 0) container.innerHTML = `<p class="text-sm text-red-500 text-center">æŸ¥ç„¡ä»Šæ—¥èª²è¡¨</p>`; else { let html = ''; result.schedule.forEach((item, index) => { html += `<div class="flex items-center justify-between bg-red-50 p-2.5 rounded-lg border border-red-100 mb-2"><div class="font-bold text-red-700 w-16 text-sm text-center">${item.period}</div><div class="flex-1 px-2"><input type="text" id="subj-${index}" value="${item.subject}" class="w-full px-2 py-1.5 text-sm border rounded"></div><button onclick="startAttendance('${item.period}', '${index}')" class="bg-red-500 text-white px-4 py-1.5 rounded-lg text-sm font-bold">é»å</button></div>`; }); container.innerHTML = html; } } else container.innerHTML = `<p class="text-sm text-red-500 text-center">å¤±æ•—ï¼š${result.message}</p>`; } catch (e) {} }
        function startManualAttendance() { const p = document.getElementById('manual-period').value.trim(), s = document.getElementById('manual-subject').value.trim(); if(p && s) startAttendance(p, s, true); }
        async function startAttendance(period, subjectOrIndex, isManual = false) { currentPeriod = period; currentSubject = isManual ? subjectOrIndex : (document.getElementById(`subj-${subjectOrIndex}`).value.trim() || 'æœªå®šç§‘ç›®'); const fullName = `${period} - ${currentSubject}`; document.getElementById('current-attendance-title').innerText = fullName; document.getElementById('discipline-schedule-area').classList.add('hidden'); document.getElementById('discipline-attendance-area').classList.remove('hidden'); await loadDiscipline(fullName); }
        function closeAttendanceArea() { document.getElementById('discipline-attendance-area').classList.add('hidden'); document.getElementById('discipline-schedule-area').classList.remove('hidden'); }
        async function loadDiscipline(fullName) { const date = document.getElementById('work-date').value, listDiv = document.getElementById('discipline-list'); listDiv.innerHTML = '<p class="text-center text-blue-500 py-4">è¼‰å…¥ä¸­...</p>'; document.getElementById('btn-discipline-save').classList.add('hidden'); try { const response = await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'loadAttendance', date: date, className: stuClass, subject: fullName }) }); const result = await response.json(); if (result.success) { attendanceData = result.data; renderDisciplineList(); document.getElementById('btn-discipline-save').classList.remove('hidden'); } else listDiv.innerHTML = `<p class="text-center text-red-500">å¤±æ•—ï¼š${result.message}</p>`; } catch (error) {} }
        function renderDisciplineList() { let html = ''; attendanceData.forEach((st, idx) => { let s = st.attendance || 'present', bg = s === 'present' ? 'bg-green-50' : (s === 'leave' ? 'bg-blue-50' : 'bg-red-50'); html += `<div class="flex items-center justify-between p-3 mb-2 rounded-lg border border-gray-200 ${bg}"><div class="font-bold text-gray-700"><span class="text-gray-400 mr-2 text-sm">${st.studentId}</span>${st.name} ${s === 'leave' ? '<span class="ml-2 text-xs bg-blue-100 text-blue-600 px-2 py-0.5 rounded">å®¶é•·å·²è«‹å‡</span>' : ''}</div><div class="flex gap-1"><button onclick="setAttendance(${idx}, 'present')" class="px-3 py-1 text-sm font-bold rounded ${s === 'present' ? 'bg-green-500 text-white' : 'bg-white text-gray-500 border'}">å‡ºå¸­</button><button onclick="setAttendance(${idx}, 'late')" class="px-3 py-1 text-sm font-bold rounded ${s === 'late' ? 'bg-yellow-500 text-white' : 'bg-white text-gray-500 border'}">é²åˆ°</button><button onclick="setAttendance(${idx}, 'absent')" class="px-3 py-1 text-sm font-bold rounded ${s === 'absent' ? 'bg-red-500 text-white' : 'bg-white text-gray-500 border'}">ç¼ºå¸­</button></div></div>`; }); document.getElementById('discipline-list').innerHTML = html; }
        function setAttendance(idx, s) { if (attendanceData[idx].attendance === 'leave' && !confirm('è¦†è“‹è«‹å‡ï¼Ÿ')) return; attendanceData[idx].attendance = s; renderDisciplineList(); }
        async function saveDiscipline() { const btn = document.getElementById('btn-discipline-save'); btn.disabled = true; const records = attendanceData.map(st => ({ date: document.getElementById('work-date').value, className: stuClass, subject: `${currentPeriod} - ${currentSubject}`, studentId: st.studentId, name: st.name, attendance: st.attendance, comment: '' })); try { const res = await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'batchSaveAttendance', records }) }); const result = await res.json(); if (result.success) { alert('å„²å­˜æˆåŠŸï¼'); closeAttendanceArea(); } else alert('å¤±æ•—'); } catch (e) {} finally { btn.disabled = false; } }

        async function submitAcademic() { const c = document.getElementById('academic-content').value.trim(); if(!c) return alert('è«‹è¼¸å…¥å…§å®¹'); const btn = document.getElementById('btn-academic-submit'); btn.disabled = true; try { const res = await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'saveAnnouncement', date: document.getElementById('work-date').value, className: stuClass, content: c, teacherName: `${cadreTitle} ${stuName}` }) }); const result = await res.json(); if(result.success) { alert('ç™¼å¸ƒæˆåŠŸï¼'); document.getElementById('academic-content').value = ''; } } catch(e){} finally { btn.disabled = false; } }

        // ==========================================
        // ğŸŸ¢ æ¨¡çµ„ä¸‰ï¼šç‰©å“ç¹³äº¤ (å‡ç´šå…äº¤èˆ‡æ‰¹æ¬¡æ´¾ç™¼åŠŸèƒ½)
        // ==========================================
        let subData = { common: { data: [], itemName: '' }, hygiene: { data: [], itemName: 'æ‰“æƒå·¥ä½œ' }, it: { data: [], itemName: 'æ‰‹æ©Ÿç¹³äº¤' } };
        
        async function loadSubData(mode) {
            let itemName = subData[mode].itemName;
            if (mode === 'common') {
                itemName = document.getElementById('common-item-name').value.trim();
                if (!itemName) return alert('è«‹è¼¸å…¥è¦ç™»è¨˜çš„ç‰©å“åç¨±ï¼');
                subData.common.itemName = itemName;
            }
            const date = document.getElementById('work-date').value, btn = document.getElementById(`btn-${mode}-load`), listDiv = document.getElementById(`${mode}-list`);
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>'; btn.disabled = true;
            listDiv.innerHTML = '<p class="text-center text-blue-500 py-4"><i class="fas fa-circle-notch fa-spin mr-2"></i>è¼‰å…¥ä¸­...</p>';
            try {
                const response = await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'loadSubmissions', date: date, className: stuClass, itemName: itemName }) });
                const result = await response.json();
                if (result.success) { 
                    subData[mode].data = result.data; 
                    renderSubList(mode); 
                    document.getElementById(`btn-${mode}-save`).classList.remove('hidden'); 
                    // é¡¯ç¤ºå¿«é€ŸæŒ‡æ´¾å€
                    if(mode === 'common') document.getElementById('common-assign-area').classList.remove('hidden');
                } else listDiv.innerHTML = `<p class="text-center text-red-500 py-4">è¼‰å…¥å¤±æ•—ï¼š${result.message}</p>`;
            } catch (error) { listDiv.innerHTML = '<p class="text-center text-red-500 py-4">ç¶²è·¯é€£ç·šç•°å¸¸</p>'; } finally { btn.innerHTML = 'è¼‰å…¥åå–®'; btn.disabled = false; }
        }

        // ğŸŒŸ æ‰¹æ¬¡æŒ‡æ´¾é‚è¼¯
        function applyBatchAssign(mode) {
            const input = document.getElementById(`${mode}-assign-input`).value.trim();
            if (!input) {
                subData[mode].data.forEach(st => { if (st.status === 'exempt') st.status = 'pending'; });
                renderSubList(mode);
                return alert('å·²é‡ç½®ç‚ºã€Œå…¨ç­çš†é ˆç¹³äº¤ã€ã€‚');
            }

            let targetSeats = new Set();
            input.split(',').forEach(p => {
                p = p.trim();
                if (p.includes('-')) {
                    let range = p.split('-');
                    let start = parseInt(range[0]), end = parseInt(range[1]);
                    if (!isNaN(start) && !isNaN(end)) {
                        for(let i=start; i<=end; i++) targetSeats.add(i.toString());
                    }
                } else {
                    let seat = parseInt(p);
                    if (!isNaN(seat)) targetSeats.add(seat.toString());
                }
            });

            let assignedCount = 0;
            subData[mode].data.forEach(st => {
                // æ™ºæ…§è§£æåº§è™Ÿï¼šæ¯”å°å®Œæ•´å­¸è™Ÿï¼Œæˆ–æ˜¯å­¸è™Ÿçš„æœ€å¾Œå…©ç¢¼
                let seat1 = st.studentId.toString();
                let seat2 = parseInt(seat1.slice(-2)).toString(); 
                let seat3 = parseInt(seat1).toString();

                if (targetSeats.has(seat1) || targetSeats.has(seat2) || targetSeats.has(seat3)) {
                    if (st.status === 'exempt' || !st.status) st.status = 'pending';
                    assignedCount++;
                } else {
                    st.status = 'exempt'; // æ¨™è¨˜ç‚ºå…äº¤
                }
            });
            
            renderSubList(mode);
            alert(`âœ… å¿«é€ŸæŒ‡æ´¾æˆåŠŸï¼\nå·²æŒ‡æ´¾çµ¦ ${assignedCount} ä½å­¸ç”Ÿï¼Œå…¶é¤˜å­¸ç”Ÿå·²è‡ªå‹•è¨­ç‚ºã€Œå…äº¤ã€ã€‚\nè«‹ç¢ºèªç„¡èª¤å¾Œï¼Œé»æ“Šæœ€ä¸‹æ–¹ã€å„²å­˜ã€‘æ‰æœƒç”Ÿæ•ˆã€‚`);
        }

        function renderSubList(mode) {
            let html = '';
            subData[mode].data.forEach((st, idx) => {
                let s = st.status || 'pending';
                // è¦–è¦ºå€åˆ†ï¼šæ–°å¢ exempt ç°è‰²åŠé€æ˜èƒŒæ™¯
                let bg = 'bg-yellow-50';
                if (s === 'done') bg = 'bg-green-50'; 
                else if (s === 'missing') bg = 'bg-red-50'; 
                else if (s === 'none') bg = 'bg-gray-100';
                else if (s === 'exempt') bg = 'bg-gray-200 opacity-60 grayscale'; 
                
                html += `<div class="flex items-center justify-between p-3 mb-2 rounded-lg border border-gray-200 ${bg}">
                            <div class="font-bold text-gray-700"><span class="text-gray-400 mr-2 text-sm">${st.studentId}</span>${st.name}</div>
                            <div class="flex gap-1">`;
                
                if (mode === 'hygiene') {
                    html += `<button onclick="setSubStatus('${mode}', ${idx}, 'done')" class="px-2 py-1 text-xs font-bold rounded ${s === 'done' ? 'bg-green-500 text-white shadow' : 'bg-white text-gray-500 border'}">ä¹¾æ·¨</button>
                             <button onclick="setSubStatus('${mode}', ${idx}, 'pending')" class="px-2 py-1 text-xs font-bold rounded ${s === 'pending' ? 'bg-yellow-500 text-white shadow' : 'bg-white text-gray-500 border'}">å¾…åŠ å¼·</button>
                             <button onclick="setSubStatus('${mode}', ${idx}, 'missing')" class="px-2 py-1 text-xs font-bold rounded ${s === 'missing' ? 'bg-red-500 text-white shadow' : 'bg-white text-gray-500 border'}">æœªæ‰“æƒ</button>`;
                } else if (mode === 'it') {
                    html += `<button onclick="setSubStatus('${mode}', ${idx}, 'done')" class="px-2 py-1 text-xs font-bold rounded ${s === 'done' ? 'bg-green-500 text-white shadow' : 'bg-white text-gray-500 border'}">å·²äº¤</button>
                             <button onclick="setSubStatus('${mode}', ${idx}, 'pending')" class="px-2 py-1 text-xs font-bold rounded ${s === 'pending' ? 'bg-yellow-500 text-white shadow' : 'bg-white text-gray-500 border'}">æœªäº¤</button>
                             <button onclick="setSubStatus('${mode}', ${idx}, 'none')" class="px-2 py-1 text-xs font-bold rounded ${s === 'none' ? 'bg-gray-500 text-white shadow' : 'bg-white text-gray-500 border'}">æœªæ”œå¸¶</button>`;
                } else {
                    // ğŸŒŸ å…±åŒåŠŸèƒ½ï¼šåŠ å…¥ã€Œå…äº¤ã€æŒ‰éˆ•
                    html += `<button onclick="setSubStatus('${mode}', ${idx}, 'done')" class="px-2 py-1 text-xs font-bold rounded ${s === 'done' ? 'bg-green-500 text-white shadow' : 'bg-white text-gray-500 border'}">å·²äº¤</button>
                             <button onclick="setSubStatus('${mode}', ${idx}, 'pending')" class="px-2 py-1 text-xs font-bold rounded ${s === 'pending' ? 'bg-yellow-500 text-white shadow' : 'bg-white text-gray-500 border'}">æœªäº¤</button>
                             <button onclick="setSubStatus('${mode}', ${idx}, 'exempt')" class="px-2 py-1 text-xs font-bold rounded ${s === 'exempt' ? 'bg-gray-500 text-white shadow' : 'bg-white text-gray-500 border'}">å…äº¤</button>`;
                }
                html += `</div></div>`;
            });
            document.getElementById(`${mode}-list`).innerHTML = html;
        }

        function setSubStatus(mode, idx, s) { subData[mode].data[idx].status = s; renderSubList(mode); }

        async function saveSubData(mode) {
            const date = document.getElementById('work-date').value, itemName = subData[mode].itemName, btn = document.getElementById(`btn-${mode}-save`);
            btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> å„²å­˜ä¸­...'; btn.disabled = true;
            const recordsToSave = subData[mode].data.map(st => ({ date: date, className: stuClass, itemName: itemName, studentId: st.studentId, name: st.name, status: st.status }));
            try {
                const response = await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'batchSaveSubmissions', records: recordsToSave }) });
                const result = await response.json();
                if (result.success) alert(`${itemName} ç´€éŒ„å·²æˆåŠŸå„²å­˜ï¼`); else alert('å„²å­˜å¤±æ•—ï¼š' + result.message);
            } catch (error) { alert('é€£ç·šç•°å¸¸ã€‚'); } finally { btn.innerHTML = '<i class="fas fa-save mr-2"></i> å„²å­˜ç´€éŒ„'; btn.disabled = false; }
        }
    </script>
</body>
</html>
