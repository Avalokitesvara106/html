<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¹¹éƒ¨å°ˆå€ - ç­ç´šç®¡ç†ç³»çµ±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body class="bg-gray-50 font-sans pb-12">

    <header class="bg-gradient-to-r from-blue-600 to-indigo-700 text-white shadow-md rounded-b-3xl pb-6">
        <div class="p-4 flex justify-between items-center">
            <h1 class="text-lg font-bold"><i class="fas fa-shield-alt mr-2"></i>å¹¹éƒ¨ç®¡ç†å°ˆå€</h1>
            <button onclick="logout()" class="text-blue-100 hover:text-white text-sm bg-white/20 px-3 py-1 rounded-full backdrop-blur-sm transition">
                <i class="fas fa-sign-out-alt"></i> ç™»å‡º
            </button>
        </div>
        <div class="px-6 flex items-center mt-2">
            <div class="w-16 h-16 bg-white rounded-full flex items-center justify-center text-indigo-600 text-3xl font-bold border-4 border-indigo-300 shadow-sm">
                <i class="fas fa-user-shield"></i>
            </div>
            <div class="ml-4 flex-1">
                <p class="text-blue-100 text-sm mb-1"><span id="display-class" class="font-bold"></span> ç­ç´šå¹¹éƒ¨</p>
                <div class="flex items-center">
                    <h2 class="text-2xl font-bold mr-2" id="display-name">è¼‰å…¥ä¸­...</h2>
                    <span id="display-title" class="bg-yellow-400 text-yellow-900 text-xs font-extrabold px-2 py-1 rounded-md shadow-sm">è·ç¨±</span>
                </div>
            </div>
        </div>
    </header>

    <main class="max-w-md mx-auto mt-6 px-4">
        
        <div class="bg-white rounded-xl shadow-sm p-4 mb-6 flex justify-between items-center border border-gray-100">
            <h3 class="font-bold text-gray-700"><i class="far fa-calendar-alt text-blue-500 mr-2"></i>ä½œæ¥­æ—¥æœŸ</h3>
            <input type="date" id="work-date" class="bg-gray-50 border border-gray-300 text-gray-800 text-sm rounded-lg p-2 focus:ring-2 focus:ring-blue-500 outline-none font-bold">
        </div>

        <div class="flex flex-wrap gap-2 mb-6" id="module-tabs">
            <button onclick="switchTab('common')" id="tab-common" class="flex-1 min-w-[45%] py-2.5 bg-blue-600 text-white rounded-xl shadow-md font-bold text-sm transition-all transform scale-105">
                <i class="fas fa-clipboard-check mr-1"></i> ç‰©å“ç¹³äº¤
            </button>
            <button onclick="switchTab('academic')" id="tab-academic" class="hidden flex-1 min-w-[45%] py-2.5 bg-white text-gray-500 hover:bg-gray-50 rounded-xl border border-gray-200 font-bold text-sm transition-all">
                <i class="fas fa-book-open mr-1"></i> è¯çµ¡ç°¿
            </button>
            <button onclick="switchTab('hygiene')" id="tab-hygiene" class="hidden flex-1 min-w-[45%] py-2.5 bg-white text-gray-500 hover:bg-gray-50 rounded-xl border border-gray-200 font-bold text-sm transition-all">
                <i class="fas fa-broom mr-1"></i> æ‰“æƒæ ¸å¯¦
            </button>
            <button onclick="switchTab('it')" id="tab-it" class="hidden flex-1 min-w-[45%] py-2.5 bg-white text-gray-500 hover:bg-gray-50 rounded-xl border border-gray-200 font-bold text-sm transition-all">
                <i class="fas fa-mobile-alt mr-1"></i> æ‰‹æ©Ÿç¹³äº¤
            </button>
            <button onclick="switchTab('discipline')" id="tab-discipline" class="hidden flex-1 min-w-[45%] py-2.5 bg-white text-gray-500 hover:bg-gray-50 rounded-xl border border-gray-200 font-bold text-sm transition-all">
                <i class="fas fa-user-check mr-1"></i> å‡ºå¸­ç‹€æ³
            </button>
        </div>

        <section id="section-common" class="block">
            <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-5 text-center">
                <div class="w-12 h-12 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center mx-auto mb-3 text-xl"><i class="fas fa-tools"></i></div>
                <h3 class="font-bold text-gray-800 mb-2">ç‰©å“ç¹³äº¤æ¨¡çµ„é–‹ç™¼ä¸­</h3>
                <p class="text-sm text-gray-500">æ­¤åŠŸèƒ½å°‡åœ¨ä¸‹ä¸€éšæ®µç‚ºæ‚¨ä¸²æ¥ã€‚</p>
            </div>
        </section>

        <section id="section-academic" class="hidden">
            <div class="bg-white rounded-xl shadow-sm border border-orange-100 p-5">
                <h3 class="font-bold text-orange-600 mb-4 border-b border-orange-100 pb-2"><i class="fas fa-pen-nib mr-2"></i>ç™¼å¸ƒç­ç´šè¯çµ¡ç°¿</h3>
                <textarea id="academic-content" rows="6" class="w-full bg-gray-50 border border-gray-200 rounded-lg p-3 text-sm focus:ring-2 focus:ring-orange-400 outline-none mb-4" placeholder="è«‹è¼¸å…¥ä»Šæ—¥ä½œæ¥­ã€æ˜æ—¥è€ƒè©¦èˆ‡æ”œå¸¶ç‰©å“..."></textarea>
                <button id="btn-academic-submit" onclick="submitAcademic()" class="w-full bg-orange-500 text-white font-bold py-3 rounded-lg shadow-sm hover:bg-orange-600 transition flex justify-center items-center">
                    <i class="fas fa-paper-plane mr-2"></i> ç™¼å¸ƒè‡³ç­ç´šçœ‹æ¿
                </button>
            </div>
        </section>

        <section id="section-hygiene" class="hidden"><div class="bg-white rounded-xl shadow-sm border border-teal-100 p-5 text-center"><p class="text-teal-600 font-bold">æ‰“æƒæ ¸å¯¦æ¨¡çµ„é–‹ç™¼ä¸­...</p></div></section>
        <section id="section-it" class="hidden"><div class="bg-white rounded-xl shadow-sm border border-purple-100 p-5 text-center"><p class="text-purple-600 font-bold">æ‰‹æ©Ÿç¹³äº¤æ¨¡çµ„é–‹ç™¼ä¸­...</p></div></section>

        <section id="section-discipline" class="hidden">
            <div class="bg-white rounded-xl shadow-sm border border-red-100 p-5">
                <div class="flex justify-between items-center mb-4 border-b border-red-100 pb-2">
                    <h3 class="font-bold text-red-600"><i class="fas fa-user-clock mr-2"></i>æ—¥å¸¸å‡ºç¼ºå¸­é»å</h3>
                    <button id="btn-discipline-load" onclick="loadDiscipline()" class="bg-red-50 text-red-600 font-bold py-1.5 px-3 rounded-lg border border-red-200 hover:bg-red-100 text-sm">
                        <i class="fas fa-sync-alt mr-1"></i> è¼‰å…¥åå–®
                    </button>
                </div>
                
                <div id="discipline-list" class="mb-4 max-h-[60vh] overflow-y-auto">
                    <p class="text-center text-gray-400 text-sm py-4">è«‹é»æ“Šä¸Šæ–¹æŒ‰éˆ•è¼‰å…¥ç­ç´šåå–®</p>
                </div>

                <button id="btn-discipline-save" onclick="saveDiscipline()" class="hidden w-full bg-red-600 text-white font-bold py-3 rounded-lg shadow-sm hover:bg-red-700 transition flex justify-center items-center">
                    <i class="fas fa-save mr-2"></i> å„²å­˜å‡ºç¼ºå¸­ç´€éŒ„
                </button>
            </div>
        </section>

    </main>

    <script>
        // ==========================================
        // ğŸš¨ è«‹å¡«å¯«æ‚¨çš„ GAS ç¶²å€
        // ==========================================
        const API_URL = "https://script.google.com/macros/s/AKfycbwunBwJT2u3gpAcnibQW4RBOQhuzQXLtcirT4_6G6fG9FgwJjTAApax5fU0VZ1dNvdRog/exec";
        
        const isLoggedIn = sessionStorage.getItem('isLoggedIn');
        const userRole = sessionStorage.getItem('userRole');
        const stuName = sessionStorage.getItem('studentName');
        const stuClass = sessionStorage.getItem('studentClass');
        const cadreTitle = sessionStorage.getItem('cadreTitle') || ''; 

        if (!isLoggedIn || userRole !== 'cadre') {
            alert('è«‹å…ˆä»¥å¹¹éƒ¨èº«åˆ†ç™»å…¥ï¼'); window.location.href = 'login.html';
        }

        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('display-name').innerText = stuName || 'å¹¹éƒ¨';
            document.getElementById('display-class').innerText = stuClass || '';
            document.getElementById('display-title').innerText = cadreTitle || 'ä¸€èˆ¬å¹¹éƒ¨';

            const dateInput = document.getElementById('work-date');
            const today = new Date();
            dateInput.value = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;

            // ä¾è·ç¨±è§£é–æŒ‰éˆ•
            if (cadreTitle.includes('å­¸è—')) document.getElementById('tab-academic').classList.remove('hidden');
            if (cadreTitle.includes('è¡›ç”Ÿ')) document.getElementById('tab-hygiene').classList.remove('hidden');
            if (cadreTitle.includes('è³‡è¨Š')) document.getElementById('tab-it').classList.remove('hidden');
            if (cadreTitle.includes('é¢¨ç´€')) document.getElementById('tab-discipline').classList.remove('hidden');
        });

        // UI åˆ‡æ›é‚è¼¯
        function switchTab(target) {
            const sections = ['common', 'academic', 'hygiene', 'it', 'discipline'];
            sections.forEach(sec => {
                const sectionEl = document.getElementById(`section-${sec}`);
                const tabEl = document.getElementById(`tab-${sec}`);
                if (!tabEl || tabEl.classList.contains('hidden')) return;

                if (sec === target) {
                    sectionEl.classList.remove('hidden'); sectionEl.classList.add('block');
                    tabEl.className = `flex-1 min-w-[45%] py-2.5 bg-blue-600 text-white rounded-xl shadow-md font-bold text-sm transition-all transform scale-105`;
                } else {
                    sectionEl.classList.remove('block'); sectionEl.classList.add('hidden');
                    tabEl.className = `flex-1 min-w-[45%] py-2.5 bg-white text-gray-500 hover:bg-gray-50 rounded-xl border border-gray-200 font-bold text-sm transition-all`;
                }
            });
        }

        function logout() { sessionStorage.clear(); window.location.href = 'login.html'; }

        // ==========================================
        // ğŸŸ¢ å¯¦ä½œä¸€ï¼šå­¸è—è‚¡é•· (è¯çµ¡ç°¿ç™¼å¸ƒ)
        // ==========================================
        async function submitAcademic() {
            const content = document.getElementById('academic-content').value.trim();
            if (!content) return alert('è«‹å…ˆè¼¸å…¥è¯çµ¡ç°¿å…§å®¹ï¼');
            
            const date = document.getElementById('work-date').value;
            const btn = document.getElementById('btn-academic-submit');
            btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> ç™¼å¸ƒä¸­...';
            btn.disabled = true;

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    body: JSON.stringify({
                        action: 'saveAnnouncement',
                        date: date,
                        className: stuClass,
                        content: content,
                        teacherName: `${cadreTitle} ${stuName}` // ç½²åæœƒé¡¯ç¤º "å­¸è—è‚¡é•· ç‹å°æ˜"
                    })
                });
                const result = await response.json();
                if (result.success) {
                    alert('è¯çµ¡ç°¿ç™¼å¸ƒæˆåŠŸï¼');
                    document.getElementById('academic-content').value = ''; // æ¸…ç©ºè¼¸å…¥æ¡†
                } else {
                    alert('ç™¼å¸ƒå¤±æ•—ï¼š' + result.message);
                }
            } catch (error) {
                alert('é€£ç·šç•°å¸¸ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚');
            } finally {
                btn.innerHTML = '<i class="fas fa-paper-plane mr-2"></i> ç™¼å¸ƒè‡³ç­ç´šçœ‹æ¿';
                btn.disabled = false;
            }
        }

        // ==========================================
        // ğŸŸ¢ å¯¦ä½œäºŒï¼šé¢¨ç´€è‚¡é•· (å‡ºç¼ºå¸­é»å)
        // ==========================================
        let attendanceData = []; // æš«å­˜å…¨ç­åå–®

        async function loadDiscipline() {
            const date = document.getElementById('work-date').value;
            const btn = document.getElementById('btn-discipline-load');
            const listDiv = document.getElementById('discipline-list');
            
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> è¼‰å…¥ä¸­';
            btn.disabled = true;
            listDiv.innerHTML = '<p class="text-center text-blue-500 py-4"><i class="fas fa-circle-notch fa-spin mr-2"></i>æ­£åœ¨å¾è³‡æ–™åº«æŠ“å–åå–®...</p>';
            document.getElementById('btn-discipline-save').classList.add('hidden');

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    body: JSON.stringify({
                        action: 'loadAttendance',
                        date: date,
                        className: stuClass,
                        subject: 'æ—¥å¸¸å‡ºç¼ºå¸­' // å›ºå®šç§‘ç›®åç¨±
                    })
                });
                const result = await response.json();
                
                if (result.success) {
                    attendanceData = result.data;
                    renderDisciplineList();
                    document.getElementById('btn-discipline-save').classList.remove('hidden');
                } else {
                    listDiv.innerHTML = `<p class="text-center text-red-500 py-4">è¼‰å…¥å¤±æ•—ï¼š${result.message}</p>`;
                }
            } catch (error) {
                listDiv.innerHTML = '<p class="text-center text-red-500 py-4">ç¶²è·¯é€£ç·šç•°å¸¸</p>';
            } finally {
                btn.innerHTML = '<i class="fas fa-sync-alt mr-1"></i> é‡æ–°è¼‰å…¥';
                btn.disabled = false;
            }
        }

        // æ¸²æŸ“å­¸ç”Ÿåå–® UI
        function renderDisciplineList() {
            const listDiv = document.getElementById('discipline-list');
            if (attendanceData.length === 0) {
                listDiv.innerHTML = '<p class="text-center text-gray-500 py-4">æŸ¥ç„¡æ­¤ç­ç´šå­¸ç”Ÿåå–®ï¼Œè«‹ç¢ºèª Students è¡¨æ ¼è³‡æ–™ã€‚</p>';
                return;
            }

            let html = '';
            attendanceData.forEach((student, index) => {
                // é è¨­ç‹€æ…‹ (å¦‚æœæ˜¯è«‹å‡ leaveï¼Œå°±é¡¯ç¤ºè«‹å‡)
                let status = student.attendance || 'present';
                let bgClass = status === 'present' ? 'bg-green-50' : (status === 'leave' ? 'bg-blue-50' : 'bg-red-50');
                
                html += `
                <div class="flex items-center justify-between p-3 mb-2 rounded-lg border border-gray-200 ${bgClass}" id="student-row-${index}">
                    <div class="font-bold text-gray-700">
                        <span class="text-gray-400 mr-2 text-sm">${student.studentId}</span>${student.name}
                        ${status === 'leave' ? '<span class="ml-2 text-xs bg-blue-100 text-blue-600 px-2 py-0.5 rounded">å®¶é•·å·²è«‹å‡</span>' : ''}
                    </div>
                    <div class="flex gap-1">
                        <button onclick="setAttendance(${index}, 'present')" class="px-3 py-1 text-sm font-bold rounded ${status === 'present' ? 'bg-green-500 text-white shadow' : 'bg-white text-gray-500 border'}">å‡ºå¸­</button>
                        <button onclick="setAttendance(${index}, 'late')" class="px-3 py-1 text-sm font-bold rounded ${status === 'late' ? 'bg-yellow-500 text-white shadow' : 'bg-white text-gray-500 border'}">é²åˆ°</button>
                        <button onclick="setAttendance(${index}, 'absent')" class="px-3 py-1 text-sm font-bold rounded ${status === 'absent' ? 'bg-red-500 text-white shadow' : 'bg-white text-gray-500 border'}">ç¼ºå¸­</button>
                    </div>
                </div>`;
            });
            listDiv.innerHTML = html;
        }

        // é»æ“ŠæŒ‰éˆ•æ”¹è®Šç‹€æ…‹
        function setAttendance(index, status) {
            if (attendanceData[index].attendance === 'leave') {
                if(!confirm('è©²åå­¸ç”Ÿå®¶é•·å·²è«‹å‡ï¼Œç¢ºå®šè¦è¦†è“‹ç‚ºå…¶ä»–ç‹€æ…‹å—ï¼Ÿ')) return;
            }
            attendanceData[index].attendance = status;
            renderDisciplineList(); // é‡æ–°æ¸²æŸ“æ›´æ–°é¡è‰²
        }

        // å„²å­˜å‡ºç¼ºå¸­ç´€éŒ„
        async function saveDiscipline() {
            const date = document.getElementById('work-date').value;
            const btn = document.getElementById('btn-discipline-save');
            btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> å„²å­˜ä¸­...';
            btn.disabled = true;

            // å°‡è³‡æ–™æ•´ç†æˆå¾Œç«¯éœ€è¦çš„æ ¼å¼
            const recordsToSave = attendanceData.map(student => ({
                date: date,
                className: stuClass,
                subject: 'æ—¥å¸¸å‡ºç¼ºå¸­',
                studentId: student.studentId,
                name: student.name,
                attendance: student.attendance,
                comment: '' // å¹¹éƒ¨é»åæš«ä¸åŠ è©•èª
            }));

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    body: JSON.stringify({
                        action: 'batchSaveAttendance',
                        records: recordsToSave
                    })
                });
                const result = await response.json();
                
                if (result.success) {
                    alert('å‡ºç¼ºå¸­ç´€éŒ„å·²æˆåŠŸå„²å­˜ï¼');
                } else {
                    alert('å„²å­˜å¤±æ•—ï¼š' + result.message);
                }
            } catch (error) {
                alert('é€£ç·šç•°å¸¸ï¼Œå„²å­˜å¤±æ•—ã€‚');
            } finally {
                btn.innerHTML = '<i class="fas fa-save mr-2"></i> å„²å­˜å‡ºç¼ºå¸­ç´€éŒ„';
                btn.disabled = false;
            }
        }
    </script>
</body>
</html>
