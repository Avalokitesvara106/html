<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¹¹éƒ¨å°ˆå€ - ç­ç´šç®¡ç†ç³»çµ±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body class="bg-gray-50 font-sans pb-12">

    <header class="bg-gradient-to-r from-blue-600 to-indigo-700 text-white shadow-md rounded-b-3xl pb-6">
        <div class="p-4 flex justify-between items-center">
            <h1 class="text-lg font-bold"><i class="fas fa-shield-alt mr-2"></i>å¹¹éƒ¨ç®¡ç†å°ˆå€</h1>
            <button onclick="logout()" class="text-blue-100 hover:text-white text-sm bg-white/20 px-3 py-1 rounded-full backdrop-blur-sm transition">
                <i class="fas fa-sign-out-alt"></i> ç™»å‡º
            </button>
        </div>
        <div class="px-6 flex items-center mt-2">
            <div class="w-16 h-16 bg-white rounded-full flex items-center justify-center text-indigo-600 text-3xl font-bold border-4 border-indigo-300 shadow-sm">
                <i class="fas fa-user-shield"></i>
            </div>
            <div class="ml-4 flex-1">
                <p class="text-blue-100 text-sm mb-1"><span id="display-class" class="font-bold"></span> ç­ç´šå¹¹éƒ¨</p>
                <div class="flex items-center">
                    <h2 class="text-2xl font-bold mr-2" id="display-name">è¼‰å…¥ä¸­...</h2>
                    <span id="display-title" class="bg-yellow-400 text-yellow-900 text-xs font-extrabold px-2 py-1 rounded-md shadow-sm">è·ç¨±</span>
                </div>
            </div>
        </div>
    </header>

    <main class="max-w-md mx-auto mt-6 px-4">
        
        <div class="bg-white rounded-xl shadow-sm p-4 mb-6 flex justify-between items-center border border-gray-100">
            <h3 class="font-bold text-gray-700"><i class="far fa-calendar-alt text-blue-500 mr-2"></i>ä½œæ¥­æ—¥æœŸ</h3>
            <input type="date" id="work-date" class="bg-gray-50 border border-gray-300 text-gray-800 text-sm rounded-lg p-2 focus:ring-2 focus:ring-blue-500 outline-none font-bold">
        </div>

        <div class="flex flex-wrap gap-2 mb-6" id="module-tabs">
            <button onclick="switchTab('common')" id="tab-common" class="flex-1 min-w-[45%] py-2.5 bg-blue-600 text-white rounded-xl shadow-md font-bold text-sm transition-all transform scale-105">
                <i class="fas fa-clipboard-check mr-1"></i> ç‰©å“ç¹³äº¤
            </button>
            <button onclick="switchTab('academic')" id="tab-academic" class="hidden flex-1 min-w-[45%] py-2.5 bg-white text-gray-500 hover:bg-gray-50 rounded-xl border border-gray-200 font-bold text-sm transition-all">
                <i class="fas fa-book-open mr-1"></i> è¯çµ¡ç°¿
            </button>
            <button onclick="switchTab('hygiene')" id="tab-hygiene" class="hidden flex-1 min-w-[45%] py-2.5 bg-white text-gray-500 hover:bg-gray-50 rounded-xl border border-gray-200 font-bold text-sm transition-all">
                <i class="fas fa-broom mr-1"></i> æ‰“æƒæ ¸å¯¦
            </button>
            <button onclick="switchTab('it')" id="tab-it" class="hidden flex-1 min-w-[45%] py-2.5 bg-white text-gray-500 hover:bg-gray-50 rounded-xl border border-gray-200 font-bold text-sm transition-all">
                <i class="fas fa-mobile-alt mr-1"></i> æ‰‹æ©Ÿç¹³äº¤
            </button>
            <button onclick="switchTab('discipline')" id="tab-discipline" class="hidden flex-1 min-w-[45%] py-2.5 bg-white text-gray-500 hover:bg-gray-50 rounded-xl border border-gray-200 font-bold text-sm transition-all">
                <i class="fas fa-user-check mr-1"></i> å‡ºå¸­ç‹€æ³
            </button>
        </div>

        <section id="section-common" class="block">
            <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-5">
                <h3 class="font-bold text-gray-800 mb-3 border-b border-gray-100 pb-2"><i class="fas fa-clipboard-check mr-2"></i>å„é …ç‰©å“/å›æ¢ç¹³äº¤</h3>
                <div class="flex gap-2 mb-4">
                    <input type="text" id="common-item-name" placeholder="è¼¸å…¥ç‰©å“åç¨± (å¦‚: æˆ¶å¤–æ•™å­¸å›æ¢)" class="flex-1 bg-gray-50 border border-gray-300 rounded-lg p-2 text-sm outline-none focus:ring-2 focus:ring-blue-400">
                    <button id="btn-common-load" onclick="loadSubData('common')" class="bg-blue-100 text-blue-700 font-bold px-3 py-2 rounded-lg hover:bg-blue-200 text-sm whitespace-nowrap">è¼‰å…¥</button>
                </div>
                <div id="common-list" class="mb-4 max-h-[50vh] overflow-y-auto"><p class="text-center text-gray-400 text-sm py-4">è«‹è¼¸å…¥åç¨±ä¸¦è¼‰å…¥åå–®</p></div>
                <button id="btn-common-save" onclick="saveSubData('common')" class="hidden w-full bg-blue-600 text-white font-bold py-3 rounded-lg shadow-sm hover:bg-blue-700 transition"><i class="fas fa-save mr-2"></i> å„²å­˜ç¹³äº¤é€²åº¦</button>
            </div>
        </section>

        <section id="section-academic" class="hidden">
            <div class="bg-white rounded-xl shadow-sm border border-orange-100 p-5">
                <h3 class="font-bold text-orange-600 mb-4 border-b border-orange-100 pb-2"><i class="fas fa-pen-nib mr-2"></i>ç™¼å¸ƒç­ç´šè¯çµ¡ç°¿</h3>
                <textarea id="academic-content" rows="6" class="w-full bg-gray-50 border border-gray-200 rounded-lg p-3 text-sm focus:ring-2 focus:ring-orange-400 outline-none mb-4" placeholder="è«‹è¼¸å…¥ä»Šæ—¥ä½œæ¥­ã€æ˜æ—¥è€ƒè©¦èˆ‡æ”œå¸¶ç‰©å“..."></textarea>
                <button id="btn-academic-submit" onclick="submitAcademic()" class="w-full bg-orange-500 text-white font-bold py-3 rounded-lg shadow-sm hover:bg-orange-600 transition"><i class="fas fa-paper-plane mr-2"></i> ç™¼å¸ƒè‡³ç­ç´šçœ‹æ¿</button>
            </div>
        </section>

        <section id="section-hygiene" class="hidden">
            <div class="bg-white rounded-xl shadow-sm border border-teal-100 p-5">
                <div class="flex justify-between items-center mb-4 border-b border-teal-100 pb-2">
                    <h3 class="font-bold text-teal-600"><i class="fas fa-broom mr-2"></i>æ‰“æƒå·¥ä½œæ ¸å¯¦</h3>
                    <button id="btn-hygiene-load" onclick="loadSubData('hygiene')" class="bg-teal-50 text-teal-600 font-bold py-1.5 px-3 rounded-lg border border-teal-200 hover:bg-teal-100 text-sm">è¼‰å…¥åå–®</button>
                </div>
                <div id="hygiene-list" class="mb-4 max-h-[50vh] overflow-y-auto"><p class="text-center text-gray-400 text-sm py-4">è«‹è¼‰å…¥ç­ç´šåå–®</p></div>
                <button id="btn-hygiene-save" onclick="saveSubData('hygiene')" class="hidden w-full bg-teal-600 text-white font-bold py-3 rounded-lg shadow-sm hover:bg-teal-700 transition"><i class="fas fa-save mr-2"></i> å„²å­˜æ‰“æƒç´€éŒ„</button>
            </div>
        </section>

        <section id="section-it" class="hidden">
            <div class="bg-white rounded-xl shadow-sm border border-purple-100 p-5">
                <div class="flex justify-between items-center mb-4 border-b border-purple-100 pb-2">
                    <h3 class="font-bold text-purple-600"><i class="fas fa-mobile-alt mr-2"></i>æ‰‹æ©Ÿç¹³äº¤ç‹€æ³</h3>
                    <button id="btn-it-load" onclick="loadSubData('it')" class="bg-purple-50 text-purple-600 font-bold py-1.5 px-3 rounded-lg border border-purple-200 hover:bg-purple-100 text-sm">è¼‰å…¥åå–®</button>
                </div>
                <div id="it-list" class="mb-4 max-h-[50vh] overflow-y-auto"><p class="text-center text-gray-400 text-sm py-4">è«‹è¼‰å…¥ç­ç´šåå–®</p></div>
                <button id="btn-it-save" onclick="saveSubData('it')" class="hidden w-full bg-purple-600 text-white font-bold py-3 rounded-lg shadow-sm hover:bg-purple-700 transition"><i class="fas fa-save mr-2"></i> å„²å­˜æ‰‹æ©Ÿç¹³äº¤</button>
            </div>
        </section>

        <section id="section-discipline" class="hidden">
            <div class="bg-white rounded-xl shadow-sm border border-red-100 p-5">
                <div class="flex justify-between items-center mb-4 border-b border-red-100 pb-2">
                    <h3 class="font-bold text-red-600"><i class="fas fa-user-clock mr-2"></i>æ—¥å¸¸å‡ºç¼ºå¸­é»å</h3>
                    <button id="btn-discipline-load" onclick="loadDiscipline()" class="bg-red-50 text-red-600 font-bold py-1.5 px-3 rounded-lg border border-red-200 hover:bg-red-100 text-sm"><i class="fas fa-sync-alt mr-1"></i> è¼‰å…¥åå–®</button>
                </div>
                <div id="discipline-list" class="mb-4 max-h-[60vh] overflow-y-auto"><p class="text-center text-gray-400 text-sm py-4">è«‹è¼‰å…¥ç­ç´šåå–®</p></div>
                <button id="btn-discipline-save" onclick="saveDiscipline()" class="hidden w-full bg-red-600 text-white font-bold py-3 rounded-lg shadow-sm hover:bg-red-700 transition"><i class="fas fa-save mr-2"></i> å„²å­˜å‡ºç¼ºå¸­ç´€éŒ„</button>
            </div>
        </section>

    </main>

    <script>
        // ğŸš¨ æ›¿æ›ç‚ºæ‚¨çš„ GAS ç¶²å€
        const API_URL = "https://script.google.com/macros/s/AKfycbwunBwJT2u3gpAcnibQW4RBOQhuzQXLtcirT4_6G6fG9FgwJjTAApax5fU0VZ1dNvdRog/exec";
        
        const isLoggedIn = sessionStorage.getItem('isLoggedIn');
        const userRole = sessionStorage.getItem('userRole');
        const stuName = sessionStorage.getItem('studentName');
        const stuClass = sessionStorage.getItem('studentClass');
        const cadreTitle = sessionStorage.getItem('cadreTitle') || ''; 

        if (!isLoggedIn || userRole !== 'cadre') {
            alert('è«‹å…ˆä»¥å¹¹éƒ¨èº«åˆ†ç™»å…¥ï¼'); window.location.href = 'login.html';
        }

        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('display-name').innerText = stuName || 'å¹¹éƒ¨';
            document.getElementById('display-class').innerText = stuClass || '';
            document.getElementById('display-title').innerText = cadreTitle || 'ä¸€èˆ¬å¹¹éƒ¨';

            const dateInput = document.getElementById('work-date');
            const today = new Date();
            dateInput.value = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;

            let defaultTab = 'common';
            if (cadreTitle.includes('å­¸è—')) { document.getElementById('tab-academic').classList.remove('hidden'); defaultTab = 'academic'; }
            if (cadreTitle.includes('è¡›ç”Ÿ')) { document.getElementById('tab-hygiene').classList.remove('hidden'); defaultTab = 'hygiene'; }
            if (cadreTitle.includes('è³‡è¨Š')) { document.getElementById('tab-it').classList.remove('hidden'); defaultTab = 'it'; }
            if (cadreTitle.includes('é¢¨ç´€')) { document.getElementById('tab-discipline').classList.remove('hidden'); defaultTab = 'discipline'; }
            switchTab(defaultTab);
        });

        function switchTab(target) {
            const sections = ['common', 'academic', 'hygiene', 'it', 'discipline'];
            sections.forEach(sec => {
                const sectionEl = document.getElementById(`section-${sec}`);
                const tabEl = document.getElementById(`tab-${sec}`);
                if (!tabEl || tabEl.classList.contains('hidden')) return;

                if (sec === target) {
                    sectionEl.classList.remove('hidden'); sectionEl.classList.add('block');
                    tabEl.className = `flex-1 min-w-[45%] py-2.5 bg-blue-600 text-white rounded-xl shadow-md font-bold text-sm transition-all transform scale-105`;
                } else {
                    sectionEl.classList.remove('block'); sectionEl.classList.add('hidden');
                    tabEl.className = `flex-1 min-w-[45%] py-2.5 bg-white text-gray-500 hover:bg-gray-50 rounded-xl border border-gray-200 font-bold text-sm transition-all`;
                }
            });
        }
        function logout() { sessionStorage.clear(); window.location.href = 'login.html'; }

        // ==========================================
        // æ¨¡çµ„ä¸€ï¼šå­¸è— (è¯çµ¡ç°¿)
        // ==========================================
        async function submitAcademic() {
            const content = document.getElementById('academic-content').value.trim();
            if (!content) return alert('è«‹å…ˆè¼¸å…¥è¯çµ¡ç°¿å…§å®¹ï¼');
            const date = document.getElementById('work-date').value;
            const btn = document.getElementById('btn-academic-submit');
            btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> ç™¼å¸ƒä¸­...'; btn.disabled = true;

            try {
                const response = await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'saveAnnouncement', date: date, className: stuClass, content: content, teacherName: `${cadreTitle} ${stuName}` }) });
                const result = await response.json();
                if (result.success) { alert('è¯çµ¡ç°¿ç™¼å¸ƒæˆåŠŸï¼'); document.getElementById('academic-content').value = ''; } 
                else alert('ç™¼å¸ƒå¤±æ•—ï¼š' + result.message);
            } catch (error) { alert('é€£ç·šç•°å¸¸ã€‚'); } 
            finally { btn.innerHTML = '<i class="fas fa-paper-plane mr-2"></i> ç™¼å¸ƒè‡³ç­ç´šçœ‹æ¿'; btn.disabled = false; }
        }

        // ==========================================
        // æ¨¡çµ„äºŒï¼šé¢¨ç´€ (é»å)
        // ==========================================
        let attendanceData = [];
        async function loadDiscipline() {
            const date = document.getElementById('work-date').value, btn = document.getElementById('btn-discipline-load'), listDiv = document.getElementById('discipline-list');
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>'; btn.disabled = true;
            listDiv.innerHTML = '<p class="text-center text-blue-500 py-4"><i class="fas fa-circle-notch fa-spin mr-2"></i>è¼‰å…¥ä¸­...</p>';
            try {
                const response = await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'loadAttendance', date: date, className: stuClass, subject: 'æ—¥å¸¸å‡ºç¼ºå¸­' }) });
                const result = await response.json();
                if (result.success) { attendanceData = result.data; renderDisciplineList(); document.getElementById('btn-discipline-save').classList.remove('hidden'); } 
                else listDiv.innerHTML = `<p class="text-center text-red-500 font-bold py-4">è¼‰å…¥å¤±æ•—ï¼š${result.message}</p>`;
            } catch (error) { listDiv.innerHTML = '<p class="text-center text-red-500 py-4">ç¶²è·¯é€£ç·šç•°å¸¸</p>'; } 
            finally { btn.innerHTML = '<i class="fas fa-sync-alt mr-1"></i> è¼‰å…¥åå–®'; btn.disabled = false; }
        }

        function renderDisciplineList() {
            let html = '';
            attendanceData.forEach((st, idx) => {
                let s = st.attendance || 'present';
                let bg = s === 'present' ? 'bg-green-50' : (s === 'leave' ? 'bg-blue-50' : 'bg-red-50');
                html += `
                <div class="flex items-center justify-between p-3 mb-2 rounded-lg border border-gray-200 ${bg}">
                    <div class="font-bold text-gray-700"><span class="text-gray-400 mr-2 text-sm">${st.studentId}</span>${st.name}</div>
                    <div class="flex gap-1">
                        <button onclick="setAttendance(${idx}, 'present')" class="px-2 py-1 text-xs font-bold rounded ${s === 'present' ? 'bg-green-500 text-white' : 'bg-white text-gray-500 border'}">å‡ºå¸­</button>
                        <button onclick="setAttendance(${idx}, 'late')" class="px-2 py-1 text-xs font-bold rounded ${s === 'late' ? 'bg-yellow-500 text-white' : 'bg-white text-gray-500 border'}">é²åˆ°</button>
                        <button onclick="setAttendance(${idx}, 'absent')" class="px-2 py-1 text-xs font-bold rounded ${s === 'absent' ? 'bg-red-500 text-white' : 'bg-white text-gray-500 border'}">ç¼ºå¸­</button>
                    </div>
                </div>`;
            });
            document.getElementById('discipline-list').innerHTML = html;
        }

        function setAttendance(idx, s) { attendanceData[idx].attendance = s; renderDisciplineList(); }
        async function saveDiscipline() {
            const date = document.getElementById('work-date').value, btn = document.getElementById('btn-discipline-save');
            btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> å„²å­˜ä¸­...'; btn.disabled = true;
            const recordsToSave = attendanceData.map(st => ({ date: date, className: stuClass, subject: 'æ—¥å¸¸å‡ºç¼ºå¸­', studentId: st.studentId, name: st.name, attendance: st.attendance, comment: '' }));
            try {
                const response = await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'batchSaveAttendance', records: recordsToSave }) });
                const result = await response.json();
                if (result.success) alert('å‡ºç¼ºå¸­ç´€éŒ„å·²æˆåŠŸå„²å­˜ï¼'); else alert('å„²å­˜å¤±æ•—ï¼š' + result.message);
            } catch (error) { alert('é€£ç·šç•°å¸¸ã€‚'); } finally { btn.innerHTML = '<i class="fas fa-save mr-2"></i> å„²å­˜å‡ºç¼ºå¸­ç´€éŒ„'; btn.disabled = false; }
        }

        // ==========================================
        // ğŸŸ¢ æ¨¡çµ„ä¸‰ï¼šç‰©å“ã€æ‰‹æ©Ÿã€æ‰“æƒ (é€šç”¨å‹ Submissions)
        // ==========================================
        // å„²å­˜ä¸‰å€‹æ¨¡çµ„å„è‡ªçš„é™£åˆ—è³‡æ–™èˆ‡ç‰©å“åç¨±
        let subData = { common: { data: [], itemName: '' }, hygiene: { data: [], itemName: 'æ‰“æƒå·¥ä½œ' }, it: { data: [], itemName: 'æ‰‹æ©Ÿç¹³äº¤' } };

        async function loadSubData(mode) {
            let itemName = subData[mode].itemName;
            if (mode === 'common') {
                itemName = document.getElementById('common-item-name').value.trim();
                if (!itemName) return alert('è«‹è¼¸å…¥è¦ç™»è¨˜çš„ç‰©å“åç¨±ï¼');
                subData.common.itemName = itemName;
            }

            const date = document.getElementById('work-date').value;
            const btn = document.getElementById(`btn-${mode}-load`);
            const listDiv = document.getElementById(`${mode}-list`);
            
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>'; btn.disabled = true;
            listDiv.innerHTML = '<p class="text-center text-blue-500 py-4"><i class="fas fa-circle-notch fa-spin mr-2"></i>è¼‰å…¥ä¸­...</p>';

            try {
                const response = await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'loadSubmissions', date: date, className: stuClass, itemName: itemName }) });
                const result = await response.json();
                if (result.success) {
                    subData[mode].data = result.data;
                    renderSubList(mode);
                    document.getElementById(`btn-${mode}-save`).classList.remove('hidden');
                } else listDiv.innerHTML = `<p class="text-center text-red-500 py-4">è¼‰å…¥å¤±æ•—ï¼š${result.message}</p>`;
            } catch (error) { listDiv.innerHTML = '<p class="text-center text-red-500 py-4">ç¶²è·¯é€£ç·šç•°å¸¸</p>'; } 
            finally { btn.innerHTML = 'è¼‰å…¥åå–®'; btn.disabled = false; }
        }

if (submissions.length > 0) {
    let html = `<h4 class="text-sm font-bold text-indigo-500 mb-2 border-b pb-1 mt-4"><i class="fas fa-clipboard-list mr-2"></i>è¡Œæ”¿ç¹³äº¤è¿½è¹¤</h4>`;
    submissions.forEach(rec => {
        // ğŸŸ¢ ä¾æ“šç‹€æ…‹çµ¦äºˆä¸åŒé¡è‰²èˆ‡æ–‡å­— (åŠ å…¥ none æœªæ”œå¸¶çš„åˆ¤æ–·)
        let sColor = 'bg-red-100 text-red-700'; // é è¨­ç¼ºäº¤
        let sText = 'ç¼ºäº¤';
        
        if (rec.status === 'done') {
            sColor = 'bg-green-100 text-green-700';
            sText = rec.itemName.includes('æ‰“æƒ') ? 'å·²å®Œæˆ' : 'å·²äº¤';
        } else if (rec.status === 'pending') {
            sColor = 'bg-yellow-100 text-yellow-700';
            sText = rec.itemName.includes('æ‰“æƒ') ? 'å¾…åŠ å¼·' : 'æœªäº¤';
        } else if (rec.status === 'none') {
            sColor = 'bg-gray-100 text-gray-600';
            sText = 'æœªæ”œå¸¶';
        } else if (rec.status === 'missing') {
            sColor = 'bg-red-100 text-red-700';
            sText = rec.itemName.includes('æ‰“æƒ') ? 'æœªæ‰“æƒ' : 'ç¼ºäº¤';
        }

        html += `<div class="bg-white rounded-xl shadow-sm border border-gray-100 p-4 mb-3 flex justify-between items-center border-l-4 border-indigo-400">
                    <h4 class="font-bold text-gray-800">${rec.itemName}</h4>
                    <span class="${sColor} text-xs font-bold px-2 py-1 rounded-full">${sText}</span>
                 </div>`;
    }); 
    document.getElementById('submission-section').innerHTML = html;
}

        function setSubStatus(mode, idx, s) { subData[mode].data[idx].status = s; renderSubList(mode); }

        async function saveSubData(mode) {
            const date = document.getElementById('work-date').value;
            const itemName = subData[mode].itemName;
            const btn = document.getElementById(`btn-${mode}-save`);
            btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> å„²å­˜ä¸­...'; btn.disabled = true;

            const recordsToSave = subData[mode].data.map(st => ({
                date: date, className: stuClass, itemName: itemName, studentId: st.studentId, name: st.name, status: st.status
            }));

            try {
                const response = await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'batchSaveSubmissions', records: recordsToSave }) });
                const result = await response.json();
                if (result.success) alert(`${itemName} ç´€éŒ„å·²æˆåŠŸå„²å­˜ï¼`); else alert('å„²å­˜å¤±æ•—ï¼š' + result.message);
            } catch (error) { alert('é€£ç·šç•°å¸¸ï¼Œå„²å­˜å¤±æ•—ã€‚'); } 
            finally { btn.innerHTML = '<i class="fas fa-save mr-2"></i> å„²å­˜ç´€éŒ„'; btn.disabled = false; }
        }
    </script>
</body>
</html>


